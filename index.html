// ==========================================
        //  投資カレンダー (修正：グラフ追加・Markdownプレビュー即時表示)
        // ==========================================
        const ProfitManager = () => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [historyData, setHistoryData] = useState({});
            const [selectedDate, setSelectedDate] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [editData, setEditData] = useState({ event: '', stocks: 0, margin: 0, foreign: 0, cfd: 0, note: '' });
            // modalTab stateは削除 (スプリットビューにするため)
            
            // CSV Import State
            const [importCategory, setImportCategory] = useState('stocks');
            const [dragActive, setDragActive] = useState(false);
            
            const formatMoney = (val) => val ? val.toLocaleString() : '0';
            const getMonthKey = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            const getDateKey = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            
            useEffect(() => {
                const saved = localStorage.getItem('history_data');
                if (saved) {
                    try { setHistoryData(JSON.parse(saved)); } catch (e) { console.error("Load failed", e); }
                }
            }, []);

            const saveToStorage = (newData) => {
                setHistoryData(newData);
                localStorage.setItem('history_data', JSON.stringify(newData));
            };

            const stats = useMemo(() => {
                let lifetime = 0;
                let prevYear = 0;
                let monthTotal = 0;
                const currentMonthKey = getMonthKey(currentDate);
                const prevYearKey = (currentDate.getFullYear() - 1).toString();

                Object.entries(historyData).forEach(([key, val]) => {
                    if (key.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const dayTotal = (val.stocks || 0) + (val.margin || 0) + (val.foreign || 0) + (val.cfd || 0);
                        lifetime += dayTotal;
                        if (key.startsWith(currentMonthKey)) monthTotal += dayTotal;
                        if (key.startsWith(prevYearKey)) prevYear += dayTotal;
                    }
                    else if (key === prevYearKey && val.total) prevYear += val.total;
                    else if (val.total) lifetime += val.total;
                });
                return { lifetime, prevYear, monthTotal };
            }, [historyData, currentDate]);

            // --- グラフ用データの作成 (JPXスタイル) ---
            const dailyChartData = useMemo(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const data = [];

                for (let d = 1; d <= daysInMonth; d++) {
                    const dateObj = new Date(year, month, d);
                    const key = getDateKey(dateObj);
                    const dData = historyData[key];
                    const total = dData ? ((dData.stocks||0) + (dData.margin||0) + (dData.foreign||0) + (dData.cfd||0)) : 0;
                    
                    data.push({
                        day: d, // X軸表示用
                        date: key, // ツールチップ用
                        total: total
                    });
                }
                return data;
            }, [historyData, currentDate]);

            const calendarWeeks = useMemo(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const weeks = [];
                let currentWeek = [];
                for (let i = 0; i < firstDay.getDay(); i++) currentWeek.push(null);
                for (let d = 1; d <= lastDay.getDate(); d++) {
                    const date = new Date(year, month, d);
                    currentWeek.push(date);
                    if (date.getDay() === 6) { weeks.push(currentWeek); currentWeek = []; }
                }
                if (currentWeek.length > 0) {
                    while (currentWeek.length < 7) currentWeek.push(null);
                    weeks.push(currentWeek);
                }
                return weeks;
            }, [currentDate]);

            // --- CSV Import Logic ---
            const handleFileImport = (file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const csvData = event.target.result;
                    Papa.parse(csvData, {
                        header: false,
                        skipEmptyLines: true,
                        complete: (results) => {
                            processCSVData(results.data);
                        }
                    });
                };
                reader.readAsText(file, 'Shift_JIS');
            };

            const processCSVData = (rows) => {
                if (!rows || rows.length === 0) return;

                let headerRowIndex = -1;
                let dateColIndex = -1;
                let plColIndex = -1;

                for (let i = 0; i < Math.min(rows.length, 20); i++) {
                    const row = rows[i].map(c => String(c).trim());
                    const dIdx = row.findIndex(c => c.includes('約定日'));
                    const pIdx = row.findIndex(c => (c.includes('実現損益') || c.includes('損益金額')) && (c.includes('円') || c.includes('金額')));
                    
                    if (dIdx !== -1 && pIdx !== -1) {
                        headerRowIndex = i;
                        dateColIndex = dIdx;
                        plColIndex = pIdx;
                        break;
                    }
                }

                if (headerRowIndex === -1) {
                    alert("有効なデータが見つかりませんでした。「約定日」と「実現損益(円)」が含まれるCSVか確認してください。");
                    return;
                }

                const aggregatedData = {};

                for (let i = headerRowIndex + 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row[dateColIndex]) continue;
                    const dateStr = String(row[dateColIndex]).trim().replace(/\//g, '-');
                    const parts = dateStr.split('-');
                    if (parts.length !== 3) continue;
                    const dateKey = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                    let valStr = String(row[plColIndex]).replace(/,/g, '').trim();
                    const val = parseInt(valStr, 10);
                    if (!isNaN(val)) {
                        aggregatedData[dateKey] = (aggregatedData[dateKey] || 0) + val;
                    }
                }

                const newHistory = { ...historyData };
                let count = 0;
                Object.entries(aggregatedData).forEach(([key, val]) => {
                    if (!newHistory[key]) {
                        newHistory[key] = { event: '', stocks: 0, margin: 0, foreign: 0, cfd: 0, note: '' };
                    }
                    newHistory[key] = {
                        ...newHistory[key],
                        [importCategory]: val 
                    };
                    count++;
                });

                saveToStorage(newHistory);
                setIsImportModalOpen(false);
                alert(`${count}件の日付データをインポートしました。`);
            };

            const handleDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setDragActive(true);
                } else if (e.type === "dragleave") {
                    setDragActive(false);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleFileImport(e.dataTransfer.files[0]);
                }
            };

            const openModal = (date) => {
                if (!date) return;
                const key = getDateKey(date);
                const data = historyData[key] || { event: '', stocks: 0, margin: 0, foreign: 0, cfd: 0, note: '' };
                if (!data.note) {
                    data.note = `# ${key.replace(/-/g, '/')}`;
                }
                setSelectedDate(date);
                setEditData({ ...data });
                setIsModalOpen(true);
            };

            const handleSave = () => {
                if (!selectedDate) return;
                const key = getDateKey(selectedDate);
                const newData = { ...historyData, [key]: editData };
                saveToStorage(newData);
                setIsModalOpen(false);
            };

            const handleDeleteEvent = (e, date) => {
                e.stopPropagation();
                if (!window.confirm("イベントを削除しますか？")) return;
                const key = getDateKey(date);
                const current = historyData[key];
                if (current) {
                    const newData = { ...historyData, [key]: { ...current, event: '' } };
                    saveToStorage(newData);
                }
            };

            const handleExportMD = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                let md = `# 投資日記レポート：${year}年${month}月度\n`;
                md += `（月間の総合計収支：${stats.monthTotal > 0 ? '+' : ''}${stats.monthTotal.toLocaleString()}円）\n\n`;
                const sortedKeys = Object.keys(historyData).filter(k => k.startsWith(getMonthKey(currentDate))).sort();
                sortedKeys.forEach(key => {
                    const d = historyData[key];
                    const total = (d.stocks||0) + (d.margin||0) + (d.foreign||0) + (d.cfd||0);
                    if (total === 0 && !d.note && !d.event) return;
                    md += `## ${key} ${d.event ? `(${d.event})` : ''}\n### 収支データ\n- 現物: ${d.stocks||0} / 信用: ${d.margin||0} / 海外: ${d.foreign||0} / CFD: ${d.cfd||0}\n### 振り返り\n${d.note || '（記載なし）'}\n\n`;
                });
                const blob = new Blob([md], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `investment_diary_${year}_${month}.md`;
                a.click();
            };

            const handleExportCSV = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                const sortedKeys = Object.keys(historyData).filter(k => k.startsWith(getMonthKey(currentDate))).sort();
                let csv = '\uFEFFDate,Event,Stocks,Margin,Foreign,CFD,Total,Note\n';
                sortedKeys.forEach(key => {
                    const d = historyData[key];
                    const total = (d.stocks||0) + (d.margin||0) + (d.foreign||0) + (d.cfd||0);
                    const escapedNote = d.note ? `"${d.note.replace(/"/g, '""')}"` : "";
                    const escapedEvent = d.event ? `"${d.event.replace(/"/g, '""')}"` : "";
                    csv += `${key},${escapedEvent},${d.stocks||0},${d.margin||0},${d.foreign||0},${d.cfd||0},${total},${escapedNote}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `investment_data_${year}_${month}.csv`;
                a.click();
            };

            const DayCell = ({ date }) => {
                if (!date) return <div className="cal-cell bg-slate-50"></div>;
                const key = getDateKey(date);
                const data = historyData[key];
                const hasNote = data && data.note && data.note.trim().length > 0;
                const hasEvent = data && data.event && data.event.trim().length > 0;
                const isToday = getDateKey(new Date()) === key;
                const StatCard = ({ type, val }) => (
                    <div className={`flex justify-between items-center px-1.5 py-0.5 rounded text-[10px] font-medium mb-0.5 ${CATEGORY_STYLES[type].bg} ${CATEGORY_STYLES[type].text}`}>
                        <span>{CATEGORY_STYLES[type].label.charAt(0)}</span>
                        <span className={val < 0 ? 'text-[#FF4081]' : ''}>{formatMoney(val)}</span>
                    </div>
                );
                return (
                    <div onClick={() => openModal(date)} className={`cal-cell cursor-pointer hover:bg-[#F3E5F5] transition-colors border-r border-b border-slate-100 ${isToday ? 'bg-[#F3E5F5]/30 ring-2 ring-inset ring-[#7C4DFF]/20' : ''}`}>
                        <div className="flex justify-between items-start mb-1">
                            <span className={`text-xs font-bold ${isToday ? 'bg-[#7C4DFF] text-white px-1.5 py-0.5 rounded-full' : 'text-slate-500'}`}>{date.getDate()}</span>
                            {hasNote && <Icon name="FileText" size={12} className="text-[#64748B]" />}
                        </div>
                        <div className="flex flex-col gap-0.5">
                            {hasEvent ? (
                                <div className="group relative flex justify-between items-center px-1.5 py-1 rounded text-[10px] font-bold mb-1 bg-white border-l-4 border-[#7C4DFF] shadow-sm text-[#7C4DFF]">
                                    <span className="truncate">{data.event}</span>
                                    <div className="absolute right-1 top-1/2 -translate-y-1/2 hidden group-hover:flex gap-1 bg-white pl-1">
                                        <button onClick={(e) => { e.stopPropagation(); openModal(date); }} className="hover:text-[#7C4DFF]"><Icon name="Pencil" size={10} /></button>
                                        <button onClick={(e) => handleDeleteEvent(e, date)} className="hover:text-[#FF4081]"><Icon name="X" size={10} /></button>
                                    </div>
                                </div>
                            ) : ( <div className="h-[22px] mb-1"></div> )}
                            {data ? (
                                <>
                                    <StatCard type="stocks" val={data.stocks || 0} />
                                    <StatCard type="margin" val={data.margin || 0} />
                                    <StatCard type="foreign" val={data.foreign || 0} />
                                    <StatCard type="cfd" val={data.cfd || 0} />
                                </>
                            ) : (
                                <>
                                    <div className="h-[18px]"></div><div className="h-[18px]"></div><div className="h-[18px]"></div><div className="h-[18px]"></div>
                                </>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="space-y-6 mb-12">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 animate-fade-in-up">
                        <div className="lifetime-bg rounded-xl p-6 text-white shadow-lg relative overflow-hidden group">
                            <div className="relative z-10">
                                <p className="text-white/80 text-sm font-medium mb-1">生涯収益 (Lifetime Profit)</p>
                                <h3 className="text-3xl font-bold tracking-tight">¥ {stats.lifetime.toLocaleString()}</h3>
                                <p className="text-xs text-white/60 mt-2">全期間累計</p>
                            </div>
                            <div className="absolute right-0 bottom-0 opacity-10 transform translate-x-4 translate-y-4 group-hover:scale-110 transition-transform"><Icon name="LineChart" size={100} /></div>
                        </div>
                        <div className="bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
                            <p className="text-[#64748B] text-sm font-medium mb-1">前年収支 (2025)</p>
                            <h3 className={`text-3xl font-bold ${stats.prevYear >= 0 ? 'text-[#536DFE]' : 'text-[#FF4081]'}`}>{stats.prevYear >= 0 ? '+' : ''}{stats.prevYear.toLocaleString()}</h3>
                            <p className="text-xs text-slate-400 mt-2">年間確定損益</p>
                        </div>
                        <div className="bg-white rounded-xl p-6 border border-slate-200 shadow-sm flex flex-col justify-between">
                            <div>
                                <p className="text-[#64748B] text-sm font-medium mb-1">今月収支 ({currentDate.getMonth() + 1}月)</p>
                                <h3 className={`text-3xl font-bold ${stats.monthTotal >= 0 ? 'text-[#536DFE]' : 'text-[#FF4081]'}`}>{stats.monthTotal >= 0 ? '+' : ''}{stats.monthTotal.toLocaleString()}</h3>
                            </div>
                            <p className="text-xs text-slate-400 mt-2">リアルタイム集計</p>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden animate-fade-in-up">
                        <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                            <div className="flex items-center gap-4">
                                <h2 className="text-xl font-bold text-[#334155] flex items-center gap-2"><Icon name="Calendar" size={20} />{currentDate.getFullYear()}年 {currentDate.getMonth() + 1}月</h2>
                                <div className="flex gap-1">
                                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-1 hover:bg-white hover:shadow rounded text-slate-500"><Icon name="ChevronLeft" size={20} /></button>
                                    <button onClick={() => setCurrentDate(new Date())} className="px-2 py-1 text-xs font-bold text-slate-600 hover:bg-white hover:shadow rounded">Today</button>
                                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-1 hover:bg-white hover:shadow rounded text-slate-500"><Icon name="ChevronRight" size={20} /></button>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setIsImportModalOpen(true)} className="text-xs flex items-center gap-1 text-slate-600 hover:text-[#7C4DFF] border border-slate-300 rounded px-3 py-1.5 bg-white hover:bg-slate-50 transition-colors shadow-sm font-medium"><Icon name="FileUp" size={14} /> CSV読込</button>
                                <button onClick={handleExportMD} className="text-xs flex items-center gap-1 text-slate-600 hover:text-[#7C4DFF] border border-slate-300 rounded px-3 py-1.5 bg-white hover:bg-slate-50 transition-colors shadow-sm font-medium"><Icon name="Download" size={14} /> MD出力</button>
                                <button onClick={handleExportCSV} className="text-xs flex items-center gap-1 text-slate-600 hover:text-green-600 border border-slate-300 rounded px-3 py-1.5 bg-white hover:bg-slate-50 transition-colors shadow-sm font-medium"><Icon name="FileCsv" size={14} /> CSV出力</button>
                            </div>
                        </div>
                        
                        <div className="cal-grid">
                            <div className="cal-header">Category</div>
                            <div className="cal-header">Mon</div>
                            <div className="cal-header">Tue</div>
                            <div className="cal-header">Wed</div>
                            <div className="cal-header">Thu</div>
                            <div className="cal-header">Fri</div>
                            <div className="cal-header">週計</div>

                            {calendarWeeks.map((week, wIdx) => {
                                const weekTotal = week.reduce((acc, date) => {
                                    if (!date) return acc;
                                    const d = historyData[getDateKey(date)];
                                    if (!d) return acc;
                                    return {
                                        stocks: acc.stocks + (d.stocks || 0),
                                        margin: acc.margin + (d.margin || 0),
                                        foreign: acc.foreign + (d.foreign || 0),
                                        cfd: acc.cfd + (d.cfd || 0),
                                    };
                                }, { stocks: 0, margin: 0, foreign: 0, cfd: 0 });
                                const weekSum = weekTotal.stocks + weekTotal.margin + weekTotal.foreign + weekTotal.cfd;

                                return (
                                    <React.Fragment key={wIdx}>
                                        <div className="cal-label-col border-r border-b border-slate-100">
                                            <div className="h-[26px] mb-1"></div>
                                            {Object.entries(CATEGORY_STYLES).filter(([k]) => k !== 'event').map(([key, style]) => (
                                                <div key={key} className={`text-[10px] font-bold text-center py-0.5 rounded ${style.bg} ${style.text}`}>{style.label}</div>
                                            ))}
                                        </div>
                                        {week.slice(1, 6).map((date, dIdx) => (<DayCell key={dIdx} date={date} />))}
                                        <div className="cal-total-col border-b border-slate-100 bg-slate-50">
                                            <div className="flex flex-col gap-0.5 w-full text-xs">
                                                    <div className="h-[26px] mb-1"></div>
                                                    <div className={`text-right ${weekTotal.stocks < 0 ? 'text-[#FF4081]' : weekTotal.stocks > 0 ? 'text-[#536DFE]' : 'text-slate-400'}`}>{formatMoney(weekTotal.stocks)}</div>
                                                    <div className={`text-right ${weekTotal.margin < 0 ? 'text-[#FF4081]' : weekTotal.margin > 0 ? 'text-[#536DFE]' : 'text-slate-400'}`}>{formatMoney(weekTotal.margin)}</div>
                                                    <div className={`text-right ${weekTotal.foreign < 0 ? 'text-[#FF4081]' : weekTotal.foreign > 0 ? 'text-[#536DFE]' : 'text-slate-400'}`}>{formatMoney(weekTotal.foreign)}</div>
                                                    <div className={`text-right ${weekTotal.cfd < 0 ? 'text-[#FF4081]' : weekTotal.cfd > 0 ? 'text-[#536DFE]' : 'text-slate-400'}`}>{formatMoney(weekTotal.cfd)}</div>
                                                    <div className={`mt-1 pt-1 border-t border-slate-200 font-bold text-right ${weekSum < 0 ? 'text-[#FF4081]' : 'text-[#334155]'}`}>{formatMoney(weekSum)}</div>
                                            </div>
                                        </div>
                                    </React.Fragment>
                                );
                            })}
                        </div>
                    </div>
                    
                    {/* --- JPX Style Profit Chart --- */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in-up">
                        <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2"><Icon name="BarChart3" size={18} />月間日次推移 ({currentDate.getMonth()+1}月)</h3>
                        <div className="h-64 w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={dailyChartData} margin={{top: 5, right: 30, left: 20, bottom: 5}}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                    <XAxis dataKey="day" tickLine={false} axisLine={false} tick={{fill: '#64748b', fontSize: 12}} />
                                    <YAxis tickFormatter={(val) => `¥${val/1000}k`} tickLine={false} axisLine={false} tick={{fill: '#64748b', fontSize: 12}} />
                                    <Tooltip 
                                        cursor={{fill: '#f1f5f9'}}
                                        formatter={(val) => [`¥${val.toLocaleString()}`, "損益"]}
                                        contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}}
                                    />
                                    <ReferenceLine y={0} stroke="#94a3b8" />
                                    <Bar dataKey="total">
                                        {dailyChartData.map((entry, index) => (
                                            <Cell key={`cell-${index}`} fill={entry.total >= 0 ? '#536DFE' : '#FF4081'} />
                                        ))}
                                    </Bar>
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>

                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in-up">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[85vh] flex flex-col overflow-hidden">
                                <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                                    <h3 className="font-bold text-lg text-[#334155] flex items-center gap-2">
                                        <Icon name="FileText" size={20} />
                                        {selectedDate.getFullYear()}年{selectedDate.getMonth()+1}月{selectedDate.getDate()}日
                                    </h3>
                                    <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600"><Icon name="X" /></button>
                                </div>
                                <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
                                    {/* Sidebar: Inputs */}
                                    <div className="w-full lg:w-1/4 p-6 border-r border-slate-200 bg-slate-50/50 overflow-y-auto shrink-0">
                                        <div className="mb-6">
                                            <label className="block text-xs font-bold text-[#7C4DFF] mb-1 uppercase">Event (Top Layer)</label>
                                            <input 
                                                type="text" 
                                                placeholder="決算, FRB会合, etc."
                                                value={editData.event || ''}
                                                onChange={(e) => setEditData({...editData, event: e.target.value})}
                                                className="w-full border border-purple-200 rounded p-2 text-sm focus:ring-2 focus:ring-[#7C4DFF] outline-none"
                                            />
                                        </div>

                                        <h4 className="text-sm font-bold text-[#64748B] uppercase mb-4">収支入力 (円)</h4>
                                        <div className="space-y-4">
                                            {[
                                                { k: 'stocks', l: '現物収支' },
                                                { k: 'margin', l: '信用収支' },
                                                { k: 'foreign', l: '海外株収支' },
                                                { k: 'cfd', l: 'CFD/先物' }
                                            ].map(f => (
                                                <div key={f.k}>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">{f.l}</label>
                                                    <input type="number" value={editData[f.k] || ''} onChange={(e) => setEditData({...editData, [f.k]: parseInt(e.target.value) || 0})} className="w-full border border-slate-300 rounded p-2 font-mono text-right focus:ring-2 focus:ring-[#7C4DFF] outline-none" />
                                                </div>
                                            ))}
                                            <div className="pt-4 border-t border-slate-200 mt-4">
                                                <div className="flex justify-between items-center">
                                                    <span className="font-bold text-slate-700">合計</span>
                                                    <span className={`text-xl font-bold font-mono ${(editData.stocks+editData.margin+editData.foreign+editData.cfd) >= 0 ? 'text-[#536DFE]' : 'text-[#FF4081]'}`}>{formatMoney(editData.stocks + editData.margin + editData.foreign + editData.cfd)}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Main: Markdown Split View */}
                                    <div className="flex-1 flex flex-col bg-white overflow-hidden">
                                        <div className="flex border-b border-slate-200 bg-slate-50 px-4 py-2 items-center gap-2">
                                            <Icon name="Pencil" size={14} className="text-slate-500"/>
                                            <span className="text-xs font-bold text-slate-500 uppercase">Markdown Editor & Preview</span>
                                        </div>
                                        <div className="flex-1 flex flex-row h-full overflow-hidden">
                                            {/* Left: Editor */}
                                            <div className="w-1/2 h-full border-r border-slate-200">
                                                <textarea 
                                                    className="w-full h-full p-4 resize-none outline-none font-mono text-sm leading-relaxed bg-white text-slate-800" 
                                                    placeholder="# 本日の振り返り..."
                                                    value={editData.note} 
                                                    onChange={(e) => setEditData({...editData, note: e.target.value})} 
                                                />
                                            </div>
                                            {/* Right: Preview */}
                                            <div className="w-1/2 h-full bg-slate-50/30 overflow-y-auto">
                                                <div 
                                                    className="w-full h-full p-6 markdown-preview" 
                                                    dangerouslySetInnerHTML={{ __html: window.marked ? window.marked.parse(editData.note || '') : editData.note }} 
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 border-t border-slate-200 bg-slate-50 flex justify-end gap-3 shrink-0">
                                    <button onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg text-sm font-bold transition-colors">キャンセル</button>
                                    <button onClick={handleSave} className="px-6 py-2 bg-[#7C4DFF] text-white hover:bg-[#651FFF] rounded-lg text-sm font-bold flex items-center gap-2 transition-colors"><Icon name="Check" size={16} /> 保存</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isImportModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in-up">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
                                <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                                    <h3 className="font-bold text-lg text-[#334155] flex items-center gap-2"><Icon name="FileUp" size={20} /> CSVインポート</h3>
                                    <button onClick={() => setIsImportModalOpen(false)} className="text-slate-400 hover:text-slate-600"><Icon name="X" /></button>
                                </div>
                                <div className="p-6">
                                    <p className="text-sm text-slate-500 mb-4">証券会社のCSVファイルをアップロードしてください。日付ごとに損益が集計され、選択したカテゴリに上書きされます（日記やイベントは保持されます）。</p>
                                    <div className="mb-4">
                                        <label className="block text-xs font-bold text-[#7C4DFF] mb-2 uppercase">インポート先カテゴリを選択</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            {Object.entries(CATEGORY_STYLES).filter(([k]) => k !== 'event').map(([key, style]) => (
                                                <button key={key} onClick={() => setImportCategory(key)} className={`py-2 px-3 rounded text-sm font-bold border transition-all flex items-center justify-between ${importCategory === key ? `bg-[#7C4DFF] text-white border-[#7C4DFF]` : `bg-white text-slate-500 border-slate-200 hover:bg-slate-50`}`}>
                                                    <span>{style.label}</span>
                                                    {importCategory === key && <Icon name="Check" size={14} />}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors relative ${dragActive ? 'border-[#7C4DFF] bg-purple-50' : 'border-slate-300 hover:bg-slate-50'}`} onDragEnter={handleDrag} onDragLeave={handleDrag} onDragOver={handleDrag} onDrop={handleDrop}>
                                        <Icon name="Upload" className="mx-auto text-slate-400 mb-2" size={32} />
                                        <p className="text-slate-600 font-bold mb-1">ファイルをここにドラッグ</p>
                                        <p className="text-xs text-slate-400">またはクリックして選択</p>
                                        <input type="file" accept=".csv" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onChange={(e) => e.target.files && handleFileImport(e.target.files[0])} />
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
