<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- キャッシュ対策 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>Market Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- EasyMDE CSS -->
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">

    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@0.294.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- ScreenShot Library -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* カスタムCSS */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

        body { background-color: #f8fafc; font-family: 'Helvetica Neue', Arial, sans-serif; color: #334155; }
        .gradient-bg { background: linear-gradient(135deg, #7C4DFF 0%, #651FFF 100%); }
        .animate-fade-in-up { animation: fadeInUp 0.6s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .dragging { opacity: 0.5; background-color: #f1f5f9; }

        /* カレンダーグリッド定義 (PCデフォルト) */
        .cal-grid {
            display: grid;
            grid-template-columns: 90px repeat(5, 1fr) 100px;
            gap: 1px;
            background-color: #e2e8f0;
            border: 1px solid #e2e8f0;
        }

        /* スマホ用カレンダー定義: Category列(90px)を削除し、月〜金のみ表示 */
        @media (max-width: 768px) {
            .cal-grid {
                grid-template-columns: repeat(5, 1fr) 60px; /* Category列削除, 週計幅縮小 */
            }
            .cal-label-col { display: none !important; } /* Category列の中身非表示 */
            .cal-header:first-child { display: none; } /* Categoryヘッダー非表示 */
            
            /* StatBox Mobile Fix */
            .stat-box-mobile { 
                min-width: 60% !important;
                max-width: 60% !important;
                flex: 0 0 60% !important;
            }
        }

        .cal-cell {
            background-color: white;
            min-height: 150px;
            padding: 4px;
            position: relative;
            transition: background-color 0.2s;
        }
        .cal-cell:hover { background-color: #F3E5F5; z-index: 20; }
        .cal-header {
            background-color: #f8fafc; color: #64748b; font-size: 0.75rem;
            font-weight: bold; text-align: center; padding: 8px 0;
        }
        .cal-label-col {
            background-color: #f8fafc; display: flex; flex-direction: column;
            justify-content: center; gap: 4px; padding: 8px;
        }
        .cal-total-col {
            background-color: #f8fafc; display: flex; flex-direction: column;
            justify-content: center; align-items: flex-end; padding-right: 8px; gap: 4px;
        }

        /* ==========================================================================
           Markdown Style Fix
           ========================================================================== */
        
        .markdown-preview, .editor-preview, .editor-preview-side { color: #334155; font-size: 13px; line-height: 1.6; }

        /* エディタプレビュー内の画像スタイル調整 */
        .editor-preview img, .editor-preview-side img, .markdown-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin: 8px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .CodeMirror .cm-header-1 { font-size: 1.5rem !important; line-height: 1.4; font-weight: 700; color: #1e293b; }
        .CodeMirror .cm-header-2 { font-size: 1.25rem !important; line-height: 1.4; font-weight: 600; color: #334155; }
        .CodeMirror .cm-header-3 { font-size: 1.15rem !important; line-height: 1.4; font-weight: 600; color: #475569; }

        /* Markdown制御文字の非表示設定 */
        .CodeMirror .cm-formatting-header,
        .CodeMirror .cm-formatting-strong,
        .CodeMirror .cm-formatting-em,
        .CodeMirror .cm-formatting-quote {
            display: none !important;
        }

        .editor-preview h1, .editor-preview-side h1, .markdown-preview h1 { 
            font-size: 1.5rem !important; font-weight: 700; margin: 0.6em 0 0.4em 0; 
            border-bottom: 1px solid #e2e8f0; padding-bottom: 0.2em; color: #1e293b; 
        }
        .editor-preview h2, .editor-preview-side h2, .markdown-preview h2 { 
            font-size: 1.25rem !important; font-weight: 600; margin: 0.5em 0 0.3em 0; 
            color: #334155; border-left: 4px solid #7C4DFF; padding-left: 0.5em; 
        }
        .editor-preview h3, .editor-preview-side h3, .markdown-preview h3 { 
            font-size: 1.15rem !important; font-weight: 600; margin: 0.4em 0 0.2em 0; color: #475569; 
        }
        .editor-preview ul, .editor-preview-side ul, .markdown-preview ul {
            list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.6em; 
        }
        
        /* ==========================================================================
           EasyMDE & CodeMirror Scroll Fix (Mobile Optimized)
           ========================================================================== */
        
        .EasyMDEContainer { 
            background: white; 
            border-radius: 0.5rem; 
            height: 100%; 
            display: flex;
            flex-direction: column;
        }

        .editor-toolbar { 
            border: 1px solid #e2e8f0; 
            border-radius: 0.5rem 0.5rem 0 0; 
            background-color: #f8fafc; 
            opacity: 1; 
            flex-shrink: 0; 
        }

        .CodeMirror { 
            border: 1px solid #e2e8f0; 
            border-radius: 0 0 0.5rem 0.5rem; 
            font-family: monospace; 
            font-size: 14px; 
            flex: 1; 
            height: auto !important; 
            overscroll-behavior-y: contain; 
        }

        .editor-statusbar { display: none; }

        /* ========================================================================== */

        .stock-tooltip {
            visibility: hidden; opacity: 0; position: absolute; bottom: 100%; left: 50%;
            transform: translateX(-50%) translateY(-5px); z-index: 100;
            background-color: rgba(255, 255, 255, 0.98); border: 1px solid #cbd5e1; padding: 0;
            border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            width: 260px; max-height: 300px; overflow-y: auto; font-size: 11px;
            pointer-events: none; transition: opacity 0.15s, transform 0.15s;
        }
        .cal-cell:hover .stock-tooltip { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(-10px); }
        .cal-cell:hover .stock-tooltip { pointer-events: auto; }

        /* Quotes Carousel */
        .quote-scroll-container {
            display: flex; overflow-x: auto; gap: 16px; padding: 16px; scroll-behavior: smooth;
        }
        .quote-scroll-container::-webkit-scrollbar { height: 6px; }
        .quote-card {
            flex: 0 0 300px; min-height: 120px; background: white; border: 1px solid #e2e8f0;
            border-radius: 12px; padding: 16px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative; transition: transform 0.2s, box-shadow 0.2s;
        }
        .quote-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        .card-scroll-content {
            max-height: 180px; 
            overflow-y: auto;
        }
        .card-scroll-content::-webkit-scrollbar { width: 4px; }
        .card-scroll-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

        .unified-header-card {
            background: linear-gradient(135deg, #7C4DFF 0%, #651FFF 100%); color: white;
            border-radius: 0.75rem; padding: 1rem 1.5rem; margin-bottom: 1.5rem; display: flex;
            justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            height: 96px;
        }
        .unified-header-title { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; }
        .unified-header-sub { font-size: 0.75rem; opacity: 0.9; }

        @media (max-width: 768px) {
            .unified-header-card { height: auto; flex-direction: column; align-items: flex-start; gap: 0.5rem; padding: 1rem; }
            .unified-header-title { font-size: 1.25rem; }
        }
        
        .search-results-dropdown {
            position: absolute; top: 100%; right: 0; margin-top: 4px;
            width: 300px; max-height: 400px; overflow-y: auto;
            background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 60;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Cell, ReferenceLine, ResponsiveContainer, LabelList, Legend } = Recharts;

        // --- Icons ---
        const Icon = ({ name, size = 20, className = "", style = {} }) => {
            const icons = {
                Menu: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="12" x2="20" y2="12" /><line x1="4" y1="6" x2="20" y2="6" /><line x1="4" y1="18" x2="20" y2="18" /></svg>,
                LayoutDashboard: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1" /><rect width="7" height="5" x="14" y="3" rx="1" /><rect width="7" height="9" x="14" y="12" rx="1" /><rect width="7" height="5" x="3" y="16" rx="1" /></svg>,
                LineChart: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18" /><path d="m19 9-5 5-4-4-3 3" /></svg>,
                BarChart3: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18" /><path d="M18 17V9" /><path d="M13 17V5" /><path d="M8 17v-3" /></svg>,
                ExternalLink: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></svg>,
                AlertTriangle: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><path d="M12 9v4" /><path d="M12 17h.01" /></svg>,
                Upload: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></svg>,
                ZoomIn: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="11" y1="8" x2="11" y2="14" /><line x1="8" y1="11" x2="14" y2="11" /></svg>,
                ZoomOut: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /><line x1="8" y1="11" x2="14" y2="11" /></svg>,
                RotateCcw: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></svg>,
                MousePointer2: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 6-8 13 4.5-1.5 3 7 3-7 4.5 1.5L12 6Z" /><path d="m6 13 6-3 6 3" /></svg>,
                Plus: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>,
                Trash2: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></svg>,
                Link: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></svg>,
                X: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>,
                GripVertical: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></svg>,
                FolderOpen: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2" /></svg>,
                Briefcase: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></svg>,
                Calendar: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></svg>,
                FileText: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><line x1="10" y1="9" x2="8" y2="9" /></svg>,
                Check: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12" /></svg>,
                Download: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>,
                ChevronLeft: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6" /></svg>,
                ChevronRight: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6" /></svg>,
                ChevronDown: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6" /></svg>,
                FileCsv: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><path d="M8 13h2" /><path d="M8 17h2" /><path d="M14 13h2" /><path d="M14 17h2" /></svg>,
                Pencil: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" /><path d="m15 5 4 4" /></svg>,
                FileUp: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" /><path d="M12 12v9" /><path d="m16 16-4-4-4 4" /></svg>,
                Save: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></svg>,
                Settings: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></svg>,
                Database: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" /><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" /></svg>,
                RefreshCw: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></svg>,
                Pin: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="17" x2="12" y2="22" /><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z" /></svg>,
                PinOff: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="2" y1="2" x2="22" y2="22" /><line x1="12" y1="17" x2="12" y2="22" /><path d="M9 9v1.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V17h14" /><path d="M15 9.34V6h1a2 2 0 0 0 0-4H7.89" /></svg>,
                Lightbulb: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5 0-2.2-1.8-4-4-4a4 4 0 0 0-4 4c0 1.5.5 2.5 1.5 3.5.8.8 1.3 1.5 1.5 2.5" /><path d="M9 18h6" /><path d="M10 22h4" /></svg>,
                ArrowLeft: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7" /><path d="M19 12H5" /></svg>,
                ArrowRight: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></svg>,
                Bookmark: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z" /></svg>,
                Send: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
                Archive: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="5" x="2" y="3" rx="1" /><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8" /><path d="M10 12h4" /></svg>,
                Search: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></svg>,
                List: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></svg>,
                Camera: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
                TrendingUp: <svg width={size} height={size} className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></svg>
            };
            return icons[name] || null;
        };

        const CATEGORY_STYLES = {
            stocks: { bg: 'bg-[#F3E5F5]', text: 'text-[#7E57C2]', label: '現物' },
            margin: { bg: 'bg-[#E8EAF6]', text: 'text-[#5C6BC0]', label: '信用' },
            foreign: { bg: 'bg-[#EDE7F6]', text: 'text-[#673AB7]', label: '米国' },
            cfd: { bg: 'bg-[#FCE4EC]', text: 'text-[#D81B60]', label: 'CFD' },
            event: { bg: 'bg-white', text: 'text-[#7C4DFF]', label: 'Event' }
        };

        // --- Quotes Manager (EasyMDE) ---
        // 修正: uploadConfigを受け取り、pasteイベントで画像アップロードを処理する
        // 追加: onSave propを受け取り、Ctrl+Sでの保存をサポート
        const EasyMDEEditor = ({ value, onChange, uploadConfig, onSave }) => {
            const textareaRef = useRef(null);
            const mdeRef = useRef(null);
            const onSaveRef = useRef(onSave); // 最新のonSave関数を保持するためのRef

            useEffect(() => { onSaveRef.current = onSave; }, [onSave]);
            
            useEffect(() => {
                if (!textareaRef.current) return;
                mdeRef.current = new EasyMDE({
                    element: textareaRef.current, initialValue: value, spellChecker: false, status: false,
                    toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "|", "preview", "side-by-side", "fullscreen"],
                    placeholder: "内容を入力...", forceSync: true,
                    // Markdownプレビューのレンダリング設定（画像を表示するため）
                    previewRender: function(plainText) {
                        return window.marked ? window.marked.parse(plainText) : plainText;
                    },
                    // --- Ctrl+S ショートカット追加 ---
                    extraKeys: {
                        "Ctrl-S": function(cm) { if (onSaveRef.current) onSaveRef.current(); },
                        "Cmd-S": function(cm) { if (onSaveRef.current) onSaveRef.current(); }
                    }
                });
                mdeRef.current.codemirror.on("change", () => onChange(mdeRef.current.value()));

                // --- 画像ペースト監視 & GitHubアップロード処理 ---
                mdeRef.current.codemirror.on("paste", async (cm, event) => {
                    const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                    for (let index in items) {
                        const item = items[index];
                        if (item.kind === 'file' && item.type.includes('image/')) {
                            event.preventDefault(); // デフォルトのペースト動作を無効化
                            
                            if (!uploadConfig || !uploadConfig.token || !uploadConfig.owner || !uploadConfig.repo) {
                                alert("画像をアップロードするには、設定でGitHub Token (Repo権限)、Owner、Repo名を設定してください。");
                                return;
                            }

                            const blob = item.getAsFile();
                            const reader = new FileReader();
                            reader.onload = async (e) => {
                                const base64Content = e.target.result.split(',')[1];
                                
                                // ファイル名生成: YYYYMMDD_HHmmss.jpeg (コロン除去)
                                const now = new Date();
                                const pad = (n) => String(n).padStart(2, '0');
                                const timestamp = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
                                const filename = `${timestamp}.jpeg`;
                                const path = `JPEG/${filename}`;

                                const uploadingText = `![Uploading ${filename}...]`;
                                cm.replaceSelection(uploadingText);

                                try {
                                    const response = await fetch(`https://api.github.com/repos/${uploadConfig.owner}/${uploadConfig.repo}/contents/${path}`, {
                                        method: 'PUT',
                                        headers: {
                                            'Authorization': `token ${uploadConfig.token}`,
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({
                                            message: `Upload image: ${filename}`,
                                            content: base64Content
                                        })
                                    });

                                    if (response.ok) {
                                        // アップロード成功: raw画像のURLを挿入
                                        const imageUrl = `https://raw.githubusercontent.com/${uploadConfig.owner}/${uploadConfig.repo}/main/${path}`;
                                        const currentVal = mdeRef.current.value();
                                        mdeRef.current.value(currentVal.replace(uploadingText, `![image](${imageUrl})`));
                                    } else {
                                        const errorData = await response.json();
                                        alert(`Upload Failed: ${errorData.message}`);
                                        const currentVal = mdeRef.current.value();
                                        mdeRef.current.value(currentVal.replace(uploadingText, `[Upload Failed]`));
                                    }
                                } catch (err) {
                                    console.error(err);
                                    alert("通信エラーが発生しました。");
                                    const currentVal = mdeRef.current.value();
                                    mdeRef.current.value(currentVal.replace(uploadingText, `[Upload Failed]`));
                                }
                            };
                            reader.readAsDataURL(blob);
                        }
                    }
                });
                // ----------------------------------------------------

                return () => { mdeRef.current.toTextArea(); mdeRef.current = null; };
            }, []); // 依存配列は空でOK (uploadConfigはref経由ではないが、初期化時に渡される前提)

            useEffect(() => {
                if (mdeRef.current && value !== mdeRef.current.value()) {
                    mdeRef.current.value(value);
                }
            }, [value]);

            return <textarea ref={textareaRef} />;
        };

        // --- Quotes Manager ---
        const QuotesManager = ({ quotes, setQuotes, prefillBody, uploadConfig }) => {
            const [input, setInput] = useState("");
            const [editId, setEditId] = useState(null);
            const [filterBookmarked, setFilterBookmarked] = useState(false);
            const [filterArchived, setFilterArchived] = useState(false); // アーカイブフィルター追加
            const scrollRef = useRef(null);
            const [autoScroll, setAutoScroll] = useState(true);
            const scrollInterval = useRef(null);
            const [displayQuotes, setDisplayQuotes] = useState([]);
            const isInitialized = useRef(false);

            // 初期化・ランダム化 (初期ロード時のみ)
            useEffect(() => {
                if (isInitialized.current) return;
                if (quotes.length > 0) {
                    const streamSource = quotes.filter(q => !q.archived); 
                    const shuffled = [...streamSource].sort(() => Math.random() - 0.5);
                    setDisplayQuotes(shuffled);
                    isInitialized.current = true;
                } else if (quotes.length === 0) {
                    setDisplayQuotes([]);
                    isInitialized.current = true;
                }
            }, [quotes]);

            useEffect(() => {
                if (prefillBody) {
                    setInput(prefillBody);
                }
            }, [prefillBody]);

            useEffect(() => {
                if (autoScroll) {
                    scrollInterval.current = setInterval(() => {
                        if (scrollRef.current) {
                            const container = scrollRef.current;
                            const scrollEnd = container.scrollWidth - container.clientWidth;
                            
                            // 最後に到達したら最初に戻る
                            if (container.scrollLeft >= scrollEnd - 5) {
                                container.scrollLeft = 0;
                            } else {
                                container.scrollLeft += 1;
                            }
                        }
                    }, 30);
                } else clearInterval(scrollInterval.current);
                return () => clearInterval(scrollInterval.current);
            }, [autoScroll]);

            const handleScrollLeft = () => { if (scrollRef.current) scrollRef.current.scrollLeft -= 316; };
            const handleScrollRight = () => { if (scrollRef.current) scrollRef.current.scrollLeft += 316; };
            
            const addQuote = (forcePin = false) => { 
                if (!input.trim()) return; 
                if (editId) { 
                    setQuotes(quotes.map(q => q.id === editId ? { ...q, text: input, pinned: forcePin ? true : q.pinned } : q)); 
                    setEditId(null); 
                } else { 
                    const parts = input.split(/ーーー|---/);
                    const newQuotes = parts.map((part, index) => {
                        if (!part.trim()) return null;
                        return { 
                            id: Date.now().toString() + index, 
                            text: part.trim(), 
                            pinned: forcePin, 
                            bookmarked: false, 
                            archived: false, 
                            order: quotes.length + index,
                            createdAt: Date.now() 
                        };
                    }).filter(q => q !== null);
                    
                    // State更新: 新しいものが先頭に来るように
                    const updatedQuotes = [...newQuotes, ...quotes];
                    setQuotes(updatedQuotes);
                    
                    // STREAM表示用も更新 (先頭に追加)
                    setDisplayQuotes(prev => [...newQuotes, ...prev]);
                    
                    if (scrollRef.current) scrollRef.current.scrollLeft = 0;
                }
                setInput("");
            };
            
            // 削除・アーカイブ・復元
            const deleteQuote = (id) => { setQuotes(quotes.filter(q => q.id !== id)); };
            const archiveQuote = (id) => { setQuotes(quotes.map(q => q.id === id ? { ...q, archived: true } : q)); }; // アーカイブ処理
            const restoreQuote = (id) => { setQuotes(quotes.map(q => q.id === id ? { ...q, archived: false } : q)); }; // アーカイブ復元 (元の状態へ = PinならPinへ)
            const restoreToStream = (id) => { setQuotes(quotes.map(q => q.id === id ? { ...q, archived: false, pinned: false } : q)); }; // ストリームに戻す (Pin解除)

            const togglePin = (id) => setQuotes(quotes.map(q => q.id === id ? { ...q, pinned: !q.pinned } : q));
            const toggleBookmark = (id) => setQuotes(quotes.map(q => q.id === id ? { ...q, bookmarked: !q.bookmarked } : q));
            const startEdit = (quote) => { setInput(quote.text); setEditId(quote.id); };
            
            // Drag and Drop for Pinned items
            const [draggedItem, setDraggedItem] = useState(null);
            const handleDragStart = (e, index) => setDraggedItem(index);
            const handleDragOver = (e, index) => { e.preventDefault(); if (draggedItem === null || draggedItem === index) return; const pinnedQuotes = quotes.filter(q => q.pinned); const unpinnedQuotes = quotes.filter(q => !q.pinned); const newPinned = [...pinnedQuotes]; const [removed] = newPinned.splice(draggedItem, 1); newPinned.splice(index, 0, removed); setQuotes([...newPinned, ...unpinnedQuotes]); setDraggedItem(index); };
            
            // PINNED QUOTES (BOARD)の表示ロジック: アーカイブフィルター対応
            const visiblePinnedQuotes = quotes.filter(q => q.pinned && (filterArchived ? q.archived : !q.archived));
            
            // STREAMクオート取得ロジック
            // displayQuotes (IDリスト) を元に最新のデータでマッピングする
            const streamQuotes = displayQuotes.filter(dq => {
                const exists = quotes.find(q => q.id === dq.id);
                if (!exists) return false;
                
                // ブックマークフィルター適用時
                if (filterBookmarked) {
                    return exists.bookmarked;
                }
                // アーカイブされたものはStreamに出さない
                if (exists.archived) return false;

                return true;
            }).map(dq => quotes.find(q => q.id === dq.id));

            return (
                <div className="space-y-6 pb-10">
                    <div className="unified-header-card">
                        <div className="unified-header-title"><Icon name="Lightbulb" size={28} /> 投資の格言集</div>
                        <p className="unified-header-sub">心に留めておくべきルールと戒め</p>
                    </div>
                    
                    {/* Pinned Board */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in-up">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-sm font-bold text-slate-500 flex items-center gap-2"><Icon name="Pin" size={16} /> 重要ピン</h2>
                            <button 
                                onClick={() => setFilterArchived(!filterArchived)} 
                                className={`flex items-center gap-1 text-xs px-2 py-1 rounded border ${filterArchived ? 'bg-[#7C4DFF] text-white border-[#7C4DFF]' : 'bg-white text-slate-500 border-slate-300'}`}
                            >
                                <Icon name="Archive" size={12} /> アーカイブ
                            </button>
                        </div>
                        {visiblePinnedQuotes.length === 0 && <p className="text-sm text-slate-400 mb-4">{filterArchived ? 'アーカイブされたカードはありません。' : 'ピン留めされたカードはありません。'}</p>}
                        {visiblePinnedQuotes.length > 0 && (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {visiblePinnedQuotes.map((q, i) => (
                                    <div key={q.id} draggable={!filterArchived} onDragStart={(e) => !filterArchived && handleDragStart(e, i)} onDragOver={(e) => !filterArchived && handleDragOver(e, i)} className={`bg-white rounded-xl shadow-sm border-l-4 ${q.archived ? 'border-slate-400 opacity-70' : 'border-[#7C4DFF]'} p-4 relative group hover:shadow-md transition-all ${!filterArchived ? 'cursor-move' : ''}`}>
                                        <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white z-10">
                                            {q.archived ? (
                                                <>
                                                    <button onClick={() => restoreToStream(q.id)} className="p-1 text-slate-400 hover:text-[#7C4DFF]" title="ストリームに戻す"><Icon name="List" size={14} /></button>
                                                    <button onClick={() => restoreQuote(q.id)} className="p-1 text-slate-400 hover:text-green-500" title="復元 (Pinnedへ)"><Icon name="RotateCcw" size={14} /></button>
                                                    <button onClick={() => deleteQuote(q.id)} className="p-1 text-slate-400 hover:text-red-500" title="完全に削除"><Icon name="Trash2" size={14} /></button>
                                                </>
                                            ) : (
                                                <>
                                                    <button onClick={() => togglePin(q.id)} className="p-1 text-slate-400 hover:text-[#7C4DFF]"><Icon name="PinOff" size={14} /></button>
                                                    <button onClick={() => startEdit(q)} className="p-1 text-slate-400 hover:text-[#536DFE]"><Icon name="Pencil" size={14} /></button>
                                                    <button onClick={() => archiveQuote(q.id)} className="p-1 text-slate-400 hover:text-red-500" title="アーカイブ"><Icon name="X" size={14} /></button>
                                                </>
                                            )}
                                        </div>
                                        <div className="card-scroll-content">
                                            <div className="markdown-preview text-sm" dangerouslySetInnerHTML={{ __html: window.marked ? window.marked.parse(q.text) : q.text }} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Stream */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 relative animate-fade-in-up group mt-6" onMouseEnter={() => setAutoScroll(false)} onMouseLeave={() => setAutoScroll(true)}>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-sm font-bold text-slate-500">格言ストリーム</h2>
                            <button 
                                onClick={() => setFilterBookmarked(!filterBookmarked)} 
                                className={`flex items-center gap-1 text-xs px-2 py-1 rounded border ${filterBookmarked ? 'bg-[#7C4DFF] text-white border-[#7C4DFF]' : 'bg-white text-[#7C4DFF] border-[#7C4DFF]'}`}
                            >
                                <Icon name="Bookmark" size={12} fill={filterBookmarked ? "currentColor" : "none"} /> ブックマーク
                            </button>
                        </div>

                        <button onClick={handleScrollLeft} className="absolute left-2 top-1/2 -translate-y-1/2 z-10 bg-white/80 p-2 rounded-full shadow hover:bg-white text-[#7C4DFF] opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="ArrowLeft" /></button>
                        <button onClick={handleScrollRight} className="absolute right-2 top-1/2 -translate-y-1/2 z-10 bg-white/80 p-2 rounded-full shadow hover:bg-white text-[#7C4DFF] opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="ArrowRight" /></button>
                        
                        <div ref={scrollRef} className="quote-scroll-container">
                            {streamQuotes.length === 0 && <p className="text-slate-400 text-sm text-center w-full">格言がありません。</p>}
                            {streamQuotes.map(q => (
                                <div key={q.id} className="quote-card shrink-0">
                                    <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white/90 z-20">
                                        <button onClick={() => toggleBookmark(q.id)} className={`p-1 ${q.bookmarked ? 'text-[#7C4DFF]' : 'text-slate-400'} hover:text-[#7C4DFF]`}><Icon name="Bookmark" size={14} fill={q.bookmarked ? "#7C4DFF" : "none"} /></button>
                                        <button onClick={() => togglePin(q.id)} className={`p-1 ${q.pinned ? 'text-[#7C4DFF]' : 'text-slate-400'} hover:text-[#7C4DFF]`}><Icon name="Pin" size={14} fill={q.pinned ? "#7C4DFF" : "none"} /></button>
                                        <button onClick={() => startEdit(q)} className="p-1 text-slate-400 hover:text-[#536DFE]"><Icon name="Pencil" size={14} /></button>
                                        <button onClick={() => deleteQuote(q.id)} className="p-1 text-slate-400 hover:text-red-500"><Icon name="X" size={14} /></button>
                                    </div>
                                    <div className="card-scroll-content">
                                        <div className="markdown-preview text-sm" dangerouslySetInnerHTML={{ __html: window.marked ? window.marked.parse(q.text) : q.text }} />
                                    </div>
                                    {q.bookmarked && <div className="absolute top-2 left-2 text-[#7C4DFF]"><Icon name="Bookmark" size={16} fill="#7C4DFF" /></div>}
                                    {q.pinned && <div className="absolute top-2 left-8 text-[#7C4DFF]"><Icon name="Pin" size={16} fill="#7C4DFF" /></div>}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Input Area */}
                    <div className="bg-white rounded-xl shadow-xl border border-slate-200 p-4 animate-fade-in-up mt-6">
                        <div className="flex flex-col md:flex-row gap-2">
                            <div className="flex-1">
                                <EasyMDEEditor value={input} onChange={setInput} uploadConfig={uploadConfig} onSave={() => addQuote(false)} />
                            </div>
                            <div className="flex md:flex-col gap-2 self-end md:self-start w-full md:w-auto">
                                <button onClick={() => addQuote(false)} className="flex-1 bg-[#7C4DFF] text-white px-6 rounded-lg font-bold hover:bg-[#651FFF] transition-colors py-2 md:py-3 whitespace-nowrap">STREAM</button>
                                <button onClick={() => addQuote(true)} className="flex-1 bg-white text-[#7C4DFF] border border-[#7C4DFF] px-6 rounded-lg font-bold hover:bg-purple-50 transition-colors py-2 md:py-3 whitespace-nowrap flex items-center justify-center gap-1">
                                    <Icon name="Pin" size={16} /> PIN
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        //  投資カレンダー
        // ==========================================
        const ProfitManager = ({ customLinks, setCustomLinks, quotes, setQuotes, historyData, updateHistoryData, saveAllData, onMoveToQuotes }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isMenuOpen, setIsMenuOpen] = useState(false); // 修正: メニュー開閉状態
            const [editData, setEditData] = useState({ event: '', stocks: 0, margin: 0, foreign: 0, cfd: 0, note: '', important: false, details: [] });
            const [importCategory, setImportCategory] = useState('stocks');
            const [dragActive, setDragActive] = useState(false);
            
            // GitHub Gist & Image Upload Settings
            const [gistToken, setGistToken] = useState(localStorage.getItem('gist_token') || '');
            const [gistId, setGistId] = useState(localStorage.getItem('gist_id') || '');
            const [repoOwner, setRepoOwner] = useState(localStorage.getItem('repo_owner') || 'seahirodigital');
            const [repoName, setRepoName] = useState(localStorage.getItem('repo_name') || 'investment_dashboard');
            
            const [mobileModalTab, setMobileModalTab] = useState('diary');
            const [chartMode, setChartMode] = useState('daily');
            
            // 検索機能用 State
            const [searchQuery, setSearchQuery] = useState('');
            const [isSearchFocused, setIsSearchFocused] = useState(false);

            const formatMoney = (val) => val ? val.toLocaleString() : '0';
            const getMonthKey = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            const getDateKey = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

            const handleSaveSettings = () => { 
                localStorage.setItem('gist_token', gistToken.trim()); 
                localStorage.setItem('gist_id', gistId.trim()); 
                localStorage.setItem('repo_owner', repoOwner.trim());
                localStorage.setItem('repo_name', repoName.trim());
                setIsSettingsOpen(false); 
                alert("設定を保存しました。"); 
            };
            
            // Editorに渡す設定オブジェクト
            const uploadConfig = useMemo(() => ({
                token: gistToken,
                owner: repoOwner,
                repo: repoName
            }), [gistToken, repoOwner, repoName]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        if (isModalOpen) setIsModalOpen(false);
                        if (isImportModalOpen) setIsImportModalOpen(false);
                        if (isSettingsOpen) setIsSettingsOpen(false);
                        if (isMenuOpen) setIsMenuOpen(false); // 修正: メニューを閉じる
                        setIsSearchFocused(false);
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [isModalOpen, isImportModalOpen, isSettingsOpen, isMenuOpen]);

            // 検索ロジック
            const searchResults = useMemo(() => {
                if (!searchQuery.trim()) return [];
                const query = searchQuery.toLowerCase();
                return Object.entries(historyData)
                    .filter(([key, val]) => {
                        const noteMatch = val.note && val.note.toLowerCase().includes(query);
                        const eventMatch = val.event && val.event.toLowerCase().includes(query);
                        return noteMatch || eventMatch;
                    })
                    .sort((a, b) => new Date(b[0]) - new Date(a[0])) // 日付降順
                    .map(([key, val]) => ({ date: key, ...val }));
            }, [searchQuery, historyData]);
            
            // Youtube ID抽出
            const extractYoutubeIds = (text) => {
                if (!text) return [];
                const regExp = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/g;
                const matches = [];
                let match;
                while ((match = regExp.exec(text)) !== null) {
                    if (!matches.includes(match[1])) matches.push(match[1]);
                }
                return matches; // 制限なし
            };
            
            const youtubeThumbnails = useMemo(() => extractYoutubeIds(editData.note), [editData.note]);

            const stats = useMemo(() => {
                const currentYearKey = currentDate.getFullYear().toString();
                const currentMonthKey = getMonthKey(currentDate);
                const prevMonthDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
                const prevMonthKey = getMonthKey(prevMonthDate);

                let currentYearTotal = 0;
                let currentMonthTotal = 0;
                let prevMonthTotal = 0;
                
                let currentMonthBreakdown = { s: 0, m: 0, f: 0, c: 0 };

                Object.entries(historyData).forEach(([key, val]) => {
                    if (key.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const dayTotal = (val.stocks || 0) + (val.margin || 0) + (val.foreign || 0) + (val.cfd || 0);
                        if (key.startsWith(currentYearKey)) currentYearTotal += dayTotal;
                        if (key.startsWith(currentMonthKey)) {
                            currentMonthTotal += dayTotal;
                            currentMonthBreakdown.s += (val.stocks || 0);
                            currentMonthBreakdown.m += (val.margin || 0);
                            currentMonthBreakdown.f += (val.foreign || 0);
                            currentMonthBreakdown.c += (val.cfd || 0);
                        }
                        if (key.startsWith(prevMonthKey)) prevMonthTotal += dayTotal;
                    }
                });
                return { currentYearTotal, prevMonthTotal, currentMonthTotal, prevMonthDate, currentMonthBreakdown };
            }, [historyData, currentDate]);

            const dailyChartData = useMemo(() => {
                if (chartMode === 'daily') {
                    const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
                    const data = [];
                    for (let d = 1; d <= daysInMonth; d++) {
                        const key = getDateKey(new Date(currentDate.getFullYear(), currentDate.getMonth(), d));
                        const dData = historyData[key];
                        data.push({ day: d, date: key, total: dData ? ((dData.stocks || 0) + (dData.margin || 0) + (dData.foreign || 0) + (dData.cfd || 0)) : 0 });
                    }
                    return data;
                } else {
                    const year = currentDate.getFullYear();
                    const data = [];
                    for (let m = 1; m <= 12; m++) {
                        const monthKeyPrefix = `${year}-${String(m).padStart(2, '0')}`;
                        let monthTotal = 0;
                        Object.entries(historyData).forEach(([key, val]) => {
                            if (key.startsWith(monthKeyPrefix)) {
                                monthTotal += (val.stocks || 0) + (val.margin || 0) + (val.foreign || 0) + (val.cfd || 0);
                            }
                        });
                        data.push({ day: m, name: `${m}月`, total: monthTotal });
                    }
                    return data;
                }
            }, [historyData, currentDate, chartMode]);

            const calendarWeeks = useMemo(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const weeks = [];
                let currentWeek = [];
                for (let i = 0; i < firstDay.getDay(); i++) currentWeek.push(null);
                for (let d = 1; d <= lastDay.getDate(); d++) {
                    const date = new Date(year, month, d);
                    currentWeek.push(date);
                    if (date.getDay() === 6) { weeks.push(currentWeek); currentWeek = []; }
                }
                if (currentWeek.length > 0) { while (currentWeek.length < 7) currentWeek.push(null); weeks.push(currentWeek); }
                return weeks;
            }, [currentDate]);

            const CustomAxisTick = (props) => {
                const { x, y, payload } = props;
                if (chartMode === 'daily') {
                    const d = new Date(currentDate.getFullYear(), currentDate.getMonth(), payload.value);
                    const day = d.getDay();
                    let fill = '#94a3b8';
                    if (day === 6 || day === 0) fill = '#FF4081';
                    return (<text x={x} y={y} dy={16} textAnchor="middle" fill={fill} fontSize={10}>{payload.value}</text>);
                } else {
                    return (<text x={x} y={y} dy={16} textAnchor="middle" fill="#64748B" fontSize={10}>{payload.value}</text>);
                }
            };

            const processCSVData = (rows) => {
                if (!rows || rows.length === 0) return;
                let headerRowIndex = -1, dateColIndex = -1, plColIndex = -1, nameColIndex = -1;
                
                const dateKeywords = ['約定日', '約定日時', 'Trade Date'];
                const plKeywords = ['実現損益', '損益金額', '決済損益', 'Amount'];
                const nameKeywords = ['銘柄', '銘柄名', 'Symbol', 'Item'];

                for (let i = 0; i < Math.min(rows.length, 50); i++) {
                    const row = rows[i].map(c => String(c).trim());
                    const dIdx = row.findIndex(c => dateKeywords.some(k => c.includes(k)));
                    const pIdx = row.findIndex(c => plKeywords.some(k => c.includes(k)) && !c.includes('評価損益'));
                    const nIdx = row.findIndex(c => nameKeywords.some(k => c.includes(k)));
                    
                    if (dIdx !== -1 && pIdx !== -1) { 
                        headerRowIndex = i; 
                        dateColIndex = dIdx; 
                        plColIndex = pIdx; 
                        nameColIndex = nIdx; 
                        break; 
                    }
                }
                if (headerRowIndex === -1) { alert("有効なデータが見つかりませんでした。"); return; }
                
                const detailDataMap = {};
                
                for (let i = headerRowIndex + 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row[dateColIndex]) continue;
                    
                    const dateStr = String(row[dateColIndex]).trim().replace(/\//g, '-').split(' ')[0];
                    const parts = dateStr.split('-');
                    if (parts.length !== 3) continue;
                    
                    const dateKey = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                    const val = parseInt(String(row[plColIndex]).replace(/,/g, '').trim(), 10);
                    
                    if (!isNaN(val)) {
                        if (!detailDataMap[dateKey]) detailDataMap[dateKey] = [];
                        let name = "不明な銘柄";
                        if (nameColIndex !== -1) name = String(row[nameColIndex]).trim();
                        detailDataMap[dateKey].push({ name, amount: val, category: importCategory });
                    }
                }
                
                const newHistory = { ...historyData };
                let count = 0;
                
                Object.entries(detailDataMap).forEach(([key, newDetailsList]) => {
                    if (!newHistory[key]) newHistory[key] = { event: '', stocks: 0, margin: 0, foreign: 0, cfd: 0, note: '', important: false, details: [] };
                    const existingDetails = newHistory[key].details || [];
                    
                    let addedAmount = 0;
                    const finalNewDetails = [];

                    newDetailsList.forEach(newItem => {
                        const isDuplicate = existingDetails.some(existing => 
                            existing.name === newItem.name && 
                            existing.amount === newItem.amount && 
                            existing.category === newItem.category
                        );
                        
                        if (!isDuplicate) {
                            finalNewDetails.push(newItem);
                            addedAmount += newItem.amount;
                        }
                    });

                    if (finalNewDetails.length > 0) {
                        newHistory[key] = {
                            ...newHistory[key],
                            [importCategory]: (newHistory[key][importCategory] || 0) + addedAmount,
                            details: [...existingDetails, ...finalNewDetails]
                        };
                        count++;
                    }
                });
                
                updateHistoryData(newHistory);
                setIsImportModalOpen(false);
                if(count > 0) alert(`${count}日分のデータを更新しました。`);
                else alert("新しいデータは見つかりませんでした（重複はスキップされました）。");
            };

            const handleFileImport = (file) => {
                if (!file) return;
                if (file.name.endsWith('.json') || importCategory === 'backup') {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            if (json.history) updateHistoryData(json.history);
                            if (json.links) setCustomLinks(json.links);
                            if (json.quotes) setQuotes(json.quotes);
                            setIsImportModalOpen(false); alert('復元完了');
                        } catch (err) { alert('読込失敗'); }
                    };
                    reader.readAsText(file); return;
                }
                const reader = new FileReader();
                reader.onload = (event) => Papa.parse(event.target.result, { header: false, skipEmptyLines: true, complete: (res) => processCSVData(res.data) });
                reader.readAsText(file, 'Shift_JIS');
            };

            const handleDeleteDetail = (dateKey, detailIndex, e) => {
                if(e) e.stopPropagation();
                if (!window.confirm("この明細を削除しますか？\n(カテゴリ情報がある場合、合計金額からも減算されます)")) return;
                const newData = { ...historyData };
                const dayData = { ...newData[dateKey] };
                const details = [...dayData.details];
                const targetDetail = details[detailIndex];
                if (targetDetail.category && dayData[targetDetail.category] !== undefined) {
                    dayData[targetDetail.category] -= targetDetail.amount;
                }
                details.splice(detailIndex, 1);
                dayData.details = details;
                newData[dateKey] = dayData;
                updateHistoryData(newData);
                if (isModalOpen && selectedDate && getDateKey(selectedDate) === dateKey) {
                    setEditData(dayData);
                }
            };

            const handleDrag = (e) => {
                e.preventDefault(); e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") setDragActive(true);
                else if (e.type === "dragleave") setDragActive(false);
            };

            const handleDrop = (e) => {
                e.preventDefault(); e.stopPropagation(); setDragActive(false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) handleFileImport(e.dataTransfer.files[0]);
            };

            const openModal = (dateOrStr) => {
                if (!dateOrStr) return;
                let date;
                if (typeof dateOrStr === 'string') {
                    date = new Date(dateOrStr);
                } else {
                    date = dateOrStr;
                }
                
                const key = getDateKey(date);
                const data = historyData[key] || { event: '', stocks: 0, margin: 0, foreign: 0, cfd: 0, note: '', important: false, details: [] };
                if (!data.note) data.note = `# ${key.replace(/-/g, '/')}`;
                setSelectedDate(date); 
                setEditData({ ...data }); 
                setMobileModalTab('diary');
                setIsModalOpen(true);
                setSearchQuery(''); // 検索クリア
            };
            const handleSave = () => { const key = getDateKey(selectedDate); updateHistoryData({ ...historyData, [key]: editData }); setIsModalOpen(false); };
            
            const handleSaveAndQuote = () => {
                handleSave();
                if (onMoveToQuotes) onMoveToQuotes(editData.note);
            };

            const handleDeleteEvent = (e, date) => {
                e.stopPropagation();
                if (!window.confirm("イベントを削除しますか？")) return;
                const key = getDateKey(date);
                const current = historyData[key];
                if (current) {
                    const newData = { ...historyData, [key]: { ...current, event: '' } };
                    updateHistoryData(newData);
                }
            };

            const handleExportMD = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                let md = `# 投資日記レポート：${year}年${month}月度\n`;
                md += `（月間の総合計収支：${stats.currentMonthTotal > 0 ? '+' : ''}${stats.currentMonthTotal.toLocaleString()}円）\n\n`;
                const sortedKeys = Object.keys(historyData).filter(k => k.startsWith(getMonthKey(currentDate))).sort();
                sortedKeys.forEach(key => {
                    const d = historyData[key];
                    const total = (d.stocks || 0) + (d.margin || 0) + (d.foreign || 0) + (d.cfd || 0);
                    if (total === 0 && !d.note && !d.event) return;
                    md += `## ${key} ${d.event ? `(${d.event})` : ''}\n### 収支データ\n- 現物: ${d.stocks || 0} / 信用: ${d.margin || 0} / 米国: ${d.foreign || 0} / CFD: ${d.cfd || 0}\n### 振り返り\n${d.note || '（記載なし）'}\n\n`;
                });
                const blob = new Blob([md], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `investment_diary_${year}_${month}.md`;
                a.click();
                setIsMenuOpen(false); // メニュー閉じる
            };

            const handleExportCSV = () => {
                const backupData = { history: historyData, links: customLinks, quotes: quotes };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `market_dashboard_full_backup.json`;
                a.click();
                setIsMenuOpen(false); // メニュー閉じる
            };

            const DayCell = ({ date }) => {
                if (!date) return <div className="cal-cell bg-slate-50"></div>;
                const key = getDateKey(date);
                const data = historyData[key];
                const hasNote = data && data.note && data.note.trim().length > 0;
                const hasEvent = data && data.event && data.event.trim().length > 0;
                const isImportant = data && data.important;
                const isToday = getDateKey(new Date()) === key;

                let tooltipContent = null;
                if (data && data.details && data.details.length > 0) {
                    tooltipContent = (
                        <div className="stock-tooltip">
                            <div className="font-bold border-b border-slate-200 pb-1 mb-1 text-slate-600 bg-slate-50 -m-2 mb-1 p-2 rounded-t-lg">損益内訳 (CSV集計)</div>
                            <div className="max-h-[250px] overflow-y-auto">
                                {data.details.map((d, i) => (
                                    <div key={i} className="flex justify-between items-center py-1 border-b border-slate-50 last:border-0 hover:bg-slate-50 group/item">
                                        <div className="flex-1 min-w-0">
                                            <span className="truncate block text-slate-600 font-medium" title={d.name}>{d.name}</span>
                                        </div>
                                        <div className="flex items-center gap-2 pl-2">
                                            <span className={`text-[10px] font-mono ${d.amount >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]'}`}>{formatMoney(d.amount)}</span>
                                            <button onClick={(e) => handleDeleteDetail(key, i, e)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover/item:opacity-100 transition-opacity p-0.5">
                                                <Icon name="X" size={12} />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    );
                }

                const StatCard = ({ type, val }) => (
                    <div className={`flex justify-end items-center px-1.5 py-0.5 rounded text-[10px] font-medium mb-0.5 ${CATEGORY_STYLES[type].bg} ${CATEGORY_STYLES[type].text}`}>
                        <span className={`w-full text-right ${type === 'cfd' ? (val >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]') : (val < 0 ? 'text-[#FF4081]' : '')}`}>{formatMoney(val)}</span>
                    </div>
                );

                return (
                    <div onClick={() => openModal(date)} className={`cal-cell cursor-pointer hover:bg-[#F3E5F5] transition-colors border-r border-b border-slate-100 group ${isToday ? 'bg-[#F3E5F5]/30 ring-2 ring-inset ring-[#7C4DFF]/20' : ''}`}>
                        {tooltipContent}
                        <div className="flex justify-center items-center mb-1 relative">
                            <span className={`text-xs font-bold ${isToday ? 'bg-[#7C4DFF] text-white px-1.5 py-0.5 rounded-full' : 'text-slate-500'}`}>{date.getDate()}</span>
                            {hasNote && <Icon name="FileText" size={10} className={`absolute right-0 top-0.5 ${isImportant ? "text-[#7C4DFF]" : "text-[#64748B]"}`} style={isImportant ? {fill: "#7C4DFF"} : {}} />}
                        </div>
                        <div className="flex flex-col gap-0.5">
                            {hasEvent ? (
                                <div className="group/event relative flex justify-between items-center px-1.5 py-1 rounded text-[10px] font-bold mb-1 bg-white border-l-4 border-[#7C4DFF] shadow-sm text-[#7C4DFF]">
                                    <span className="truncate">{data.event}</span>
                                    <div className="absolute right-1 top-1/2 -translate-y-1/2 hidden group-hover/event:flex gap-1 bg-white pl-1">
                                        <button onClick={(e) => { e.stopPropagation(); openModal(date); }} className="hover:text-[#7C4DFF]"><Icon name="Pencil" size={10} /></button>
                                        <button onClick={(e) => handleDeleteEvent(e, date)} className="hover:text-[#FF4081]"><Icon name="X" size={10} /></button>
                                    </div>
                                </div>
                            ) : (<div className="h-[22px] mb-1"></div>)}
                            {data ? (
                                <>
                                    <StatCard type="stocks" val={data.stocks || 0} />
                                    <StatCard type="margin" val={data.margin || 0} />
                                    <StatCard type="foreign" val={data.foreign || 0} />
                                    <StatCard type="cfd" val={data.cfd || 0} />
                                </>
                            ) : (
                                <><div className="h-[18px]"></div><div className="h-[18px]"></div><div className="h-[18px]"></div><div className="h-[18px]"></div></>
                            )}
                        </div>
                    </div>
                );
            };

            const StatBox = ({ title, amount, mobileOrder }) => (
                <div className={`bg-white rounded-xl p-4 border border-slate-200 shadow-sm flex flex-col justify-center h-20 stat-box-mobile md:min-w-[240px] snap-center ${mobileOrder}`}>
                    <p className="text-[#64748B] text-xs font-medium mb-1">{title}</p>
                    <h3 className={`text-2xl font-bold ${amount >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]'}`}>
                        {amount >= 0 ? '+' : ''}{amount.toLocaleString()}
                    </h3>
                </div>
            );

            return (
                <div className="space-y-6 mb-12">
                    <div className="flex md:grid md:grid-cols-3 gap-4 animate-fade-in-up overflow-x-auto snap-x pb-2 md:pb-0">
                        <StatBox title={`今年の収益 (${currentDate.getFullYear()}年)`} amount={stats.currentYearTotal} mobileOrder="order-2 md:order-1" />
                        <StatBox title={`先月の収益 (${stats.prevMonthDate.getFullYear()}年${stats.prevMonthDate.getMonth() + 1}月)`} amount={stats.prevMonthTotal} mobileOrder="order-3 md:order-2" />
                        <StatBox title={`今月の収益 (${currentDate.getFullYear()}年${currentDate.getMonth() + 1}月)`} amount={stats.currentMonthTotal} mobileOrder="order-1 md:order-3" />
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-visible animate-fade-in-up">
                        <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                            <div className="flex items-center gap-4"><h2 className="text-sm md:text-xl font-bold text-[#334155] flex items-center gap-2"><Icon name="Calendar" size={20} />{currentDate.getFullYear()}年 {currentDate.getMonth() + 1}月</h2><div className="flex gap-1"><button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-1 hover:bg-white hover:shadow rounded text-slate-500"><Icon name="ChevronLeft" size={20} /></button><button onClick={() => setCurrentDate(new Date())} className="px-2 py-1 text-xs font-bold text-slate-600 hover:bg-white hover:shadow rounded">Today</button><button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-1 hover:bg-white hover:shadow rounded text-slate-500"><Icon name="ChevronRight" size={20} /></button></div></div>
                            <div className="flex gap-2 relative">
                                {/* 検索フォーム */}
                                <div className="relative">
                                    <div className={`flex items-center gap-1 border rounded px-2 py-1.5 bg-white transition-all shadow-sm ${isSearchFocused ? 'border-[#7C4DFF] w-64' : 'border-slate-300 w-32 md:w-48'}`}>
                                        <Icon name="Search" size={14} className="text-slate-400" />
                                        <input 
                                            type="text" 
                                            placeholder="日記を検索..." 
                                            value={searchQuery}
                                            onChange={(e) => setSearchQuery(e.target.value)}
                                            onFocus={() => setIsSearchFocused(true)}
                                            className="w-full text-xs outline-none bg-transparent"
                                        />
                                        {searchQuery && <button onClick={() => setSearchQuery('')} className="text-slate-400 hover:text-slate-600"><Icon name="X" size={12} /></button>}
                                    </div>
                                    {searchQuery && (
                                        <div className="search-results-dropdown">
                                            {searchResults.length === 0 ? (
                                                <div className="p-3 text-xs text-slate-500 text-center">一致するデータはありません</div>
                                            ) : (
                                                <ul>
                                                    {searchResults.map((res) => (
                                                        <li key={res.date} onClick={() => openModal(res.date)} className="p-2 border-b border-slate-100 hover:bg-purple-50 cursor-pointer flex flex-col gap-1">
                                                            <div className="flex justify-between items-center">
                                                                <span className="text-xs font-bold text-[#7C4DFF]">{res.date}</span>
                                                                {res.event && <span className="text-[10px] bg-slate-100 px-1 rounded text-slate-600 truncate max-w-[100px]">{res.event}</span>}
                                                            </div>
                                                            {res.note && <div className="text-xs text-slate-500 truncate">{res.note.replace(/[#\-*]/g, '').trim()}</div>}
                                                        </li>
                                                    ))}
                                                </ul>
                                            )}
                                        </div>
                                    )}
                                </div>
                                
                                {/* 修正: 統合された設定メニュー */}
                                <div className="relative">
                                    <button 
                                        onClick={() => setIsMenuOpen(!isMenuOpen)} 
                                        className={`w-8 h-8 flex items-center justify-center rounded-lg border transition-colors ${isMenuOpen ? 'bg-purple-50 border-[#7C4DFF] text-[#7C4DFF]' : 'bg-white border-slate-300 text-slate-600 hover:bg-slate-50'}`}
                                        title="設定・メニュー"
                                    >
                                        <Icon name="Settings" size={18} />
                                    </button>
                                    
                                    {isMenuOpen && (
                                        <div className="absolute right-0 mt-2 w-56 bg-white border border-slate-200 rounded-xl shadow-xl z-50 py-1 animate-fade-in-up overflow-hidden">
                                            <div className="px-3 py-2 border-b border-slate-100 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Actions</div>
                                            
                                            <button onClick={() => { setIsMenuOpen(false); setIsImportModalOpen(true); }} className="w-full text-left px-4 py-2.5 text-xs hover:bg-purple-50 flex items-center gap-3 text-slate-600 transition-colors">
                                                <div className="w-5 h-5 rounded-full bg-blue-50 flex items-center justify-center text-blue-500"><Icon name="FileUp" size={12} /></div>
                                                インポート (CSV/JSON)
                                            </button>
                                            
                                            <button onClick={() => { handleExportMD(); }} className="w-full text-left px-4 py-2.5 text-xs hover:bg-purple-50 flex items-center gap-3 text-slate-600 transition-colors">
                                                <div className="w-5 h-5 rounded-full bg-green-50 flex items-center justify-center text-green-500"><Icon name="FileText" size={12} /></div>
                                                MD表記出力 (レポート)
                                            </button>
                                            
                                            <button onClick={() => { handleExportCSV(); }} className="w-full text-left px-4 py-2.5 text-xs hover:bg-purple-50 flex items-center gap-3 text-slate-600 transition-colors">
                                                <div className="w-5 h-5 rounded-full bg-orange-50 flex items-center justify-center text-orange-500"><Icon name="Database" size={12} /></div>
                                                バックアップ (JSON)
                                            </button>
                                            
                                            <div className="my-1 border-t border-slate-100"></div>
                                            
                                            <button onClick={() => { setIsMenuOpen(false); setIsSettingsOpen(true); }} className="w-full text-left px-4 py-2.5 text-xs hover:bg-purple-50 flex items-center gap-3 text-slate-600 transition-colors">
                                                <div className="w-5 h-5 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><Icon name="Settings" size={12} /></div>
                                                同期設定 (GitHub)
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="cal-grid"><div className="cal-header">Category</div>{['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].map(d => <div key={d} className="cal-header">{d}</div>)}<div className="cal-header">週計</div>{calendarWeeks.map((week, wIdx) => { const weekTotal = week.reduce((acc, d) => { if (!d) return acc; const dat = historyData[getDateKey(d)]; if (!dat) return acc; return { s: acc.s + (dat.stocks || 0), m: acc.m + (dat.margin || 0), f: acc.f + (dat.foreign || 0), c: acc.c + (dat.cfd || 0) }; }, { s: 0, m: 0, f: 0, c: 0 }); const wSum = weekTotal.s + weekTotal.m + weekTotal.f + weekTotal.c; return (<React.Fragment key={wIdx}><div className="cal-label-col border-r border-b border-slate-100"><div className="h-[26px] mb-1"></div>{Object.entries(CATEGORY_STYLES).filter(([k]) => k !== 'event').map(([key, style]) => (<div key={key} className={`text-[10px] font-bold text-center py-0.5 rounded ${style.bg} ${style.text}`}>{style.label}</div>))}</div>{week.slice(1, 6).map((date, dIdx) => (<DayCell key={dIdx} date={date} />))}<div className="cal-total-col border-b border-slate-100 bg-slate-50"><div className="flex flex-col gap-0.5 w-full text-xs"><div className="h-[26px] mb-1"></div><div className={`text-right h-[18px] flex items-center justify-end ${weekTotal.s > 0 ? 'text-[#7C4DFF]' : weekTotal.s < 0 ? 'text-[#FF4081]' : 'text-slate-300'}`}>{formatMoney(weekTotal.s)}</div><div className={`text-right h-[18px] flex items-center justify-end ${weekTotal.m > 0 ? 'text-[#7C4DFF]' : weekTotal.m < 0 ? 'text-[#FF4081]' : 'text-slate-300'}`}>{formatMoney(weekTotal.m)}</div><div className={`text-right h-[18px] flex items-center justify-end ${weekTotal.f > 0 ? 'text-[#7C4DFF]' : weekTotal.f < 0 ? 'text-[#FF4081]' : 'text-slate-300'}`}>{formatMoney(weekTotal.f)}</div><div className={`text-right h-[18px] flex items-center justify-end ${weekTotal.c > 0 ? 'text-[#7C4DFF]' : weekTotal.c < 0 ? 'text-[#FF4081]' : 'text-slate-300'}`}>{formatMoney(weekTotal.c)}</div><div className={`mt-1 pt-1 border-t border-slate-200 font-bold text-right ${wSum < 0 ? 'text-[#FF4081]' : 'text-[#7C4DFF]'}`}>{formatMoney(wSum)}</div></div></div></React.Fragment>); })}</div>
                    </div>

                    {/* Chart */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-2 md:p-6 animate-fade-in-up">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                            <h3 className="text-lg font-bold text-[#334155] flex items-center gap-2">
                                <Icon name="BarChart3" size={20} className="text-[#7C4DFF]" />
                                {chartMode === 'daily' ? (
                                    <>
                                        <span className="hidden md:inline">月間日次推移 ({currentDate.getFullYear()}年{currentDate.getMonth() + 1}月)</span>
                                        <span className="md:hidden">{currentDate.getFullYear()}年 {currentDate.getMonth() + 1}月</span>
                                    </>
                                ) : (
                                    <>
                                        <span className="hidden md:inline">年間月次推移 ({currentDate.getFullYear()}年)</span>
                                        <span className="md:hidden">{currentDate.getFullYear()}年 月別</span>
                                    </>
                                )}
                                <div className="flex items-center gap-1 ml-4 text-sm text-slate-500 font-normal">
                                    <button onClick={() => setChartMode(chartMode === 'daily' ? 'yearly' : 'daily')} className="px-2 py-1 text-xs font-bold text-[#7C4DFF] border border-[#7C4DFF] rounded hover:bg-purple-50 transition-colors">
                                        {chartMode === 'daily' ? '年次へ' : '月次へ'}
                                    </button>
                                </div>
                            </h3>
                            {chartMode === 'daily' && (
                                <div className="flex flex-wrap items-baseline gap-3 justify-end text-sm w-full md:w-auto">
                                    <span className={`text-xs font-bold ${stats.currentMonthBreakdown.s >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]'}`}>現物:{stats.currentMonthBreakdown.s.toLocaleString()}</span>
                                    <span className={`text-xs font-bold ${stats.currentMonthBreakdown.m >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]'}`}>信用:{stats.currentMonthBreakdown.m.toLocaleString()}</span>
                                    <span className={`text-xs font-bold ${stats.currentMonthBreakdown.f >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]'}`}>米国:{stats.currentMonthBreakdown.f.toLocaleString()}</span>
                                    <span className={`text-xs font-bold ${stats.currentMonthBreakdown.c >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]'}`}>CFD:{stats.currentMonthBreakdown.c.toLocaleString()}</span>
                                    <span className={`text-xl font-bold ml-2 ${stats.currentMonthTotal >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]'}`}>{stats.currentMonthTotal > 0 ? '+' : ''}{stats.currentMonthTotal.toLocaleString()}</span>
                                </div>
                            )}
                        </div>
                        <div className="h-64 w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={dailyChartData} margin={{ top: 5, right: 30, left: -10, bottom: 5 }} barCategoryGap="40%">
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                    <XAxis dataKey={chartMode === 'daily' ? "day" : "name"} tickLine={false} axisLine={false} tick={<CustomAxisTick />} />
                                    <YAxis tickFormatter={(val) => `${(val / 10000).toFixed(0)}万`} tickLine={false} axisLine={false} tick={{ fill: '#64748b', fontSize: 12 }} width={40} />
                                    <Tooltip cursor={{ fill: '#f1f5f9' }} formatter={(val) => [`¥${val.toLocaleString()}`, "損益"]} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                    <ReferenceLine y={0} stroke="#94a3b8" />
                                    <Bar dataKey="total" radius={[4, 4, 0, 0]}>
                                        {dailyChartData.map((entry, index) => (<Cell key={`cell-${index}`} fill={entry.total >= 0 ? '#7C4DFF' : '#FF4081'} />))}
                                    </Bar>
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>

                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in-up" onClick={(e) => { if (e.target === e.currentTarget) setIsModalOpen(false); }}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[85vh] flex flex-col overflow-hidden">
<div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
<h3 className="font-bold text-lg text-[#334155] flex items-center gap-2">
<Icon name="FileText" size={20} />{selectedDate.getFullYear()}年{selectedDate.getMonth() + 1}月{selectedDate.getDate()}日
</h3>
<button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600"><Icon name="X" /></button>
</div>
                            <div className="flex border-b border-slate-200 lg:hidden">
                                <button onClick={() => setMobileModalTab('diary')} className={`flex-1 py-3 text-sm font-bold border-b-2 ${mobileModalTab === 'diary' ? 'border-[#7C4DFF] text-[#7C4DFF]' : 'border-transparent text-slate-500'}`}>日記 (Diary)</button>
                                <button onClick={() => setMobileModalTab('inputs')} className={`flex-1 py-3 text-sm font-bold border-b-2 ${mobileModalTab === 'inputs' ? 'border-[#7C4DFF] text-[#7C4DFF]' : 'border-transparent text-slate-500'}`}>収支入力</button>
                            </div>

                            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
                                <div className={`w-full lg:w-1/4 p-6 border-r border-slate-200 bg-slate-50/50 overflow-y-auto shrink-0 ${mobileModalTab === 'inputs' ? 'block' : 'hidden'} lg:block`}>
                                    <div className="mb-6"><label className="block text-xs font-bold text-[#7C4DFF] mb-1 uppercase">Event (Top Layer)</label><input type="text" placeholder="決算, FRB会合, etc." value={editData.event || ''} onChange={(e) => setEditData({ ...editData, event: e.target.value })} className="w-full border border-purple-200 rounded p-2 text-sm focus:ring-2 focus:ring-[#7C4DFF] outline-none" /></div>
                                    <h4 className="text-sm font-bold text-[#64748B] uppercase mb-4">収支入力 (円)</h4>
                                    <div className="space-y-4">{[{ k: 'stocks', l: '現物収支' }, { k: 'margin', l: '信用収支' }, { k: 'foreign', l: '米国株収支' }, { k: 'cfd', l: 'CFD/先物' }].map(f => (<div key={f.k}><label className="block text-xs font-bold text-slate-500 mb-1">{f.l}</label><input type="number" value={editData[f.k] || ''} onChange={(e) => setEditData({ ...editData, [f.k]: parseInt(e.target.value) || 0 })} className="w-full border border-slate-300 rounded p-2 font-mono text-right focus:ring-2 focus:ring-[#7C4DFF] outline-none" /></div>))}
                                        <div className="pt-4 border-t border-slate-200 mt-4"><div className="flex justify-between items-center"><span className="font-bold text-slate-700">合計</span><span className={`text-xl font-bold font-mono ${(editData.stocks + editData.margin + editData.foreign + editData.cfd) >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]'}`}>{formatMoney(editData.stocks + editData.margin + editData.foreign + editData.cfd)}</span></div></div>
                                        {editData.details && editData.details.length > 0 && (
                                            <div className="mt-6 pt-4 border-t border-slate-200">
                                                <h4 className="text-xs font-bold text-slate-500 mb-2">銘柄別損益 (CSV集計)</h4>
                                                <div className="bg-white border border-slate-200 rounded p-2 space-y-1 text-xs max-h-40 overflow-y-auto">
                                                    {editData.details.map((d, i) => (
                                                        <div key={i} className="flex justify-between items-center py-1 border-b border-slate-50 last:border-0 hover:bg-slate-50 group/item" title={d.name}>
                                                            <span className="text-slate-600 truncate flex-1">{d.name}</span>
                                                            <div className="flex items-center gap-2 pl-2">
                                                                <span className={`font-mono ${d.amount >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]'}`}>{formatMoney(d.amount)}</span>
                                                                <button onClick={(e) => handleDeleteDetail(getDateKey(selectedDate), i, e)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover/item:opacity-100 transition-opacity p-0.5">
                                                                    <Icon name="X" size={12} />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                <div className={`flex-1 bg-white overflow-hidden p-2 lg:p-6 flex-col ${mobileModalTab === 'diary' ? 'flex' : 'hidden'} lg:flex`}>
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="flex items-center gap-2">
                                            <Icon name="Pencil" size={14} className="text-slate-500" />
                                            <span className="text-xs font-bold text-slate-500 uppercase">Investment Diary (Markdown)</span>
                                        </div>
                                        <button 
                                            onClick={() => setEditData({ ...editData, important: !editData.important })}
                                            className={`p-1.5 rounded-lg border transition-colors ${editData.important ? 'bg-purple-100 border-[#7C4DFF] text-[#7C4DFF]' : 'bg-white border-slate-200 text-slate-300 hover:text-slate-500'}`}
                                            title="Mark as Important"
                                        >
                                            <Icon name="Bookmark" size={16} fill={editData.important ? "#7C4DFF" : "none"} />
                                        </button>
                                    </div>
                                    {/* uploadConfigを追加, onSaveを追加 */}
                                    <div className="flex-1 overflow-hidden relative"><EasyMDEEditor value={editData.note} onChange={(val) => setEditData({ ...editData, note: val })} uploadConfig={uploadConfig} onSave={handleSave} /></div>
                                    
                                    {/* YouTubeサムネイル表示エリア */}
                                    {youtubeThumbnails.length > 0 && (
                                        <div className="flex gap-2 mt-2 pt-2 border-t border-slate-100 overflow-x-auto h-[90px] shrink-0 custom-scrollbar">
                                            {youtubeThumbnails.map((id, idx) => (
                                                <div 
                                                    key={idx} 
                                                    className="relative cursor-pointer group shrink-0 aspect-video h-full rounded-md overflow-hidden bg-black"
                                                    onClick={() => window.open(`https://www.youtube.com/watch?v=${id}`, '_blank')}
                                                >
                                                    <img src={`https://img.youtube.com/vi/${id}/mqdefault.jpg`} alt="Thumbnail" className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" />
                                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                                        <div className="bg-black/50 p-1 rounded-full"><div className="w-0 h-0 border-t-[4px] border-t-transparent border-l-[8px] border-l-white border-b-[4px] border-b-transparent ml-0.5"></div></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="p-4 border-t border-slate-200 bg-slate-50 flex justify-end gap-3 shrink-0">
                                <button onClick={handleSaveAndQuote} className="px-4 py-2 bg-slate-100 text-[#7C4DFF] border border-[#7C4DFF] hover:bg-purple-50 rounded-lg text-xs md:text-sm font-bold flex items-center gap-2 transition-colors">
                                    <Icon name="Send" size={16} className="hidden md:inline" /> 
                                    <span className="md:hidden">格言</span>
                                    <span className="hidden md:inline">格言行き</span>
                                </button>
                                <button onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg text-xs md:text-sm font-bold transition-colors">キャンセル</button>
                                <button onClick={handleSave} className="px-6 py-2 bg-[#7C4DFF] text-white hover:bg-[#651FFF] rounded-lg text-xs md:text-sm font-bold flex items-center gap-2 transition-colors">
                                    <Icon name="Check" size={16} className="hidden md:inline" /> 
                                    保存
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                {isSettingsOpen && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in-up" onClick={(e) => { if (e.target === e.currentTarget) setIsSettingsOpen(false); }}>
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
                            <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                                <h3 className="font-bold text-lg text-[#334155] flex items-center gap-2"><Icon name="Settings" size={20} /> 設定 (Sync & Upload)</h3>
                                <button onClick={() => setIsSettingsOpen(false)} className="text-slate-400 hover:text-slate-600"><Icon name="X" /></button>
                            </div>
                            <div className="p-6 space-y-4">
                                <p className="text-xs text-slate-500">GitHubを利用してデータの同期と画像のアップロードを行います。<br/>画像UPにはリポジトリの読み書き権限(repo scope)が必要です。</p>
                                <div>
                                    <label className="block text-xs font-bold text-slate-700 mb-1">GitHub Token (repo scope推奨)</label>
                                    <input type="password" value={gistToken} onChange={(e) => setGistToken(e.target.value)} className="w-full border border-slate-300 rounded p-2 text-sm outline-none focus:border-[#7C4DFF]" placeholder="ghp_..." />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-700 mb-1">Gist ID (Sync用)</label>
                                    <input type="text" value={gistId} onChange={(e) => setGistId(e.target.value)} className="w-full border border-slate-300 rounded p-2 text-sm outline-none focus:border-[#7C4DFF]" placeholder="32桁のID" />
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-700 mb-1">Repo Owner</label>
                                        <input type="text" value={repoOwner} onChange={(e) => setRepoOwner(e.target.value)} className="w-full border border-slate-300 rounded p-2 text-sm outline-none focus:border-[#7C4DFF]" placeholder="UserName" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-700 mb-1">Repo Name</label>
                                        <input type="text" value={repoName} onChange={(e) => setRepoName(e.target.value)} className="w-full border border-slate-300 rounded p-2 text-sm outline-none focus:border-[#7C4DFF]" placeholder="RepoName" />
                                    </div>
                                </div>
                                <div className="pt-2 flex justify-end">
                                    <button onClick={handleSaveSettings} className="bg-[#7C4DFF] text-white px-4 py-2 rounded text-sm font-bold hover:bg-[#651FFF]">保存</button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                {isImportModalOpen && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in-up" onClick={(e) => { if (e.target === e.currentTarget) setIsImportModalOpen(false); }}><div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden"><div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50"><h3 className="font-bold text-lg text-[#334155] flex items-center gap-2"><Icon name="FileUp" size={20} /> データインポート</h3><button onClick={() => setIsImportModalOpen(false)} className="text-slate-400 hover:text-slate-600"><Icon name="X" /></button></div><div className="p-6 flex flex-col md:flex-row gap-6"><div className="flex-1 border-r border-slate-200 pr-6"><h4 className="text-sm font-bold text-[#334155] mb-2 flex items-center gap-2"><Icon name="Database" size={16} /> システムデータ復元</h4><p className="text-xs text-slate-500 mb-4">JSONバックアップを読み込みます。</p><button onClick={() => setImportCategory('backup')} className={`w-full py-3 px-3 rounded text-sm font-bold border transition-all flex items-center justify-between mb-4 ${importCategory === 'backup' ? `bg-[#7C4DFF] text-white border-[#7C4DFF]` : `bg-white text-slate-500 border-slate-200 hover:bg-slate-50`}`}><span>完全バックアップ (JSON)</span>{importCategory === 'backup' && <Icon name="Check" size={14} />}</button></div><div className="flex-1"><h4 className="text-sm font-bold text-[#334155] mb-2 flex items-center gap-2"><Icon name="FileCsv" size={16} /> 証券データ取込</h4><p className="text-xs text-slate-500 mb-4">証券CSVを読み込みます。</p><div className="grid grid-cols-1 gap-2 mb-4">{Object.entries(CATEGORY_STYLES).filter(([k]) => k !== 'event').map(([key, style]) => (<button key={key} onClick={() => setImportCategory(key)} className={`py-2 px-3 rounded text-sm font-bold border transition-all flex items-center justify-between ${importCategory === key ? `bg-[#7C4DFF] text-white border-[#7C4DFF]` : `bg-white text-slate-500 border-slate-200 hover:bg-slate-50`}`}><span>{style.label}</span>{importCategory === key && <Icon name="Check" size={14} />}</button>))}</div></div></div><div className="px-6 pb-6"><div className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors relative ${dragActive ? 'border-[#7C4DFF] bg-purple-50' : 'border-slate-300 hover:bg-slate-50'}`} onDragEnter={handleDrag} onDragLeave={handleDrag} onDragOver={handleDrag} onDrop={handleDrop}><Icon name="Upload" className="mx-auto text-slate-400 mb-2" size={32} /><p className="text-slate-600 font-bold mb-1">ファイルをここにドラッグ</p><input type="file" accept=".csv,.json" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onChange={(e) => e.target.files && handleFileImport(e.target.files[0])} /></div></div></div></div>)}
            </div>
        );
    };

    const ParticipantVolume = () => { const [data, setData] = useState(null); const [session, setSession] = useState('night'); const [loading, setLoading] = useState(true); useEffect(() => { const fetchData = async () => { try { const res = await fetch('./data/daily_participant.json'); if (res.ok) { const json = await res.json(); setData(json); } } catch (e) { console.error(e); } finally { setLoading(false); } }; fetchData(); }, []); if (loading) return <div className="p-8 text-center text-slate-500">データを読み込み中...</div>; if (!data) return <div className="p-8 text-center text-red-500 bg-red-50 rounded-lg">最新の手口データが見つかりませんでした。<br />平日20時以降に更新されます。</div>; const targetData = session === 'night' ? data.night_session : data.day_session; const sessionLabel = session === 'night' ? 'ナイト・セッション (立会)' : '日中取引 (立会)'; const categoryColors = { 'US': 'bg-blue-100 text-blue-800 border-blue-200', 'EU': 'bg-green-100 text-green-800 border-green-200', 'JP': 'bg-orange-100 text-orange-800 border-orange-200', 'NET': 'bg-purple-100 text-purple-800 border-purple-200', 'OTHERS': 'bg-slate-100 text-slate-800 border-slate-200' }; const grouped = targetData.reduce((acc, item) => { const cat = item.category || 'OTHERS'; if (!acc[cat]) acc[cat] = []; acc[cat].push(item); return acc; }, {}); const categories = ['US', 'EU', 'JP', 'NET', 'OTHERS']; return (<div className="space-y-6"><div className="unified-header-card"><div className="unified-header-title"><Icon name="Briefcase" size={28} /> 取引参加者別取引高</div><p className="unified-header-sub">データ日付: {data.date}</p></div><div className="flex space-x-2 bg-white p-2 rounded-lg shadow-sm border border-slate-200 w-fit"><button onClick={() => setSession('night')} className={`px-4 py-2 rounded-md text-sm font-bold transition-all ${session === 'night' ? 'bg-[#7C4DFF] text-white shadow' : 'text-[#64748B] hover:bg-slate-100'}`}>🌙 ナイト・セッション</button><button onClick={() => setSession('day')} className={`px-4 py-2 rounded-md text-sm font-bold transition-all ${session === 'day' ? 'bg-[#7C4DFF] text-white shadow' : 'text-[#64748B] hover:bg-slate-100'}`}>☀️ 日中取引</button></div><div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in-up"><h2 className="text-xl font-bold text-slate-800 mb-4">{sessionLabel}</h2>{targetData.length === 0 ? (<p className="text-slate-500">このセッションのデータはありません。</p>) : (<div className="space-y-8">{categories.map(cat => { if (!grouped[cat]) return null; return (<div key={cat} className="border border-slate-200 rounded-lg overflow-hidden"><div className={`px-4 py-2 font-bold text-sm border-b ${categoryColors[cat]}`}>{cat === 'US' && '🇺🇸 米系証券'}{cat === 'EU' && '🇪🇺 欧州系証券'}{cat === 'JP' && '🇯🇵 日系証券'}{cat === 'NET' && '🌐 ネット証券'}{cat === 'OTHERS' && 'その他'}</div><div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-5 text-slate-500 border-b border-slate-200"><tr><th className="px-4 py-2 w-48">証券会社</th>{Object.keys(grouped[cat][0].data).map(key => (<th key={key} className="px-4 py-2 text-right whitespace-nowrap">{key}</th>))}</tr></thead><tbody className="divide-y divide-slate-100">{grouped[cat].map((item, idx) => (<tr key={idx} className="hover:bg-slate-50"><td className="px-4 py-2 font-medium text-slate-700">{item.name}</td>{Object.entries(item.data).map(([k, val], i) => (<td key={i} className="px-4 py-2 text-right font-mono">{val.toLocaleString()}</td>))}</tr>))}</tbody></table></div></div>); })}</div>)}</div><div className="mt-4 text-right text-xs text-slate-400">※JPX公表のExcelファイルより自動取得・集計。単位: 枚 (または金額)。</div></div>); };

    const ForeignInvestors = () => {
        const chartRef = useRef(null); const chartInstance = useRef(null); const [allData, setAllData] = useState([]); const [currentTimeRange, setCurrentTimeRange] = useState('all'); const [stats, setStats] = useState(null); const [dataCount, setDataCount] = useState(0); const [lastUpdate, setLastUpdate] = useState('データ取得中...'); useEffect(() => { const canvas = chartRef.current; if (!canvas) return; const handleWheel = (e) => { if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) { e.preventDefault(); } }; canvas.addEventListener('wheel', handleWheel, { passive: false }); return () => canvas.removeEventListener('wheel', handleWheel); }, [allData]); const formatNumber = (num) => Math.round(num).toLocaleString('ja-JP'); const formatLargeNumber = (value) => { if (typeof value === 'number') { const sign = value >= 0 ? '+' : ''; return sign + formatNumber(value) + '億円'; } return value.toString(); }; const calculateWeekLabels = (data) => {
            const weekCounter = {}; return data.map(row => {
                const date = new Date(row.date); const year = date.getFullYear(); const month = date.getMonth() + 1; const yearMonthKey = `${year}-${month}`; if (!weekCounter[yearMonthKey]) weekCounter[yearMonthKey] = 1; else weekCounter[yearMonthKey]++; const weekNum = weekCounter[yearMonthKey]; return {
                    ...row, displayDate: `${year}年${month}月${weekNum}週`,
                    tooltipDate: `${year}年${month}月第${weekNum}週`};
            });
        }; const calculateStats = (data) => { const positiveData = data.filter(item => item.balance > 0).map(item => item.balance); const negativeData = data.filter(item => item.balance < 0).map(item => item.balance); const calcMedian = (arr) => { if (arr.length === 0) return 0; const sorted = [...arr].sort((a, b) => a - b); const mid = Math.floor(sorted.length / 2); return sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid]; }; const calcAverage = (arr) => arr.length === 0 ? 0 : arr.reduce((sum, val) => sum + val, 0) / arr.length; return { positiveAvg: calcAverage(positiveData), positiveMedian: calcMedian(positiveData), negativeAvg: calcAverage(negativeData), negativeMedian: calcMedian(negativeData), latest: data[data.length - 1] }; }; const getFormattedReleaseDate = (lastDateStr) => {
            try {
                const date = new Date(lastDateStr); if (isNaN(date.getTime())) return lastDateStr; const releaseDate = new Date(date); releaseDate.setDate(date.getDate() + 6); const y = releaseDate.getFullYear(); const m = String(releaseDate.getMonth() + 1).padStart(2, '0'); const d = String(releaseDate.getDate()).padStart(2, '0'); return `${y}-${m}-${d} 18:00`;
            } catch (e) { return lastDateStr; }
        }; const zoomChart = (direction) => { if (!chartInstance.current) return; chartInstance.current.zoom(direction === 'in' ? 1.2 : 0.8); updateStatsFromChart(); }; const panChart = (direction) => { if (!chartInstance.current) return; const chart = chartInstance.current; const range = chart.scales.x.max - chart.scales.x.min; chart.pan({ x: direction === 'left' ? range * 0.2 : -range * 0.2 }); updateStatsFromChart(); }; const resetZoom = () => { if (!chartInstance.current) return; chartInstance.current.resetZoom(); updateStatsFromChart(); }; const updateStatsFromChart = () => { if (!chartInstance.current) return; const chart = chartInstance.current; const xScale = chart.scales.x; const filtered = getFilteredData(allData, currentTimeRange); const startIndex = Math.max(0, Math.floor(xScale.min)); const endIndex = Math.min(filtered.length - 1, Math.ceil(xScale.max)); const visibleData = filtered.slice(startIndex, endIndex + 1); if (visibleData.length > 0) setStats(calculateStats(visibleData)); }; const getFilteredData = (data, range) => { if (range === 'all') return data; const now = new Date(); const cutoffDate = new Date(); if (range === '3m') cutoffDate.setMonth(now.getMonth() - 3); else if (range === '6m') cutoffDate.setMonth(now.getMonth() - 6); else if (range === '1y') cutoffDate.setFullYear(now.getFullYear() - 1); return data.filter(item => new Date(item.date) >= cutoffDate); }; const drawChart = (data) => {
            if (!chartRef.current) return; const ctx = chartRef.current.getContext('2d'); if (chartInstance.current) chartInstance.current.destroy(); const config = {
                type: 'bar', data: { datasets: [{ label: '差引（億円）', data: data.map((d, index) => ({ x: index, y: d.balance })), backgroundColor: (ctx) => (!ctx.parsed || ctx.parsed.y === undefined) ? 'rgba(124, 77, 255, 0.7)' : ctx.parsed.y >= 0 ? 'rgba(124, 77, 255, 0.7)' : 'rgba(255, 64, 129, 0.7)', borderColor: (ctx) => (!ctx.parsed || ctx.parsed.y === undefined) ? '#7C4DFF' : ctx.parsed.y >= 0 ? '#7C4DFF' : '#FF4081', borderWidth: 1, barPercentage: 0.9, categoryPercentage: 0.9 }] }, options: {
                    responsive: true, maintainAspectRatio: false, plugins: {
                        legend: { display: false }, tooltip: {
                            backgroundColor: 'white', titleColor: '#334155', bodyColor: '#334155', borderColor: '#e2e8f0', borderWidth: 1, padding: 12, displayColors: false, callbacks: {
                                title: (context) => data[Math.round(context[0].parsed.x)]?.tooltipDate || '', label: (context) => {
                                    const index = Math.round(context.parsed.x); if (index >= 0 && index < data.length) {
                                        const val = data[index].balance; const raw = data[index].rawBalance; const sign = val >= 0 ? '+' : ''; return `${sign}${formatNumber(val)}億円 (${sign}${(raw*1000).toLocaleString('ja-JP')}円)`;}return'';},afterLabel:(context)=>context.parsed.y>=0?'買い越し':'売り越し'}},zoom:{pan:{enabled:true,mode:'x',threshold:0},zoom:{wheel:{enabled:true,speed:0.1},pinch:{enabled:true},mode:'x',onZoomComplete:updateStatsFromChart}}},scales:{y:{ticks:{callback:(value,index,ticks)=>index===ticks.length-1?formatNumber(value)+'億円':formatNumber(value)},grid:{color:'#e2e8f0'}},x:{type:'linear',min:0,max:data.length-1,ticks:{callback:(value)=>data[Math.round(value)]?.displayDate||'',maxRotation:45,minRotation:45,autoSkip:true,maxTicksLimit:20},grid:{color:'#e2e8f0'}}}}};chartInstance.current=new Chart(ctx,config);};useEffect(()=>{const loadData=async()=>{try{const res=await fetch('history.csv');const text=res.ok?await res.text():null;if(!text)throw new Error("CSV load failed");Papa.parse(text,{header:true,dynamicTyping:true,skipEmptyLines:true,complete:(results)=>{const raw=results.data.filter(r=>r.date&&r.balance!=null).map(r=>({date:r.date,balance:r.balance/100000,rawBalance:r.balance})).sort((a,b)=>new Date(a.date)-new Date(b.date));const processed=calculateWeekLabels(raw);setAllData(processed);if(processed.length>0)setLastUpdate(`最終更新: ${getFormattedReleaseDate(processed[processed.length-1].date)}`);}}); }catch(e){console.error(e);setLastUpdate("データの読み込みに失敗しました");}};loadData();},[]);useEffect(()=>{if(allData.length===0)return;const filtered=getFilteredData(allData,currentTimeRange);setDataCount(filtered.length);drawChart(filtered);setStats(calculateStats(filtered));},[allData,currentTimeRange]);return(<div className="space-y-6"><div className="unified-header-card"><div className="unified-header-title"><Icon name="LineChart" size={28} /> JPX 海外投資家動向</div><p className="unified-header-sub">{lastUpdate}</p></div><div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6 animate-fade-in-up"><h2 className="text-xl font-bold text-slate-900 mb-4">差引推移 <span className="text-sm font-normal text-slate-500 ml-2">({dataCount}件のデータ)</span></h2><div style={{position:'relative',height:'500px'}}><canvas ref={chartRef}></canvas><div style={{position:'absolute',bottom:'90px',left:'80px',display:'flex',gap:'8px',zIndex:10}}><button onClick={()=>zoomChart('in')} className="px-3 py-2 bg-white/90 backdrop-blur text-slate-700 rounded-lg shadow-md hover:bg-white transition-colors text-sm font-medium border border-slate-300">＋</button><button onClick={()=>zoomChart('out')} className="px-3 py-2 bg-white/90 backdrop-blur text-slate-700 rounded-lg shadow-md hover:bg-white transition-colors text-sm font-medium border border-slate-300">ー</button></div><div style={{position:'absolute',bottom:'90px',right:'20px',display:'flex',gap:'8px',zIndex:10}}><button onClick={()=>panChart('left')} className="px-3 py-2 bg-white/90 backdrop-blur text-slate-700 rounded-lg shadow-md hover:bg-white transition-colors text-sm font-medium border border-slate-300">← 左へ</button><button onClick={()=>panChart('right')} className="px-3 py-2 bg-white/90 backdrop-blur text-slate-700 rounded-lg shadow-md hover:bg-white transition-colors text-sm font-medium border border-slate-300">右へ →</button></div></div></div>{stats&&( <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6 animate-fade-in-up">{[{label:'最新週（先週）の売買状況',value:stats.latest.balance,color:stats.latest.balance>=0?'text-[#7C4DFF]':'text-[#FF4081]',sub:stats.latest.balance>=0?'買い越し':'売り越し'},{label:'買い越し 平均',value:stats.positiveAvg,color:'text-[#7C4DFF]',sub:'表示範囲内'},{label:'買い越し 中央値',value:stats.positiveMedian,color:'text-[#7C4DFF]',sub:'表示範囲内'},{label:'売り越し 平均',value:stats.negativeAvg,color:'text-[#FF4081]',sub:'表示範囲内'},{label:'売り越し 中央値',value:stats.negativeMedian,color:'text-[#FF4081]',sub:'表示範囲内'},].map((s,i)=>(<div key={i} className="bg-white rounded-xl shadow-sm border border-slate-200 p-6"><p className="text-slate-600 text-sm font-medium mb-2">{s.label}</p><p className={`text-3xl font-bold ${s.color}`}>{formatLargeNumber(s.value)}</p><p className="text-slate-400 text-xs mt-1">{s.sub}</p></div>))}</div>)}<div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 animate-fade-in-up"><div className="flex flex-wrap gap-4 items-center"><div className="flex items-center gap-2"><span className="text-slate-600 text-sm font-medium">期間:</span><div className="flex gap-1">{[{v:'all',l:'全期間'},{v:'1y',l:'1年'},{v:'6m',l:'6ヶ月'},{v:'3m',l:'3ヶ月'}].map(opt=>(<button key={opt.v} onClick={()=>setCurrentTimeRange(opt.v)} className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${currentTimeRange===opt.v?'bg-[#7C4DFF] text-white':'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>{opt.l}</button>))}</div></div><button onClick={resetZoom} className="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition-colors text-sm font-medium">🔄 ズームリセット</button></div></div></div>);};

    // DataInput Component
    const DataInput = ({ onDataParsed }) => {
        const [text, setText] = useState('');
        const [dragActive, setDragActive] = useState(false);
        
        const handleTextParse = () => {
            if (!text) return;
            Papa.parse(text, {
                complete: (results) => onDataParsed(results.data),
                skipEmptyLines: true,
                header: false 
            });
        };

        const handleFile = (file) => {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => Papa.parse(event.target.result, { header: false, skipEmptyLines: true, complete: (res) => onDataParsed(res.data) });
            reader.readAsText(file);
        };

        const handleDrag = (e) => { e.preventDefault(); e.stopPropagation(); if (e.type === "dragenter" || e.type === "dragover") setDragActive(true); else if (e.type === "dragleave") setDragActive(false); };
        const handleDrop = (e) => { e.preventDefault(); e.stopPropagation(); setDragActive(false); if (e.dataTransfer.files && e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); };

        return (
            <div className="max-w-3xl mx-auto bg-white rounded-xl shadow border border-slate-200 p-6 flex flex-col gap-6 w-full">
                <div className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors relative ${dragActive ? 'border-[#7C4DFF] bg-purple-50' : 'border-slate-300 hover:bg-slate-50'}`} onDragEnter={handleDrag} onDragLeave={handleDrag} onDragOver={handleDrag} onDrop={handleDrop}>
                    <Icon name="Upload" className="mx-auto text-slate-400 mb-2" size={32} />
                    <p className="text-slate-600 font-bold mb-1">CSVファイルをドラッグ＆ドロップ</p>
                    <p className="text-xs text-slate-400 mb-4">または</p>
                    <input type="file" accept=".csv" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onChange={(e) => e.target.files && handleFile(e.target.files[0])} />
                    <span className="bg-[#7C4DFF] text-white px-4 py-2 rounded-lg hover:bg-[#651FFF] pointer-events-none inline-block text-sm font-bold">ファイルを選択</span>
                </div>
                <div className="flex gap-2 w-full">
                    <textarea 
                        className="flex-1 border border-slate-300 rounded-lg p-3 text-sm font-mono focus:ring-2 focus:ring-[#7C4DFF] outline-none min-h-[100px]"
                        rows={4}
                        placeholder="ここにデータを貼り付け..."
                        value={text}
                        onChange={(e) => setText(e.target.value)}
                    />
                    <button onClick={handleTextParse} disabled={!text} className="bg-slate-800 text-white px-4 rounded-lg hover:bg-slate-700 disabled:opacity-50 font-bold shrink-0">解析</button>
                </div>
            </div>
        );
    };

    // --- Investor Trends Component (NEW) ---
    const InvestorTrends = () => {
        const defaultData = `日付	日経平均	日経平均
変化(週)	海外	証券自己	個人	法人	法人(金融)
個人 計	個人
(現金)	個人
(信用)	投資信託	事業法人	その他
法人	信託銀行	生保
損保	都銀
地銀
2026/01/30	53,322.85	▼0.97%	+159,891	-819,655	+834,854	+471,539	+363,315	-91,760	+319,019	-39,728	-289,884	-15,927	-113,158
2026/01/23	53,846.87	▼0.17%	+192,161	-405,459	+479,204	+137,774	+341,430	+130,746	+175,747	-22,535	-424,920	-114,576	-49,223
2026/01/16	53,936.17	▲3.84%	+780,423	+374,992	-662,790	-674,710	+11,919	-45,570	+81,695	-49,475	-245,952	-125,679	-50,789
2026/01/09	51,939.89	▲3.18%	+1,224,694	-702,878	-542,835	-564,482	+21,647	-29,677	+168,637	-6,670	-7,793	-32,526	-30,669
2025/12/30	50,339.48	▼0.81%	-14,988	-196,135	+184,684	+2,914	+181,770	-17,774	+13,880	+13,646	+17,543	-290	-522
2025/12/26	50,750.39	▲2.51%	-21,033	+282,544	-385,293	-404,260	+18,967	+50,651	+16,598	+90,015	+30,765	-43,752	-7,391
2025/12/19	49,507.21	▼2.61%	-439,099	+249,210	+256,534	-26,355	+282,889	-77,501	+217,722	+46,025	-176,619	-60,412	-30,795
2025/12/12	50,836.55	▲0.68%	+189,792	-496,602	-250,281	-393,617	+143,335	+144,696	+231,203	+109,982	+129,372	-43,389	+7,610
2025/12/05	50,491.87	▲0.47%	+3,459	-344,974	+207,691	+2,377	+205,314	+169,903	+203,802	+45,550	-208,494	-82,891	-64,142
2025/11/28	50,253.91	▲3.35%	-116,267	+370,271	-452,833	-435,915	-16,918	+35,694	+167,386	+33,749	+23,635	-24,443	-21,753
2025/11/21	48,625.88	▼3.48%	-383,633	+322,466	+115,895	-36,803	+152,699	-124,650	+259,495	+30,670	-83,461	-59,955	-36,224
2025/11/14	50,376.53	▲0.20%	+514,770	+306,576	-236,619	-435,882	+199,263	-44,636	+192,361	+67,241	-539,765	-106,396	-88,394
2025/11/07	50,276.37	▼4.07%	-355,937	-750,638	+555,751	+97,061	+458,691	+261,322	+205,482	+13,931	+75,578	-30,306	-19,849
2025/10/31	52,411.34	▲6.31%	+345,942	-90,025	-187,683	-385,929	+198,246	-336,537	+167,367	+12,068	+138,835	-38,046	-20,375
2025/10/24	49,299.65	▲3.61%	+643,645	+58,420	-512,482	-536,907	+24,424	-116,556	+63,976	+25,989	-78,641	-49,689	-8,544
2025/10/17	47,582.15	▼1.05%	+153,284	-360,052	+343,116	+102,672	+240,444	-152,487	+131,397	+3,004	-10,911	-42,020	-72,622
2025/10/10	48,088.80	▲5.07%	+1,058,677	-77,644	-429,020	-640,366	+211,347	-36,365	+150,450	+25,646	-488,226	-78,875	-60,886
2025/10/03	45,769.50	▲0.91%	+1,239,848	-1,645,704	+422,263	+77,863	+344,400	+65,086	+122,709	+20,061	-213,666	-23,232	-36,396
2025/09/26	45,354.99	▲0.69%	-559,181	+1,115,848	+129,369	+128,620	+748	-276,016	-21,324	+38,840	-358,418	-90,502	-417
2025/09/19	45,045.81	▲0.62%	-294,384	+754,004	-32,665	-169,799	+137,135	-45,386	+182,480	+8,814	-531,015	-27,248	-16,519
2025/09/12	44,768.12	▲4.07%	-692,367	+1,259,599	-468,896	-425,246	-43,649	-104,917	+207,733	-17,323	-130,105	-44,590	-19,205
2025/09/05	43,018.75	▲0.70%	+131,446	-30,659	+165,783	-65,992	+231,775	-93,921	+325,300	-12,583	-422,062	-58,036	-12,481
2025/08/29	42,718.47	▲0.20%	-303,154	+269,149	+413,479	+145,323	+268,156	-213,870	+415,279	-94,240	-446,135	-58,902	-16,090
2025/08/22	42,633.29	▼1.72%	-198,867	+201,617	+150,198	-220,130	+370,328	-291,043	+237,443	+1,618	+1,295	-59,616	-41,724
2025/08/15	43,378.31	▲3.73%	+573,776	+736,083	-1,125,354	-1,018,633	-106,721	+9,971	+181,121	-23,030	-216,505	-39,562	-41,225
2025/08/08	41,820.48	▲2.50%	-5,334	+646,130	-578,058	-645,225	+67,167	-38,022	+246,021	-15,861	-116,562	-42,588	-53,093
2025/08/01	40,799.60	▼1.58%	-189,206	+223,919	+25,543	-189,123	+214,666	+58,939	+286,603	+1,977	-100,216	-282,071	-36,940
2025/07/25	41,456.23	▲4.11%	+602,395	+556,728	-1,219,052	-1,021,498	-197,554	-22,253	+94,604	+32,177	+38,585	-32,255	-22,974
2025/07/18	39,819.11	▲0.63%	+187,508	-390,766	-87,985	-215,409	+127,424	+58,475	+216,272	+12,853	+10,791	-42,083	-49,544
2025/07/11	39,569.68	▼0.61%	+403,085	-148,323	-66,547	-199,569	+133,022	-442,783	+228,086	+48,797	-35,304	-2,137	-27,560`;
        
        const [inputText, setInputText] = useState(defaultData);
        const [chartData, setChartData] = useState([]);

        useEffect(() => {
            parseData(inputText);
        }, []);

        const parseData = (text) => {
            if (!text.trim()) return;
            // 簡易的なパース処理: タブまたはスペース区切り
            // 日付(YYYY/MM/DD)で始まる行のみをデータとして扱う
            const lines = text.split('\n');
            const data = [];
            
            lines.forEach(line => {
                const parts = line.trim().split(/[\t\s]+/);
                if (parts.length > 5 && /^\d{4}\/\d{2}\/\d{2}$/.test(parts[0])) {
                    // 数値のクリーニング関数
                    const cleanNum = (str) => {
                        if (!str) return 0;
                        return parseInt(str.replace(/,/g, '').replace(/\+/g, ''), 10) || 0;
                    };

                    // 列定義に基づいてマッピング
                    // 0: 日付, 1: 日経平均, 2: 変化, 3: 海外, 4: 証券自己, 5: 個人
                    // 11: 投資信託, 12: 事業法人
                    data.push({
                        date: parts[0],
                        foreign: cleanNum(parts[3]),
                        proprietary: cleanNum(parts[4]),
                        individual: cleanNum(parts[5]),
                        trust: cleanNum(parts[11]),
                        business: cleanNum(parts[12])
                    });
                }
            });

            // 日付昇順にソート (古い -> 新しい)
            data.sort((a, b) => new Date(a.date) - new Date(b.date));

            // 累積値を計算して新しい配列を作成
            let cumForeign = 0;
            let cumProprietary = 0;
            let cumIndividual = 0;
            let cumTrust = 0;
            let cumBusiness = 0;

            const cumulativeData = data.map(item => {
                cumForeign += item.foreign;
                cumProprietary += item.proprietary;
                cumIndividual += item.individual;
                cumTrust += item.trust;
                cumBusiness += item.business;

                return {
                    ...item,
                    foreign: cumForeign,
                    proprietary: cumProprietary,
                    individual: cumIndividual,
                    trust: cumTrust,
                    business: cumBusiness,
                    // 元の週次データも保持（ツールチップ等で利用可能）
                    weekly_foreign: item.foreign,
                    weekly_proprietary: item.proprietary,
                    weekly_individual: item.individual,
                    weekly_trust: item.trust,
                    weekly_business: item.business
                };
            });

            setChartData(cumulativeData);
        };

        const handleParse = () => {
            parseData(inputText);
        };

        return (
            <div className="h-full flex flex-col pb-20">
                <div className="unified-header-card">
                    <div className="unified-header-title">
                        <Icon name="TrendingUp" size={28} /> 主体別投資動向
                    </div>
                    <p className="unified-header-sub">主要投資主体の累積売買ポジション推移</p>
                </div>
                
                <div className="bg-white rounded-xl shadow border border-slate-200 p-6 mb-6 animate-fade-in-up">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-lg font-bold text-slate-700">主体別 累積売買動向チャート</h2>
                        <a href="https://nikkei225jp.com/data/shutai.php" target="_blank" rel="noopener noreferrer" className="text-[#7C4DFF] hover:underline text-sm font-bold flex items-center gap-1">
                            日経225投手主体別 <Icon name="ExternalLink" size={12} />
                        </a>
                    </div>
                    
                    <div className="h-[500px] w-full">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }} stackOffset="sign">
                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                <XAxis dataKey="date" tick={{fontSize: 10}} />
                                <YAxis tickFormatter={(val) => `${(val / 10000).toFixed(0)}万`} width={40} tick={{fontSize: 10}} />
                                <Tooltip formatter={(val) => val.toLocaleString()} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                <Legend />
                                <ReferenceLine y={0} stroke="#000" />
                                <Bar dataKey="foreign" name="海外" fill="#7C4DFF" stackId="a" />
                                <Bar dataKey="individual" name="個人" fill="#00BCD4" stackId="a" />
                                <Bar dataKey="proprietary" name="証券自己" fill="#607D8B" stackId="a" />
                                <Bar dataKey="trust" name="投資信託" fill="#FF4081" stackId="a" />
                                <Bar dataKey="business" name="事業法人" fill="#FFC107" stackId="a" />
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </div>

                <div className="max-w-3xl mx-auto bg-white rounded-xl shadow border border-slate-200 p-6 w-full">
                    <div className="mb-4">
                        <h3 className="font-bold text-slate-700 mb-2 text-sm">データ入力 (Excel/Text貼り付け)</h3>
                        <p className="text-xs text-slate-500 mb-2">ヘッダー行の有無に関わらず、日付(YYYY/MM/DD)で始まる行を自動検出してグラフ化します。</p>
                    </div>
                    <div className="flex flex-col gap-2">
                        <textarea 
                            className="w-full border border-slate-300 rounded-lg p-3 text-xs font-mono focus:ring-2 focus:ring-[#7C4DFF] outline-none min-h-[150px]"
                            rows={6}
                            placeholder="日付..."
                            value={inputText}
                            onChange={(e) => setInputText(e.target.value)}
                        />
                        <button onClick={handleParse} className="bg-slate-800 text-white px-4 py-2 rounded-lg hover:bg-slate-700 font-bold self-end">更新</button>
                    </div>
                </div>
            </div>
        );
    };

    const OptionOI=({charts,setCharts})=>{const[ticker,setTicker]=useState('');const[error,setError]=useState(null);const handleData=(rows)=>{const step=50;const res=processOptionData(rows,step);if(res.error){setError(res.error);}else{setError(null);const newChart={id:Date.now().toString(),data:res.data,step:step,rawRows:rows};setCharts([...charts,newChart]);}};const handleStepChange=(id,newStep,newData)=>{setCharts(charts.map(c=>c.id===id?{...c,step:newStep,data:newData}:c));};const handleTickerNav=()=>{if(!ticker)return;const symbol=ticker.trim().toUpperCase();window.open(`https://optioncharts.io/options/${symbol}/option-chain`,'_blank');};return(<div className="h-full flex flex-col pb-20"><div className="unified-header-card"><div className="unified-header-title"><Icon name="BarChart3" size={28} /> Option 分析</div><p className="unified-header-sub">建玉の壁を可視化</p></div>{charts.length>0&&<button onClick={()=>setCharts([])} className="text-sm text-red-500 hover:underline mb-4">データをクリア</button>}{charts.map(chart=>(<OIChart key={chart.id} id={chart.id} initialData={chart.data} initialStep={chart.step} rawRows={chart.rawRows} onStepChange={handleStepChange}/>))}{error&&<div className="mb-4 p-3 bg-red-50 text-red-600 rounded flex items-center gap-2"><Icon name="AlertTriangle"/>{error}</div>}<div className="flex flex-col items-center justify-center py-8 border-t border-slate-200 mt-4 bg-slate-50/50 rounded-xl"><div className="mb-10 flex items-center gap-2"><span className="text-sm text-slate-500 font-bold">Ticker:</span><input type="text" className="border border-slate-300 rounded px-2 py-1 text-sm w-24 focus:outline-none focus:border-[#7C4DFF]" placeholder="e.g. TSLA" value={ticker} onChange={(e)=>setTicker(e.target.value)} onKeyDown={(e)=>e.key==='Enter'&&handleTickerNav()}/><button onClick={handleTickerNav} className="bg-[#7C4DFF] text-white text-xs px-3 py-1.5 rounded hover:bg-[#651FFF] font-medium">Go</button></div><DataInput onDataParsed={handleData}/></div></div>);};

const processOptionData = (rawRows, step = 50) => {
    if (!rawRows || rawRows.length < 2) return { data: [], error: 'データが不足しています。' };

    const parseNum = (val) => {
        if (typeof val === 'number') return val;
        if (!val) return 0;
        let str = String(val).toUpperCase();
        let multiplier = 1;
        if (str.endsWith('K')) multiplier = 1000;
        else if (str.endsWith('M')) multiplier = 1000000;
        str = str.replace(/[^0-9.-]/g, '').trim();
        const num = parseFloat(str);
        return isNaN(num) ? 0 : num * multiplier;
    };

    // --- SBI形式パース & 集計ロジック (リスク指標) ---
    // 「リスク指標」を含む行があるかチェック
    const isSBI = rawRows.slice(0, 50).some(row => 
        row.some(cell => String(cell).includes('リスク指標'))
    );

    if (isSBI) {
        const dataMap = new Map();
        const safeStep = step > 0 ? step : 1;
        let currentStrike = null;

        rawRows.forEach(row => {
            // 行全体の文字列からStrikeを探す (例: "02/05 14:02 59,000リスク指標")
            const rowStr = row.join(' ');
            const strikeMatch = rowStr.match(/([0-9,]+)リスク指標/);
            if (strikeMatch) {
                currentStrike = parseNum(strikeMatch[1]);
            }

            if (currentStrike !== null) {
                // セルのクリーニング
                const cells = row.map(c => String(c).trim());
                
                cells.forEach((cell, idx) => {
                    // %を含むセルを基準にOIを探す
                    // Call建玉: %を含むセルの左側にある純粋な数値 (カッコつき気配値は除外)
                    // Put建玉: %を含むセルの右側にある純粋な数値
                    if (cell.endsWith('%')) {
                        
                        // Call Check (Left)
                        if (idx > 0) {
                            const left = cells[idx - 1];
                            // 数値かつ、カッコを含まない
                            if (/^[0-9,]+$/.test(left)) {
                                const val = parseNum(left);
                                const roundedStrike = Math.round(currentStrike / safeStep) * safeStep;
                                if (!dataMap.has(roundedStrike)) dataMap.set(roundedStrike, { call: 0, put: 0 });
                                dataMap.get(roundedStrike).call += val;
                            }
                        }

                        // Put Check (Right)
                        if (idx < cells.length - 1) {
                            const right = cells[idx + 1];
                            if (/^[0-9,]+$/.test(right)) {
                                const val = parseNum(right);
                                const roundedStrike = Math.round(currentStrike / safeStep) * safeStep;
                                if (!dataMap.has(roundedStrike)) dataMap.set(roundedStrike, { call: 0, put: 0 });
                                dataMap.get(roundedStrike).put += val;
                            }
                        }
                    }
                });
            }
        });
        
        const sortedData = Array.from(dataMap.entries())
            .sort((a, b) => b[0] - a[0])
            .map(([strike, val]) => ({ strike, diff: val.call - val.put, call: val.call, put: val.put }))
            .filter(d => d.call > 0 || d.put > 0); // ゼロデータ除外

        return { data: sortedData, error: sortedData.length === 0 ? "SBIデータ読み込みエラー: 有効なデータが見つかりませんでした" : null };
    }
    
    // --- 既存の標準CSVパースロジック ---
    const strikeRegex = /(strike|行使価格|koushi)/i;
    const oiRegex = /(open\s*int|oi|建玉|tategyoku)/i;

    let reshapeHeaderIndex = -1;
    let reshapeWidth = 0;
    const getHeaderInfo = (row) => {
        const sRow = row.map(c => String(c).trim());
        let sCol = -1, oiCols = [];
        sRow.forEach((cell, i) => {
            if (strikeRegex.test(cell)) sCol = i;
            else if (oiRegex.test(cell)) oiCols.push(i);
        });
        return { sCol, oiCols, colCount: row.length };
    };
    for (let r = 0; r < Math.min(rawRows.length, 50); r++) {
        const info = getHeaderInfo(rawRows[r]);
        if (info.sCol !== -1 && info.oiCols.length >= 2 && info.colCount > 1) {
            let singleColCount = 0;
            for (let k = 1; k <= 10 && (r + k) < rawRows.length; k++) {
                if (rawRows[r + k].length === 1 || rawRows[r + k].length < info.colCount / 2) singleColCount++;
            }
            if (singleColCount >= 5) { reshapeHeaderIndex = r; reshapeWidth = info.colCount; break; }
        }
    }
    if (reshapeWidth > 0 && reshapeHeaderIndex !== -1) {
        const headerRow = rawRows[reshapeHeaderIndex];
        const flatData = [];
        for (let i = reshapeHeaderIndex + 1; i < rawRows.length; i++) {
            const row = rawRows[i];
            for (const cell of row) { if (cell !== null && cell !== undefined && String(cell).trim() !== '') flatData.push(cell); }
        }
        const newRows = [headerRow];
        let currentChunk = [];
        for (const cell of flatData) {
            currentChunk.push(cell);
            if (currentChunk.length === reshapeWidth) { newRows.push(currentChunk); currentChunk = []; }
        }
        rawRows = newRows;
    }
    let bestCandidate = { headerIndex: -1, strikeCol: -1, callCol: -1, putCol: -1, score: 0 };
    for (let r = 0; r < Math.min(rawRows.length, 50); r++) {
        const row = rawRows[r].map(c => String(c).trim());
        let sCol = -1, oiCols = [];
        row.forEach((cell, i) => {
            if (strikeRegex.test(cell)) sCol = i;
            else if (oiRegex.test(cell)) oiCols.push(i);
        });
        if (sCol !== -1 && oiCols.length >= 2) {
            let cCol = -1, pCol = -1;
            const oi1 = row[oiCols[0]].toLowerCase();
            const oi2 = row[oiCols[1]].toLowerCase();
            if (oi1.includes('call') || oi1.includes('コール')) { cCol = oiCols[0]; }
            if (oi1.includes('put') || oi1.includes('プット')) { pCol = oiCols[0]; }
            if (oi2.includes('call') || oi2.includes('コール')) { cCol = oiCols[1]; }
            if (oi2.includes('put') || oi2.includes('プット')) { pCol = oiCols[1]; }
            if (cCol === -1 || pCol === -1) { cCol = oiCols[0]; pCol = oiCols[1]; }
            bestCandidate = { headerIndex: r, strikeCol: sCol, callCol: cCol, putCol: pCol, score: 10 };
            break;
        }
    }
    if (bestCandidate.headerIndex === -1) return { data: [], error: 'ヘッダーが見つかりませんでした。' };
    const { headerIndex, strikeCol, callCol, putCol } = bestCandidate;
    const dataMap = new Map();
    const safeStep = step > 0 ? step : 1;
    for (let i = headerIndex + 1; i < rawRows.length; i++) {
        const row = rawRows[i];
        if (!row || row.length <= Math.max(strikeCol, callCol, putCol)) continue;
        const strike = parseNum(row[strikeCol]);
        const oi1 = parseNum(row[callCol]);
        const oi2 = parseNum(row[putCol]);
        if (strike > 0) {
            const roundedStrike = Math.round(strike / safeStep) * safeStep;
            if (!dataMap.has(roundedStrike)) dataMap.set(roundedStrike, { call: 0, put: 0 });
            const d = dataMap.get(roundedStrike);
            d.call += oi1;
            d.put += oi2;
        }
    }
    const sortedData = Array.from(dataMap.entries()).sort((a, b) => b[0] - a[0]).map(([strike, val]) => ({ strike, diff: val.call - val.put, call: val.call, put: val.put }));
    return { data: sortedData, error: sortedData.length === 0 ? "有効なデータが見つかりませんでした" : null };
};

const OIChart=({id,initialData,initialStep,rawRows,onStepChange})=>{const[data,setData]=useState(initialData);const[step,setStep]=useState(initialStep);const[zoomY,setZoomY]=useState(1);const[zoomX,setZoomX]=useState(1);const mainRef=useRef(null);const leftRef=useRef(null);const bottomRef=useRef(null);const containerRef=useRef(null);useEffect(()=>{if(rawRows&&step!==initialStep){const res=processOptionData(rawRows,step);if(!res.error){setData(res.data);onStepChange(id,step,res.data);}}},[step]);const handleScroll=()=>{if(mainRef.current&&leftRef.current&&bottomRef.current){leftRef.current.scrollTop=mainRef.current.scrollTop;bottomRef.current.scrollLeft=mainRef.current.scrollLeft;}};const barHeight=30;const totalHeight=Math.max(450,data.length*barHeight*zoomY);const chartWidth=`${zoomX*100}%`;const maxVal=Math.max(...data.map(d=>Math.abs(d.diff)),100);const handleWheel=(e,axis)=>{if(e.ctrlKey||axis==='main')return;e.preventDefault();const delta=e.deltaY>0?-0.1:0.1;if(axis==='y')setZoomY(z=>Math.max(0.1,Math.min(5,z+delta)));if(axis==='x')setZoomX(z=>Math.max(0.5,Math.min(3,z+delta)));};const handleScreenshot=async()=>{if(!containerRef.current)return;try{const canvas=await html2canvas(containerRef.current);canvas.toBlob(blob=>{navigator.clipboard.write([new ClipboardItem({'image/png':blob})]);alert('クリップボードにコピーしました');});}catch(e){console.error(e);alert('スクリーンショットに失敗しました');}};const CustomTooltip=({active,payload,label})=>{if(!active||!payload?.length)return null;const d=payload[0].payload;return(<div className="bg-white p-3 border border-slate-200 shadow-lg rounded text-sm z-50"><p className="font-bold">Strike: {label}</p><p className={d.diff>=0?'text-[#7C4DFF]':'text-[#FF4081]'}>Diff: {d.diff.toLocaleString()}</p><div className="text-xs text-slate-500 mt-1 pt-1 border-t">C: {d.call.toLocaleString()} / P: {d.put.toLocaleString()}</div></div>);};return(<div className="bg-white rounded-xl shadow border border-slate-200 h-[80vh] flex flex-col overflow-hidden mb-6 animate-fade-in-up" ref={containerRef}><div className="p-2 border-b border-slate-100 flex items-center gap-4 bg-slate-50 shrink-0 flex-wrap"><div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-500">HEIGHT</span><button onClick={()=>setZoomY(z=>Math.max(0.1,z-0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomOut" size={16}/></button><input type="range" min="0.1" max="5" step="0.1" value={zoomY} onChange={(e)=>setZoomY(parseFloat(e.target.value))} className="w-20"/><button onClick={()=>setZoomY(z=>Math.min(5,z+0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomIn" size={16}/></button></div><div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-500">WIDTH</span><button onClick={()=>setZoomX(z=>Math.max(0.5,z-0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomOut" size={16}/></button><button onClick={()=>setZoomX(z=>Math.min(3,z+0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomIn" size={16}/></button></div><div className="flex items-center gap-2 border-l pl-4 border-slate-200"><span className="text-xs font-bold text-slate-500">STEP</span><input type="number" className="border border-slate-300 rounded px-1 py-0.5 text-xs w-16 text-center focus:outline-none focus:border-[#7C4DFF]" value={step===''?'' : step} onChange={(e)=>setStep(e.target.value===''? '' : parseFloat(e.target.value))} min="0.1"/></div><div className="ml-auto flex items-center gap-2"><button onClick={handleScreenshot} className="text-xs flex items-center gap-1 hover:text-[#7C4DFF] border px-2 py-1 rounded bg-white"><Icon name="Camera" size={14}/> Capture</button><button onClick={()=>{setZoomY(1);setZoomX(1);}} className="text-xs flex items-center gap-1 hover:text-[#7C4DFF] border px-2 py-1 rounded bg-white"><Icon name="RotateCcw" size={14}/> Reset</button></div></div><div className="flex-1 flex overflow-hidden relative"><div className="w-24 border-r border-slate-200 bg-slate-50 shrink-0 overflow-hidden" ref={leftRef} onWheel={(e)=>handleWheel(e,'y')}><div style={{height:totalHeight,width:'100%'}}><ResponsiveContainer><BarChart layout="vertical" data={data} margin={{top:10,bottom:0}}><YAxis type="category" dataKey="strike" width={90} tick={{fontSize:12,fontWeight:600}} interval={0}/><Bar dataKey="diff" fill="transparent"/></BarChart></ResponsiveContainer></div></div><div className="flex-1 overflow-auto bg-slate-50/30" ref={mainRef} onScroll={handleScroll}><div style={{width:chartWidth,height:totalHeight,minWidth:'100%'}}><ResponsiveContainer><BarChart layout="vertical" data={data} margin={{top:10,right:30,left:0,bottom:0}}><CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={true}/><XAxis type="number" domain={[-maxVal,maxVal]} hide/><YAxis type="category" width={0} tick={false}/><Tooltip content={<CustomTooltip/>} cursor={{fill:'rgba(0,0,0,0.05)'}}/><ReferenceLine x={0} stroke="#334155"/><Bar dataKey="diff" barSize={barHeight*0.8}>{data.map((entry,index)=>(<Cell key={index} fill={entry.diff>=0?'#536DFE':'#FF4081'}/>))}<LabelList dataKey="diff" position="insideRight" formatter={(v)=>v.toLocaleString()} style={{fontSize:11,fill:'#64748b'}}/></Bar></BarChart></ResponsiveContainer></div></div></div><div className="h-8 border-t border-slate-200 flex shrink-0"><div className="w-24 border-r border-slate-200 bg-slate-100 flex items-center justify-center text-slate-400"><Icon name="MousePointer2" size={14}/></div><div className="flex-1 overflow-hidden bg-slate-50" ref={bottomRef} onWheel={(e)=>handleWheel(e,'x')}><div style={{width:chartWidth,minWidth:'100%',height:'100%'}}><ResponsiveContainer><BarChart layout="vertical" data={[{}]} margin={{right:30,left:0}}><XAxis type="number" domain={[-maxVal,maxVal]} tick={{fontSize:10}}/><YAxis type="category" width={0}/></BarChart></ResponsiveContainer></div></div></div></div>);};

// ==========================================
//  Main Layout
// ==========================================
const App = () => {
    const [view, setView] = useState('calendar');
    const [sidebarOpen, setSidebarOpen] = useState(false);
    const [sidebarWidth, setSidebarWidth] = useState(260);
    const [isCollapsed, setIsCollapsed] = useState(false);
    const [isResizing, setIsResizing] = useState(false);
    const [optionCharts, setOptionCharts] = useState([]);

    const [historyData, setHistoryData] = useState({});
    const [customLinks, setCustomLinks] = useState([]);
    const [quotes, setQuotes] = useState([]);
    const [gistToken, setGistToken] = useState(localStorage.getItem('gist_token') || '');
    const [gistId, setGistId] = useState(localStorage.getItem('gist_id') || '');
    
    const [quotePrefill, setQuotePrefill] = useState('');

    // 修正: Cloud First Data Loading Strategy
    useEffect(() => {
        const loadData = async () => {
            let cloudLoaded = false;
            
            // 1. Gistからデータを取得（最優先）
            if (gistToken && gistId) {
                try {
                    const response = await fetch(`https://api.github.com/gists/${gistId.trim()}`, {
                        headers: { 'Authorization': `token ${gistToken.trim()}` }
                    });
                    
                    if (response.ok) {
                        const json = await response.json();
                        if (json.files && json.files['market_data.json']) {
                            const content = JSON.parse(json.files['market_data.json'].content);
                            
                            // GistデータをstateとlocalStorageの両方に保存 (古いローカルデータがあっても上書きする)
                            if (content.history) {
                                setHistoryData(content.history);
                                localStorage.setItem('history_data', JSON.stringify(content.history));
                            }
                            if (content.links) {
                                setCustomLinks(content.links);
                                localStorage.setItem('market-dash-links', JSON.stringify(content.links));
                            }
                            if (content.quotes) {
                                setQuotes(content.quotes);
                                localStorage.setItem('market-dash-quotes', JSON.stringify(content.quotes));
                            }
                            
                            cloudLoaded = true;
                            console.log("✅ Sync: Gist data loaded successfully (Cloud First)");
                        }
                    }
                } catch (e) {
                    console.error("❌ Sync: Gist load failed", e);
                }
            }

            // 2. Gistが使えない、または失敗した場合のみローカルからロード
            if (!cloudLoaded) {
                try {
                    const h = localStorage.getItem('history_data'); if (h) setHistoryData(JSON.parse(h));
                    const l = localStorage.getItem('market-dash-links'); if (l) setCustomLinks(JSON.parse(l));
                    const q = localStorage.getItem('market-dash-quotes'); if (q) setQuotes(JSON.parse(q));
                    console.log("⚠️ Sync: Loaded from LocalStorage (Fallback)");
                } catch (e) { 
                    console.error("Local Load Failed", e); 
                }
            }
        };

        loadData();
    }, []); // 依存配列は空でOK (Token等は初期化時に読み込み済み)

    // 修正: Save Strategy (Sync Local + Async Cloud)
    const saveAllData = (newHistory, newLinks, newQuotes) => {
        const h = newHistory !== undefined ? newHistory : historyData;
        const l = newLinks !== undefined ? newLinks : customLinks;
        const q = newQuotes !== undefined ? newQuotes : quotes;
        
        // State Update
        if (newHistory !== undefined) setHistoryData(h);
        if (newLinks !== undefined) setCustomLinks(l);
        if (newQuotes !== undefined) setQuotes(q);

        // 1. LocalStorage (Synchronous - Immediate)
        try {
            if (newHistory !== undefined) localStorage.setItem('history_data', JSON.stringify(h));
            if (newLinks !== undefined) localStorage.setItem('market-dash-links', JSON.stringify(l));
            if (newQuotes !== undefined) localStorage.setItem('market-dash-quotes', JSON.stringify(q));
        } catch (e) {
            console.error("Local Save Failed", e);
        }

        // 2. Gist (Asynchronous - Background)
        if (gistToken && gistId) {
            const content = JSON.stringify({ 
                history: h, 
                links: l, 
                quotes: q,
                lastUpdated: new Date().toISOString() // 競合解決用にタイムスタンプ付与
            });
            
            fetch(`https://api.github.com/gists/${gistId.trim()}`, {
                method: 'PATCH',
                headers: { 'Authorization': `token ${gistToken.trim()}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: { 'market_data.json': { content: content } } })
            })
            .then(res => {
                if(res.ok) console.log("✅ Sync: Saved to Gist");
                else console.warn("⚠️ Sync: Gist Save Failed", res.status);
            })
            .catch(e => console.error("❌ Sync: Gist Network Error", e));
        }
    };

    const [isAddingLink, setIsAddingLink] = useState(false);
    const [newLinkLabel, setNewLinkLabel] = useState('');
    const [newLinkUrl, setNewLinkUrl] = useState('');
    const [linkType, setLinkType] = useState('link');
    const [collapsedCategories, setCollapsedCategories] = useState({});
    const [draggedIndex, setDraggedIndex] = useState(null);

    const toggleCategory = (i) => setCollapsedCategories(p => ({ ...p, [i]: !p[i] }));
    
    // 修正: リンクを一括で開くロジックを改善
    const openAllInGroup = (start) => {
        if (!customLinks[start] || customLinks[start].type !== 'divider') {
            console.warn('Invalid category index');
            return;
        }
        
        const linksToOpen = [];
        
        // まず開くべきリンクを収集
        for (let i = start + 1; i < customLinks.length; i++) {
            const item = customLinks[i];
            
            // 次のカテゴリに到達したら終了
            if (item.type === 'divider') {
                break;
            }
            
            // URLが存在するリンクを収集
            if (item.url && item.url.trim()) {
                linksToOpen.push(item.url);
            }
        }
        
        // 収集したリンクを一括で開く
        if (linksToOpen.length === 0) {
            alert('このカテゴリにはリンクがありません');
            return;
        }
        
        // ブラウザのポップアップブロック対策（確認ダイアログ）
        if (linksToOpen.length > 5) {
            if (!confirm(`${linksToOpen.length}個のタブを開きますか？`)) {
                return;
            }
        }
        
        // リンクを開く
        linksToOpen.forEach(url => {
            window.open(url, '_blank');
        });
    };

    const addCustomLink = () => { if ((linkType === 'link' && newLinkLabel && newLinkUrl) || (linkType === 'divider' && newLinkLabel)) { let url = newLinkUrl; if (linkType === 'link' && !/^https?:\/\//i.test(url)) url = 'https://' + url; const newItem = { label: newLinkLabel, url: linkType === 'link' ? url : '', type: linkType }; const updated = [...customLinks, newItem]; setNewLinkLabel(''); setNewLinkUrl(''); setIsAddingLink(false); saveAllData(undefined, updated, undefined); } };
    const removeCustomLink = (i) => { const updated = customLinks.filter((_, idx) => idx !== i); saveAllData(undefined, updated, undefined); };
    const handleDragStart = (e, i) => { setDraggedIndex(i); e.dataTransfer.effectAllowed = 'move'; };
    const handleDragOver = (e, i) => { e.preventDefault(); if (draggedIndex === null || draggedIndex === i) return; const newLinks = [...customLinks]; const [removed] = newLinks.splice(draggedIndex, 1); newLinks.splice(i, 0, removed); saveAllData(undefined, newLinks, undefined); setDraggedIndex(i); };

    const startResizing = useCallback((e) => { e.preventDefault(); setIsResizing(true); }, []);
    useEffect(() => { const handleMouseMove = (e) => { if (isResizing) { let w = e.clientX; if (w < 150) w = 150; if (w > 400) w = 400; setSidebarWidth(w); } }; const handleMouseUp = () => { if (isResizing) setIsResizing(false); }; if (isResizing) { document.addEventListener('mousemove', handleMouseMove); document.addEventListener('mouseup', handleMouseUp); } return () => { document.removeEventListener('mousemove', handleMouseMove); document.removeEventListener('mouseup', handleMouseUp); }; }, [isResizing]);

    const NavItem = ({ id, label, icon }) => ( <button onClick={() => { setView(id); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors mb-1 ${view === id ? 'bg-[#7C4DFF] text-white shadow' : 'text-[#64748B] hover:bg-slate-100'} ${isCollapsed ? 'justify-center' : ''}`} title={isCollapsed ? label : ''}><Icon name={icon} size={20} />{!isCollapsed && <span className="font-medium text-sm">{label}</span>}</button> );

    const renderCustomLinks = () => { const elements = []; let currentCategoryHidden = false; customLinks.forEach((link, i) => { if (link.type === 'divider') { currentCategoryHidden = collapsedCategories[i] || false; elements.push(<div key={i} draggable onDragStart={(e) => handleDragStart(e, i)} onDragOver={(e) => handleDragOver(e, i)} className={`group flex items-center gap-2 px-2 py-1.5 rounded-lg mt-3 mb-1 cursor-move transition-colors hover:bg-slate-100 ${draggedIndex === i ? 'dragging' : ''}`}><div className="text-slate-300 group-hover:text-slate-400 cursor-grab active:cursor-grabbing"><Icon name="GripVertical" size={14} /></div><div className="flex-1 flex items-center gap-2 overflow-hidden cursor-pointer" onClick={() => toggleCategory(i)}><Icon name={currentCategoryHidden ? "ChevronRight" : "ChevronLeft"} size={14} className="text-slate-400 transition-transform" style={{ transform: currentCategoryHidden ? 'rotate(0deg)' : 'rotate(-90deg)' }} /><Icon name="FolderOpen" size={14} className="text-[#7C4DFF]" /><span className="text-xs font-bold text-slate-500 uppercase tracking-wider truncate select-none">{link.label}</span></div><button onClick={() => openAllInGroup(i)} className="opacity-0 group-hover:opacity-100 p-1 text-slate-400 hover:text-[#7C4DFF] transition-opacity"><Icon name="ExternalLink" size={12} /></button><button onClick={() => removeCustomLink(i)} className="opacity-0 group-hover:opacity-100 p-1 text-slate-400 hover:text-red-500 transition-opacity"><Icon name="Trash2" size={12} /></button></div>); } else { if (!currentCategoryHidden) { elements.push(<div key={i} draggable onDragStart={(e) => handleDragStart(e, i)} onDragOver={(e) => handleDragOver(e, i)} className={`group flex items-center gap-2 px-3 py-1 ml-4 rounded-lg transition-colors cursor-move hover:bg-slate-100 ${draggedIndex === i ? 'dragging' : ''}`}><div className="text-slate-300 group-hover:text-slate-400 cursor-grab active:cursor-grabbing"><Icon name="GripVertical" size={12} /></div><a href={link.url} target="_blank" rel="noopener noreferrer" className="flex-1 flex items-center gap-2 text-slate-600 text-sm font-medium overflow-hidden pointer-events-none group-hover:pointer-events-auto"><Icon name="Link" size={12} className="shrink-0 text-slate-400" /><span className="truncate">{link.label}</span></a><button onClick={() => removeCustomLink(i)} className="opacity-0 group-hover:opacity-100 p-1 text-slate-400 hover:text-red-500 transition-opacity"><Icon name="Trash2" size={12} /></button></div>); } } }); return elements; };
    
    const handleMoveToQuotes = (text) => {
        setQuotePrefill(text);
        setView('quotes');
    };

    return (
        <div className="flex h-screen overflow-hidden bg-[#f8fafc]">
            <aside className={`fixed lg:static inset-y-0 left-0 z-50 bg-white border-r border-slate-200 transform transition-all duration-75 shadow-xl lg:shadow-none flex flex-col ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`} style={{ width: isCollapsed ? 70 : sidebarWidth }}>
                <div className="h-14 flex items-center justify-between px-4 border-b border-slate-100 shrink-0">{!isCollapsed && <span className="font-bold text-lg tracking-tight text-[#334155]">Dashboard</span>}<button onClick={() => setIsCollapsed(!isCollapsed)} className="p-1 text-slate-400 hover:text-[#7C4DFF] hover:bg-slate-50 rounded mx-auto lg:mx-0"><Icon name={isCollapsed ? "ChevronRight" : "ChevronLeft"} size={20} /></button></div>
                <div className="flex-1 overflow-y-auto overflow-x-hidden p-3 space-y-1 flex flex-col relative custom-scrollbar">
                    {!isCollapsed && <div className="text-[10px] font-bold text-slate-400 px-2 mb-2 mt-2">MENU</div>}
                    <NavItem id="calendar" label="投資カレンダー" icon="Calendar" />
                    <NavItem id="quotes" label="投資の格言集" icon="Lightbulb" />
                    <NavItem id="trends" label="主体別投資動向" icon="TrendingUp" />
                    <NavItem id="option" label="Option 分析" icon="BarChart3" />
                    <NavItem id="jpx" label="JPX 海外動向" icon="LineChart" />
                    <NavItem id="participant" label="手口上位" icon="Briefcase" />
                    {!isCollapsed && (<><div className="flex-1 min-h-[20px]"></div><div className="pb-16">{customLinks.length > 0 && (<div className="space-y-0.5"><div className="text-[10px] font-bold text-slate-400 px-2 mb-2">QUICK LINKS</div>{renderCustomLinks()}</div>)}</div><div className="absolute bottom-4 left-0 right-0 px-4 flex justify-center">{!isAddingLink ? (<button onClick={() => setIsAddingLink(true)} className="w-10 h-10 flex items-center justify-center rounded-full bg-slate-50 border border-slate-200 text-slate-400 hover:text-[#7C4DFF] hover:bg-white hover:shadow-md transition-all duration-200"><Icon name="Plus" size={20} /></button>) : (<div className="w-full bg-white rounded-xl shadow-xl border border-slate-200 p-4 animate-fade-in-up"><div className="flex justify-between items-center mb-3"><p className="text-xs font-bold text-slate-500 uppercase">Add Item</p><button onClick={() => setIsAddingLink(false)} className="text-slate-400 hover:text-slate-600"><Icon name="X" size={14} /></button></div><div className="flex bg-slate-100 p-1 rounded-lg mb-3"><button onClick={() => setLinkType('link')} className={`flex-1 text-xs py-1.5 rounded-md font-bold transition-all ${linkType === 'link' ? 'bg-white text-[#7C4DFF] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>LINK</button><button onClick={() => setLinkType('divider')} className={`flex-1 text-xs py-1.5 rounded-md font-bold transition-all ${linkType === 'divider' ? 'bg-white text-[#7C4DFF] shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>CATEGORY</button></div><div className="space-y-3"><input type="text" placeholder="Name" autoFocus className="w-full text-xs p-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-[#7C4DFF]" value={newLinkLabel} onChange={(e) => setNewLinkLabel(e.target.value)} />{linkType === 'link' && (<input type="text" placeholder="URL" className="w-full text-xs p-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-[#7C4DFF]" value={newLinkUrl} onChange={(e) => setNewLinkUrl(e.target.value)} />)}<button onClick={addCustomLink} disabled={!newLinkLabel || (linkType === 'link' && !newLinkUrl)} className="w-full bg-[#7C4DFF] text-white text-xs py-2 rounded-lg hover:bg-[#651FFF] disabled:opacity-50 font-bold">追加</button></div></div>)}</div></>)}
                    
                    {!isCollapsed && <div className="mt-4 px-4 pb-2 text-[10px] text-slate-300 text-center">v2026.02.05-sbi-oi-support</div>}
                </div>
                {!isCollapsed && (<div className="absolute top-0 right-0 w-1 h-full cursor-col-resize hover:bg-[#7C4DFF] transition-colors z-50 flex flex-col justify-center items-center group" onMouseDown={startResizing}><div className="h-8 w-1 bg-slate-300 rounded-full group-hover:bg-[#7C4DFF]"></div></div>)}
            </aside>
            {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-40 lg:hidden" onClick={() => setSidebarOpen(false)}></div>}
            <div className="flex-1 flex flex-col min-w-0">
                <header className="h-14 bg-white border-b border-slate-200 flex items-center px-4 lg:hidden shrink-0"><button onClick={() => setSidebarOpen(true)} className="p-2 text-slate-600"><Icon name="Menu" /></button><span className="ml-4 font-bold text-[#334155]">{view === 'calendar' ? '投資カレンダー' : view === 'option' ? 'Option 分析' : view === 'jpx' ? 'JPX 海外動向' : view === 'quotes' ? '投資の格言集' : view === 'trends' ? '主体別投資動向' : '取引参加者別取引高'}</span></header>
                <main className="flex-1 overflow-auto p-4 md:p-6 bg-slate-50/50">
                    <div className="max-w-7xl mx-auto h-full">
                        {view === 'calendar' ? <ProfitManager historyData={historyData} updateHistoryData={(nd) => saveAllData(nd, undefined, undefined)} customLinks={customLinks} setCustomLinks={(nl) => saveAllData(undefined, nl, undefined)} quotes={quotes} setQuotes={(nq) => saveAllData(undefined, undefined, nq)} saveAllData={saveAllData} onMoveToQuotes={handleMoveToQuotes} /> :
                            view === 'quotes' ? <QuotesManager quotes={quotes} setQuotes={(nq) => saveAllData(undefined, undefined, nq)} prefillBody={quotePrefill} uploadConfig={{token: gistToken, owner: localStorage.getItem('repo_owner') || 'seahirodigital', repo: localStorage.getItem('repo_name') || 'investment_dashboard'}} /> :
                                view === 'jpx' ? <ForeignInvestors /> :
                                    view === 'participant' ? <ParticipantVolume /> :
                                        view === 'trends' ? <InvestorTrends /> :
                                        <OptionOI charts={optionCharts} setCharts={setOptionCharts} />}
                    </div>
                </main>
            </div>
        </div>
    );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
