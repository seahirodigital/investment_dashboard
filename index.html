<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Market Dashboard</title>
    
    <!-- デザイン・スタイル (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React本体 (UIを作るためのライブラリ) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- JSXをブラウザで動かすための変換ツール (Babel) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- グラフ描画ライブラリ (Recharts) -->
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>

    <!-- CSV解析 (PapaParse) -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- アイコン (Lucide) -->
    <script src="https://unpkg.com/lucide@0.294.0/dist/umd/lucide.min.js"></script>

    <!-- JPXチャート用 (Chart.js関連) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>

    <style>
        /* スクロールバーのカスタマイズ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        body { background-color: #f8fafc; font-family: 'Helvetica Neue', Arial, sans-serif; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/",
    "recharts": "https://esm.sh/recharts@^3.7.0",
    "papaparse": "https://esm.sh/papaparse@^5.5.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.563.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <!-- アプリケーションのロジック -->
    <script type="text/babel">
        // --- ライブラリの準備 ---
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Cell, ReferenceLine, ResponsiveContainer, LabelList } = Recharts;
        
        // --- アイコン表示用コンポーネント ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const lucide = window.lucide;
            if (!lucide) return null;
            
            // LucideのcreateIconsを使ってSVGを生成するのはReact内では難しいので、
            // 簡易的に主要なアイコンをSVGとして埋め込みます
            const icons = {
                Menu: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></svg>,
                X: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
                LayoutDashboard: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
                LineChart: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>,
                BarChart3: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
                ExternalLink: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
                AlertTriangle: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
                Upload: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
                ZoomIn: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>,
                ZoomOut: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>,
                RotateCcw: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
                ArrowUpDown: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21 16-4 4-4-4"/><path d="M17 20V4"/><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/></svg>,
                MousePointer2: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 6-8 13 4.5-1.5 3 7 3-7 4.5 1.5L12 6Z"/><path d="m6 13 6-3 6 3"/></svg>
            };
            return icons[name] || null;
        };

        // --- データ解析ロジック (Analysis Logic) ---
        const processOptionData = (rawRows) => {
            if (!rawRows || rawRows.length < 2) {
                return { data: [], error: 'データが不足しています。' };
            }

            const strikeRegex = /(strike|行使価格|koushi)/i;
            const oiRegex = /(open\s*int|oi|建玉|tategyoku)/i;

            const parseNum = (val) => {
                if (typeof val === 'number') return val;
                if (!val) return 0;
                let str = String(val).toUpperCase();
                let multiplier = 1;
                if (str.endsWith('K')) multiplier = 1000;
                else if (str.endsWith('M')) multiplier = 1000000;
                str = str.replace(/[^0-9.-]/g, '').trim(); 
                const num = parseFloat(str);
                return isNaN(num) ? 0 : num * multiplier;
            };

            // ヘッダー行を探す
            let bestCandidate = { headerIndex: -1, strikeCol: -1, callCol: -1, putCol: -1, score: 0 };
            
            for (let r = 0; r < Math.min(rawRows.length, 50); r++) {
                const row = rawRows[r].map(c => String(c).trim());
                let sCol = -1, oiCols = [];
                row.forEach((cell, i) => {
                    if (strikeRegex.test(cell)) sCol = i;
                    else if (oiRegex.test(cell)) oiCols.push(i);
                });

                if (sCol !== -1 && oiCols.length >= 2) {
                    let cCol = oiCols[0], pCol = oiCols[1];
                    // Call/Putの判定ロジック（簡易版）
                    if (/put|プット/i.test(row[oiCols[0]])) { pCol = oiCols[0]; cCol = oiCols[1]; }
                    else if (/put|プット/i.test(row[oiCols[1]])) { pCol = oiCols[1]; cCol = oiCols[0]; }
                    
                    bestCandidate = { headerIndex: r, strikeCol: sCol, callCol: cCol, putCol: pCol, score: 10 };
                    break;
                }
            }

            if (bestCandidate.headerIndex === -1) {
                // ヘッダーが見つからない場合、1行目をヘッダーと仮定して、
                // 1列目=Strike, 2列目=Call, 3列目=Put という簡易ルールを適用
                bestCandidate = { headerIndex: -1, strikeCol: 0, callCol: 1, putCol: 2, score: 5 };
            }

            const { headerIndex, strikeCol, callCol, putCol } = bestCandidate;
            const dataMap = new Map();

            for (let i = headerIndex + 1; i < rawRows.length; i++) {
                const row = rawRows[i];
                if (!row || row.length < 2) continue;

                const strike = parseNum(row[strikeCol]);
                const oi1 = parseNum(row[callCol]);
                const oi2 = parseNum(row[putCol]);

                if (strike > 0) {
                    const roundedStrike = Math.round(strike / 10) * 10;
                    if (!dataMap.has(roundedStrike)) dataMap.set(roundedStrike, { call: 0, put: 0 });
                    const d = dataMap.get(roundedStrike);
                    // 列の左右どちらがCall/Putか不明な場合のフォールバックは省略（左=Call, 右=Putと仮定）
                    d.call += oi1;
                    d.put += oi2;
                }
            }

            const sortedData = Array.from(dataMap.entries())
                .sort((a, b) => b[0] - a[0]) // Strike降順
                .map(([strike, val]) => ({
                    strike,
                    diff: val.call - val.put,
                    call: val.call,
                    put: val.put
                }));

            return { data: sortedData, error: sortedData.length === 0 ? "有効なデータが見つかりませんでした" : null };
        };


        // --- コンポーネント: データ入力 (DataInput) ---
        const DataInput = ({ onDataParsed }) => {
            const [text, setText] = useState('');
            const [dragActive, setDragActive] = useState(false);

            const handleParse = (input) => {
                Papa.parse(input, {
                    complete: (results) => onDataParsed(results.data),
                    skipEmptyLines: true,
                    header: false 
                });
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setDragActive(false);
                if (e.dataTransfer.files?.[0]) {
                    handleParse(e.dataTransfer.files[0]);
                }
            };

            return (
                <div className="max-w-3xl mx-auto bg-white rounded-xl shadow border border-slate-200 p-6 space-y-6">
                    <div 
                        className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${dragActive ? 'border-blue-500 bg-blue-50' : 'border-slate-300 hover:bg-slate-50'}`}
                        onDragOver={(e) => { e.preventDefault(); setDragActive(true); }}
                        onDragLeave={() => setDragActive(false)}
                        onDrop={handleDrop}
                    >
                        <Icon name="Upload" className="mx-auto text-slate-400 mb-2" size={32} />
                        <p className="text-slate-600 font-medium">CSVファイルをドラッグ＆ドロップ</p>
                        <p className="text-slate-400 text-sm">または</p>
                        <input type="file" className="mt-2 text-sm text-slate-500" onChange={(e) => e.target.files?.[0] && handleParse(e.target.files[0])} />
                    </div>
                    
                    <div className="flex gap-2">
                        <textarea 
                            className="flex-1 border border-slate-300 rounded-lg p-3 text-sm font-mono focus:ring-2 focus:ring-blue-500 outline-none"
                            rows={4}
                            placeholder="ここにスプレッドシートのデータを貼り付け..."
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                        />
                        <button 
                            onClick={() => handleParse(text)}
                            disabled={!text}
                            className="bg-slate-800 text-white px-4 rounded-lg hover:bg-slate-700 disabled:opacity-50 font-medium"
                        >
                            解析
                        </button>
                    </div>
                </div>
            );
        };

        // --- コンポーネント: チャート (OIChart) ---
        const OIChart = ({ data }) => {
            const [zoomY, setZoomY] = useState(1);
            const [zoomX, setZoomX] = useState(1);
            
            const mainRef = useRef(null);
            const leftRef = useRef(null);
            const bottomRef = useRef(null);

            // スクロール同期
            const handleScroll = () => {
                if (mainRef.current && leftRef.current && bottomRef.current) {
                    leftRef.current.scrollTop = mainRef.current.scrollTop;
                    bottomRef.current.scrollLeft = mainRef.current.scrollLeft;
                }
            };

            const barHeight = 30;
            const totalHeight = Math.max(600, data.length * barHeight * zoomY);
            const chartWidth = `${zoomX * 100}%`;
            const maxVal = Math.max(...data.map(d => Math.abs(d.diff)), 100);

            // マウスホイール操作のハンドリング
            const handleWheel = (e, axis) => {
                if (e.ctrlKey || axis === 'main') return; // メインエリアのデフォルトスクロールはCtrlなしで許可
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                if (axis === 'y') setZoomY(z => Math.max(0.1, Math.min(5, z + delta)));
                if (axis === 'x') setZoomX(z => Math.max(0.5, Math.min(3, z + delta)));
            };

            const CustomTooltip = ({ active, payload, label }) => {
                if (!active || !payload?.length) return null;
                const d = payload[0].payload;
                return (
                    <div className="bg-white p-3 border border-slate-200 shadow-lg rounded text-sm z-50">
                        <p className="font-bold">Strike: {label}</p>
                        <p className={d.diff >= 0 ? 'text-blue-600' : 'text-red-500'}>Diff: {d.diff.toLocaleString()}</p>
                        <div className="text-xs text-slate-500 mt-1 pt-1 border-t">
                            C: {d.call.toLocaleString()} / P: {d.put.toLocaleString()}
                        </div>
                    </div>
                );
            };

            return (
                <div className="bg-white rounded-xl shadow border border-slate-200 h-[80vh] flex flex-col overflow-hidden">
                    {/* Toolbar */}
                    <div className="p-2 border-b border-slate-100 flex items-center gap-4 bg-slate-50 shrink-0">
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-slate-500">HEIGHT</span>
                            <button onClick={()=>setZoomY(z=>Math.max(0.1, z-0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomOut" size={16}/></button>
                            <input type="range" min="0.1" max="5" step="0.1" value={zoomY} onChange={(e)=>setZoomY(parseFloat(e.target.value))} className="w-20" />
                            <button onClick={()=>setZoomY(z=>Math.min(5, z+0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomIn" size={16}/></button>
                        </div>
                        <div className="h-4 w-px bg-slate-300"></div>
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-slate-500">WIDTH</span>
                            <button onClick={()=>setZoomX(z=>Math.max(0.5, z-0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomOut" size={16}/></button>
                            <button onClick={()=>setZoomX(z=>Math.min(3, z+0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomIn" size={16}/></button>
                        </div>
                        <button onClick={()=>{setZoomY(1);setZoomX(1);}} className="ml-auto text-xs flex items-center gap-1 hover:text-blue-600"><Icon name="RotateCcw" size={14}/> Reset</button>
                    </div>

                    {/* Chart Grid */}
                    <div className="flex-1 flex overflow-hidden relative">
                        {/* Left Axis (Fixed) */}
                        <div 
                            className="w-24 border-r border-slate-200 bg-slate-50 shrink-0 overflow-hidden" 
                            ref={leftRef}
                            onWheel={(e)=>handleWheel(e, 'y')}
                        >
                            <div style={{height: totalHeight, width: '100%'}}>
                                <ResponsiveContainer>
                                    <BarChart layout="vertical" data={data} margin={{top:10, bottom:0}}>
                                        <YAxis type="category" dataKey="strike" width={90} tick={{fontSize:12, fontWeight:600}} interval={0} />
                                        <Bar dataKey="diff" fill="transparent" />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        {/* Main Chart */}
                        <div 
                            className="flex-1 overflow-auto bg-slate-50/30"
                            ref={mainRef}
                            onScroll={handleScroll}
                        >
                            <div style={{width: chartWidth, height: totalHeight, minWidth: '100%'}}>
                                <ResponsiveContainer>
                                    <BarChart layout="vertical" data={data} margin={{top:10, right:30, left:0, bottom:0}}>
                                        <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={true} />
                                        <XAxis type="number" domain={[-maxVal, maxVal]} hide />
                                        <YAxis type="category" width={0} tick={false} />
                                        <Tooltip content={<CustomTooltip />} cursor={{fill:'rgba(0,0,0,0.05)'}} />
                                        <ReferenceLine x={0} stroke="#334155" />
                                        <Bar dataKey="diff" barSize={barHeight * 0.8}>
                                            {data.map((entry, index) => (
                                                <Cell key={index} fill={entry.diff >= 0 ? '#4A86E8' : '#E67C73'} />
                                            ))}
                                            <LabelList dataKey="diff" position="insideRight" formatter={(v)=>v.toLocaleString()} style={{fontSize:11, fill:'#64748b'}} />
                                        </Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>

                    {/* Bottom Axis */}
                    <div className="h-8 border-t border-slate-200 flex shrink-0">
                        <div className="w-24 border-r border-slate-200 bg-slate-100 flex items-center justify-center text-slate-400">
                           <Icon name="MousePointer2" size={14} />
                        </div>
                        <div className="flex-1 overflow-hidden bg-slate-50" ref={bottomRef} onWheel={(e)=>handleWheel(e, 'x')}>
                            <div style={{width: chartWidth, minWidth:'100%', height:'100%'}}>
                                <ResponsiveContainer>
                                    <BarChart layout="vertical" data={[{}]} margin={{right:30, left:0}}>
                                        <XAxis type="number" domain={[-maxVal, maxVal]} tick={{fontSize:10}} />
                                        <YAxis type="category" width={0} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- コンポーネント: Option OI Main ---
        const OptionOI = () => {
            const [data, setData] = useState([]);
            const [hasData, setHasData] = useState(false);
            const [error, setError] = useState(null);

            const handleData = (rows) => {
                const res = processOptionData(rows);
                if (res.error) setError(res.error);
                else {
                    setData(res.data);
                    setHasData(true);
                    setError(null);
                }
            };

            return (
                <div className="h-full flex flex-col">
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800">Option OI Analyzer</h2>
                            <p className="text-slate-500">建玉の壁を可視化</p>
                        </div>
                        {hasData && <button onClick={()=>setHasData(false)} className="text-sm text-red-500 hover:underline">データをクリア</button>}
                    </div>
                    
                    {error && <div className="mb-4 p-3 bg-red-50 text-red-600 rounded flex items-center gap-2"><Icon name="AlertTriangle" />{error}</div>}

                    {!hasData ? (
                        <div className="flex flex-col items-center justify-center py-12">
                             <a href="https://optioncharts.io/options/$SPX/option-chain" target="_blank" className="mb-8 text-blue-600 flex items-center gap-1 hover:underline text-sm"><Icon name="ExternalLink" size={14}/> ソース例: optioncharts.io</a>
                             <DataInput onDataParsed={handleData} />
                             <div className="mt-8 p-4 bg-slate-100 rounded text-xs font-mono text-slate-600">
                                例: Strike, Call OI, Put OI の順で並んだCSVやテキスト
                             </div>
                        </div>
                    ) : (
                        <OIChart data={data} />
                    )}
                </div>
            );
        };

        // --- コンポーネント: JPX 海外投資家動向 (Legacy Code Wrapped) ---
        const ForeignInvestors = () => {
            const chartRef = useRef(null);
            const chartInst = useRef(null);
            const [stats, setStats] = useState([]);
            const [msg, setMsg] = useState('読み込み中...');

            // データ取得と描画
            useEffect(() => {
                fetch('history.csv')
                    .then(res => res.ok ? res.text() : Promise.reject('CSV not found'))
                    .then(text => {
                        const parsed = Papa.parse(text, { header: true, dynamicTyping: true, skipEmptyLines: true }).data;
                        const data = parsed
                            .filter(r => r.date && r.balance)
                            .map(r => ({ x: r.date, y: r.balance / 100000 })) // 億円
                            .sort((a,b) => new Date(a.x) - new Date(b.x));

                        if(data.length === 0) throw new Error('No Data');
                        
                        // 統計計算
                        const latest = data[data.length-1];
                        setStats([
                            { label: '最新週', value: latest.y, color: latest.y >=0 ? 'text-blue-600' : 'text-red-500' },
                        ]);
                        setMsg(`最終更新: ${latest.x}`);

                        // Chart.js描画
                        if(chartInst.current) chartInst.current.destroy();
                        const ctx = chartRef.current.getContext('2d');
                        chartInst.current = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                datasets: [{
                                    label: '差引(億円)',
                                    data: data,
                                    backgroundColor: c => c.raw.y >= 0 ? 'rgba(74, 134, 232, 0.7)' : 'rgba(230, 124, 115, 0.7)',
                                    borderColor: c => c.raw.y >= 0 ? '#4A86E8' : '#E67C73',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: { type: 'time', time: { unit: 'month' }, grid: {display:false} },
                                    y: { grid: {color: '#f1f5f9'} }
                                },
                                plugins: {
                                    zoom: {
                                        zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
                                        pan: { enabled: true, mode: 'x' }
                                    },
                                    legend: { display: false }
                                }
                            }
                        });
                    })
                    .catch(e => {
                        console.error(e);
                        setMsg("データの読み込みに失敗しました (history.csvが見つかりません)");
                    });

                return () => chartInst.current?.destroy();
            }, []);

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-slate-800">JPX 海外投資家動向</h2>
                        <span className="text-sm text-slate-400">{msg}</span>
                    </div>
                    
                    <div className="bg-white p-4 rounded-xl shadow border border-slate-200 h-[400px]">
                        <canvas ref={chartRef}></canvas>
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {stats.map((s, i) => (
                            <div key={i} className="bg-white p-4 rounded shadow border border-slate-200">
                                <p className="text-xs text-slate-500 font-bold">{s.label}</p>
                                <p className={`text-2xl font-bold ${s.color}`}>{Math.round(s.value).toLocaleString()}億円</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- メインアプリ (Layout) ---
        const App = () => {
            const [view, setView] = useState('jpx');
            const [sidebarOpen, setSidebarOpen] = useState(false);

            const NavItem = ({ id, label, icon }) => (
                <button 
                    onClick={() => { setView(id); setSidebarOpen(false); }}
                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${view === id ? 'bg-blue-600 text-white shadow' : 'text-slate-600 hover:bg-slate-100'}`}
                >
                    <Icon name={icon} />
                    <span className="font-medium">{label}</span>
                </button>
            );

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* Sidebar */}
                    <aside className={`fixed lg:static inset-y-0 left-0 z-50 w-64 bg-white border-r border-slate-200 transform transition-transform ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'} shadow-xl lg:shadow-none`}>
                        <div className="h-16 flex items-center px-6 border-b border-slate-100">
                            <div className="bg-slate-900 text-white p-1.5 rounded mr-3"><Icon name="LayoutDashboard" size={20} /></div>
                            <h1 className="font-bold text-slate-800">Market Dash</h1>
                        </div>
                        <nav className="p-4 space-y-2">
                            <div className="text-xs font-bold text-slate-400 px-2 mb-2">MENU</div>
                            <NavItem id="jpx" label="海外投資家動向" icon="LineChart" />
                            <NavItem id="option" label="Option OI" icon="BarChart3" />
                        </nav>
                    </aside>

                    {/* Overlay */}
                    {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-40 lg:hidden" onClick={() => setSidebarOpen(false)}></div>}

                    {/* Main Content */}
                    <div className="flex-1 flex flex-col min-w-0">
                        <header className="h-16 bg-white border-b border-slate-200 flex items-center px-4 lg:hidden shrink-0">
                            <button onClick={() => setSidebarOpen(true)} className="p-2 text-slate-600"><Icon name="Menu" /></button>
                            <span className="ml-4 font-bold text-slate-700">{view === 'jpx' ? '海外投資家動向' : 'Option OI'}</span>
                        </header>

                        <main className="flex-1 overflow-auto p-4 md:p-6 bg-slate-50">
                            <div className="max-w-7xl mx-auto h-full">
                                {view === 'jpx' ? <ForeignInvestors /> : <OptionOI />}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
