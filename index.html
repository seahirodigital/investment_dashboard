<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Market Dashboard</title>
    
    <!-- „Éá„Ç∂„Ç§„É≥„Éª„Çπ„Çø„Ç§„É´ (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ReactÊú¨‰Ωì -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Recharts‰æùÂ≠ò -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    
    <!-- „Ç∞„É©„ÉïÊèèÁîª (Recharts) -->
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>

    <!-- CSVËß£Êûê (PapaParse) -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- „Ç¢„Ç§„Ç≥„É≥ (Lucide) -->
    <script src="https://unpkg.com/lucide@0.294.0/dist/umd/lucide.min.js"></script>

    <!-- JPX„ÉÅ„É£„Éº„ÉàÁî® (Chart.jsÈñ¢ÈÄ£) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>

    <!-- JSXÂ§âÊèõ (Babel) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        body { background-color: #f8fafc; font-family: 'Helvetica Neue', Arial, sans-serif; }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.4/",
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "papaparse": "https://esm.sh/papaparse@^5.5.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.563.0",
    "recharts": "https://esm.sh/recharts@^3.7.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Cell, ReferenceLine, ResponsiveContainer, LabelList } = Recharts;

        // --- „Ç¢„Ç§„Ç≥„É≥ ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Menu: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></svg>,
                LayoutDashboard: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
                LineChart: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>,
                BarChart3: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
                ExternalLink: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
                AlertTriangle: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
                Upload: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
                ZoomIn: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>,
                ZoomOut: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>,
                RotateCcw: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
                MousePointer2: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 6-8 13 4.5-1.5 3 7 3-7 4.5 1.5L12 6Z"/><path d="m6 13 6-3 6 3"/></svg>,
                Plus: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                Trash2: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
                Link: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
                X: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            };
            return icons[name] || null;
        };

        // ==========================================
        //  JPX Chart Component
        // ==========================================
        const ForeignInvestors = () => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            
            const [allData, setAllData] = useState([]);
            const [currentTimeRange, setCurrentTimeRange] = useState('all');
            const [stats, setStats] = useState(null);
            const [dataCount, setDataCount] = useState(0);
            const [lastUpdate, setLastUpdate] = useState('„Éá„Éº„ÇøÂèñÂæó‰∏≠...');

            // --- Á∏¶„Éõ„Ç§„Éº„É´„ÅÆ„ÅøÊúâÂäπ„Å´„Åô„ÇãÂá¶ÁêÜ ---
            useEffect(() => {
                const canvas = chartRef.current;
                if (!canvas) return;

                const handleWheel = (e) => {
                    // Ê®™„Éõ„Ç§„Éº„É´„ÅÆË™§Âãï‰ΩúÈò≤Ê≠¢
                    if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
                        e.preventDefault();
                    }
                };

                canvas.addEventListener('wheel', handleWheel, { passive: false });
                return () => canvas.removeEventListener('wheel', handleWheel);
            }, [allData]);

            // --- Helper Functions ---
            const formatNumber = (num) => Math.round(num).toLocaleString('ja-JP');
            
            const formatLargeNumber = (value) => {
                if (typeof value === 'number') {
                    const sign = value >= 0 ? '+' : '';
                    return sign + formatNumber(value) + 'ÂÑÑÂÜÜ';
                }
                return value.toString();
            };

            const calculateWeekLabels = (data) => {
                const weekCounter = {};
                return data.map(row => {
                    const date = new Date(row.date);
                    const year = date.getFullYear();
                    const month = date.getMonth() + 1;
                    const yearMonthKey = `${year}-${month}`;
                    if (!weekCounter[yearMonthKey]) {
                        weekCounter[yearMonthKey] = 1;
                    } else {
                        weekCounter[yearMonthKey]++;
                    }
                    const weekNum = weekCounter[yearMonthKey];
                    return {
                        ...row,
                        year: year,
                        month: month,
                        weekNum: weekNum,
                        displayDate: `${year}Âπ¥${month}Êúà${weekNum}ÈÄ±`,
                        tooltipDate: `${year}Âπ¥${month}ÊúàÁ¨¨${weekNum}ÈÄ±`
                    };
                });
            };

            const calculateStats = (data) => {
                const positiveData = data.filter(item => item.balance > 0).map(item => item.balance);
                const negativeData = data.filter(item => item.balance < 0).map(item => item.balance);
                
                const calcMedian = (arr) => {
                    if (arr.length === 0) return 0;
                    const sorted = [...arr].sort((a, b) => a - b);
                    const mid = Math.floor(sorted.length / 2);
                    return sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid];
                };
                
                const calcAverage = (arr) => {
                    if (arr.length === 0) return 0;
                    return arr.reduce((sum, val) => sum + val, 0) / arr.length;
                };
                
                return {
                    positiveAvg: calcAverage(positiveData),
                    positiveMedian: calcMedian(positiveData),
                    negativeAvg: calcAverage(negativeData),
                    negativeMedian: calcMedian(negativeData),
                    latest: data[data.length - 1]
                };
            };

            const getFormattedReleaseDate = (lastDateStr) => {
                // CSV„ÅÆÊó•‰ªòÔºàÈáëÊõúÊó•Ôºâ„Åã„Çâ„ÄÅÁô∫Ë°®Êó•ÔºàÁøåÈÄ±Êú®ÊõúÊó•Ôºâ„ÇíË®àÁÆó„Åô„Çã
                try {
                    const date = new Date(lastDateStr);
                    if (isNaN(date.getTime())) return lastDateStr;

                    // +6Êó•„Åó„Å¶Êú®ÊõúÊó•„Å®„Åô„Çã (ÈáëÊõúÂâçÊèê)
                    const releaseDate = new Date(date);
                    releaseDate.setDate(date.getDate() + 6);

                    const y = releaseDate.getFullYear();
                    const m = String(releaseDate.getMonth() + 1).padStart(2, '0');
                    const d = String(releaseDate.getDate()).padStart(2, '0');
                    
                    return `${y}-${m}-${d}-18:00`;
                } catch (e) {
                    return lastDateStr;
                }
            };

            // --- Chart Actions ---
            const zoomChart = (direction) => {
                if (!chartInstance.current) return;
                const zoomFactor = direction === 'in' ? 1.2 : 0.8;
                chartInstance.current.zoom(zoomFactor);
                updateStatsFromChart();
            };

            const panChart = (direction) => {
                if (!chartInstance.current) return;
                const chart = chartInstance.current;
                const xScale = chart.scales.x;
                const range = xScale.max - xScale.min;
                const shift = range * 0.2;
                if (direction === 'left') chart.pan({ x: shift });
                else if (direction === 'right') chart.pan({ x: -shift });
                updateStatsFromChart();
            };

            const resetZoom = () => {
                if (!chartInstance.current) return;
                chartInstance.current.resetZoom();
                updateStatsFromChart();
            };

            const updateStatsFromChart = () => {
                if (!chartInstance.current) return;
                const chart = chartInstance.current;
                const xScale = chart.scales.x;
                const filtered = getFilteredData(allData, currentTimeRange);
                
                // Chart.js„ÅÆ„Çπ„Ç±„Éº„É´ÁØÑÂõ≤„Åã„ÇâË°®Á§∫„Éá„Éº„Çø„ÇíÁâπÂÆö
                const startIndex = Math.max(0, Math.floor(xScale.min));
                const endIndex = Math.min(filtered.length - 1, Math.ceil(xScale.max));
                const visibleData = filtered.slice(startIndex, endIndex + 1);
                
                if (visibleData.length > 0) {
                    const s = calculateStats(visibleData);
                    setStats(s);
                }
            };

            // --- Data Logic ---
            const getFilteredData = (data, range) => {
                if (range === 'all') return data;
                const now = new Date();
                const cutoffDate = new Date();
                if (range === '3m') cutoffDate.setMonth(now.getMonth() - 3);
                else if (range === '6m') cutoffDate.setMonth(now.getMonth() - 6);
                else if (range === '1y') cutoffDate.setFullYear(now.getFullYear() - 1);
                return data.filter(item => new Date(item.date) >= cutoffDate);
            };

            const drawChart = (data) => {
                if (!chartRef.current) return;
                const ctx = chartRef.current.getContext('2d');
                if (chartInstance.current) chartInstance.current.destroy();

                const config = {
                    type: 'bar',
                    data: {
                        datasets: [{
                            label: 'Â∑ÆÂºïÔºàÂÑÑÂÜÜÔºâ',
                            data: data.map((d, index) => ({ x: index, y: d.balance })),
                            backgroundColor: (ctx) => {
                                if (!ctx.parsed || ctx.parsed.y === undefined) return 'rgba(74, 134, 232, 0.7)';
                                return ctx.parsed.y >= 0 ? 'rgba(74, 134, 232, 0.7)' : 'rgba(230, 124, 115, 0.7)';
                            },
                            borderColor: (ctx) => {
                                if (!ctx.parsed || ctx.parsed.y === undefined) return '#4A86E8';
                                return ctx.parsed.y >= 0 ? '#4A86E8' : '#E67C73';
                            },
                            borderWidth: 1,
                            barPercentage: 0.9,
                            categoryPercentage: 0.9
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'white',
                                titleColor: '#334155',
                                bodyColor: '#334155',
                                borderColor: '#e2e8f0',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    title: (context) => {
                                        const index = Math.round(context[0].parsed.x);
                                        return data[index]?.tooltipDate || '';
                                    },
                                    label: (context) => {
                                        const index = Math.round(context.parsed.x);
                                        if (index >= 0 && index < data.length) {
                                            const val = data[index].balance;
                                            const raw = data[index].rawBalance;
                                            const sign = val >= 0 ? '+' : '';
                                            return `${sign}${formatNumber(val)}ÂÑÑÂÜÜ (${sign}${(raw * 1000).toLocaleString('ja-JP')}ÂÜÜ)`;
                                        }
                                        return '';
                                    },
                                    afterLabel: (context) => {
                                        return context.parsed.y >= 0 ? 'Ë≤∑„ÅÑË∂ä„Åó' : 'Â£≤„ÇäË∂ä„Åó';
                                    }
                                }
                            },
                            zoom: {
                                pan: { enabled: true, mode: 'x', threshold: 0 },
                                zoom: {
                                    wheel: { enabled: true, speed: 0.1 },
                                    pinch: { enabled: true },
                                    mode: 'x',
                                    onZoomComplete: updateStatsFromChart
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: (value, index, ticks) => {
                                        return index === ticks.length - 1 ? formatNumber(value) + 'ÂÑÑÂÜÜ' : formatNumber(value);
                                    }
                                },
                                grid: { color: '#e2e8f0' }
                            },
                            x: {
                                type: 'linear',
                                min: 0,
                                max: data.length - 1,
                                ticks: {
                                    callback: (value) => {
                                        const idx = Math.round(value);
                                        return data[idx]?.displayDate || '';
                                    },
                                    maxRotation: 45,
                                    minRotation: 45,
                                    autoSkip: true,
                                    maxTicksLimit: 20
                                },
                                grid: { color: '#e2e8f0' }
                            }
                        }
                    }
                };

                chartInstance.current = new Chart(ctx, config);
            };

            // --- Effects ---
            useEffect(() => {
                const loadData = async () => {
                    try {
                        const res = await fetch('history.csv');
                        const text = res.ok ? await res.text() : null;
                        
                        if (!text) throw new Error("CSV load failed");

                        Papa.parse(text, {
                            header: true,
                            dynamicTyping: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                const raw = results.data
                                    .filter(r => r.date && r.balance != null)
                                    .map(r => ({
                                        date: r.date,
                                        balance: r.balance / 100000,
                                        rawBalance: r.balance
                                    }))
                                    .sort((a, b) => new Date(a.date) - new Date(b.date));
                                
                                const processed = calculateWeekLabels(raw);
                                setAllData(processed);
                                
                                if (processed.length > 0) {
                                    const last = processed[processed.length - 1];
                                    const releaseStr = getFormattedReleaseDate(last.date);
                                    setLastUpdate(`ÊúÄÁµÇÊõ¥Êñ∞: ${releaseStr}`);
                                }
                            }
                        });
                    } catch (e) {
                        console.error(e);
                        setLastUpdate("„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
                    }
                };
                loadData();
                const interval = setInterval(loadData, 5 * 60 * 1000);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                if (allData.length === 0) return;
                const filtered = getFilteredData(allData, currentTimeRange);
                setDataCount(filtered.length);
                drawChart(filtered);
                setStats(calculateStats(filtered));
            }, [allData, currentTimeRange]);


            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="gradient-bg text-white shadow-lg rounded-xl -mx-4 md:mx-0 p-6 md:p-8 mb-8 animate-fade-in-up">
                        <h1 className="text-3xl md:text-4xl font-bold mb-2">JPX Êµ∑Â§ñÊäïË≥áÂÆ∂ÂãïÂêë</h1>
                        <p className="text-blue-100 text-sm mt-2">{lastUpdate}</p>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6 animate-fade-in-up">
                        <h2 className="text-xl font-bold text-slate-900 mb-4">
                            Â∑ÆÂºïÊé®Áßª <span className="text-sm font-normal text-slate-500 ml-2">({dataCount}‰ª∂„ÅÆ„Éá„Éº„Çø)</span>
                        </h2>
                        
                        <div style={{ position: 'relative', height: '500px' }}>
                            <canvas ref={chartRef}></canvas>
                            
                            {/* Zoom Buttons */}
                            <div style={{ position: 'absolute', bottom: '90px', left: '80px', display: 'flex', gap: '8px', zIndex: 10 }}>
                                <button onClick={() => zoomChart('in')} className="px-3 py-2 bg-white/90 backdrop-blur text-slate-700 rounded-lg shadow-md hover:bg-white transition-colors text-sm font-medium border border-slate-300">Ôºã</button>
                                <button onClick={() => zoomChart('out')} className="px-3 py-2 bg-white/90 backdrop-blur text-slate-700 rounded-lg shadow-md hover:bg-white transition-colors text-sm font-medium border border-slate-300">„Éº</button>
                            </div>
                            
                            {/* Pan Buttons */}
                            <div style={{ position: 'absolute', bottom: '90px', right: '20px', display: 'flex', gap: '8px', zIndex: 10 }}>
                                <button onClick={() => panChart('left')} className="px-3 py-2 bg-white/90 backdrop-blur text-slate-700 rounded-lg shadow-md hover:bg-white transition-colors text-sm font-medium border border-slate-300">‚Üê Â∑¶„Å∏</button>
                                <button onClick={() => panChart('right')} className="px-3 py-2 bg-white/90 backdrop-blur text-slate-700 rounded-lg shadow-md hover:bg-white transition-colors text-sm font-medium border border-slate-300">Âè≥„Å∏ ‚Üí</button>
                            </div>
                        </div>
                        
                        <div className="mt-4 pt-4 border-t border-slate-200">
                            <p className="text-xs text-slate-500">
                                üí° PC: „Éâ„É©„ÉÉ„Ç∞„ÅßÂ∑¶Âè≥ÁßªÂãï„ÄÅ„Éõ„Ç§„Éº„É´(Á∏¶)„Åß„Ç∫„Éº„É† | „Çπ„Éû„Éõ: „Éî„É≥„ÉÅ„Ç§„É≥„Éª„Ç¢„Ç¶„Éà„Åß„Ç∫„Éº„É†„ÄÅ„Çπ„ÉØ„Ç§„Éó„ÅßÁßªÂãï
                            </p>
                        </div>
                    </div>

                    {/* Stats Cards */}
                    {stats && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6 animate-fade-in-up">
                            {[
                                { label: 'ÊúÄÊñ∞ÈÄ±ÔºàÂÖàÈÄ±Ôºâ„ÅÆÂ£≤Ë≤∑Áä∂Ê≥Å', value: stats.latest.balance, color: stats.latest.balance >= 0 ? 'text-blue-600' : 'text-red-500', sub: stats.latest.balance >= 0 ? 'Ë≤∑„ÅÑË∂ä„Åó' : 'Â£≤„ÇäË∂ä„Åó' },
                                { label: 'Ë≤∑„ÅÑË∂ä„Åó Âπ≥Âùá', value: stats.positiveAvg, color: 'text-blue-600', sub: 'Ë°®Á§∫ÁØÑÂõ≤ÂÜÖ' },
                                { label: 'Ë≤∑„ÅÑË∂ä„Åó ‰∏≠Â§ÆÂÄ§', value: stats.positiveMedian, color: 'text-blue-600', sub: 'Ë°®Á§∫ÁØÑÂõ≤ÂÜÖ' },
                                { label: 'Â£≤„ÇäË∂ä„Åó Âπ≥Âùá', value: stats.negativeAvg, color: 'text-red-500', sub: 'Ë°®Á§∫ÁØÑÂõ≤ÂÜÖ' },
                                { label: 'Â£≤„ÇäË∂ä„Åó ‰∏≠Â§ÆÂÄ§', value: stats.negativeMedian, color: 'text-red-500', sub: 'Ë°®Á§∫ÁØÑÂõ≤ÂÜÖ' },
                            ].map((s, i) => (
                                <div key={i} className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                    <p className="text-slate-600 text-sm font-medium mb-2">{s.label}</p>
                                    <p className={`text-3xl font-bold ${s.color}`}>{formatLargeNumber(s.value)}</p>
                                    <p className="text-slate-400 text-xs mt-1">{s.sub}</p>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Controls */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 animate-fade-in-up">
                        <div className="flex flex-wrap gap-4 items-center">
                            <div className="flex items-center gap-2">
                                <span className="text-slate-600 text-sm font-medium">ÊúüÈñì:</span>
                                <div className="flex gap-1">
                                    {[
                                        { v: 'all', l: 'ÂÖ®ÊúüÈñì' },
                                        { v: '1y', l: '1Âπ¥' },
                                        { v: '6m', l: '6„É∂Êúà' },
                                        { v: '3m', l: '3„É∂Êúà' }
                                    ].map(opt => (
                                        <button 
                                            key={opt.v}
                                            onClick={() => setCurrentTimeRange(opt.v)}
                                            className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${currentTimeRange === opt.v ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                        >
                                            {opt.l}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <button onClick={resetZoom} className="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition-colors text-sm font-medium">
                                üîÑ „Ç∫„Éº„É†„É™„Çª„ÉÉ„Éà
                            </button>
                        </div>
                    </div>

                    <div className="mt-8 text-center text-slate-500 text-sm">
                        <p>„Éá„Éº„Çø„ÇΩ„Éº„Çπ: <a href="https://www.jpx.co.jp/markets/statistics-equities/investor-type/00-00-archives-00.html" target="_blank" className="text-blue-600 hover:underline">Êó•Êú¨ÂèñÂºïÊâÄ„Ç∞„É´„Éº„Éó (JPX)</a></p>
                    </div>
                </div>
            );
        };

        // ==========================================
        //  Option OI Components (Updated for Step)
        // ==========================================
        const processOptionData = (rawRows, step = 50) => {
            if (!rawRows || rawRows.length < 2) return { data: [], error: '„Éá„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ' };
            const strikeRegex = /(strike|Ë°å‰Ωø‰æ°Ê†º|koushi)/i;
            const oiRegex = /(open\s*int|oi|Âª∫Áéâ|tategyoku)/i;
            const parseNum = (val) => {
                if (typeof val === 'number') return val;
                if (!val) return 0;
                let str = String(val).toUpperCase();
                let multiplier = 1;
                if (str.endsWith('K')) multiplier = 1000;
                else if (str.endsWith('M')) multiplier = 1000000;
                str = str.replace(/[^0-9.-]/g, '').trim(); 
                const num = parseFloat(str);
                return isNaN(num) ? 0 : num * multiplier;
            };

            let reshapeHeaderIndex = -1;
            let reshapeWidth = 0;
            const getHeaderInfo = (row) => {
                const sRow = row.map(c => String(c).trim());
                let sCol = -1, oiCols = [];
                sRow.forEach((cell, i) => {
                    if (strikeRegex.test(cell)) sCol = i;
                    else if (oiRegex.test(cell)) oiCols.push(i);
                });
                return { sCol, oiCols, colCount: row.length };
            };

            for (let r = 0; r < Math.min(rawRows.length, 50); r++) {
                const info = getHeaderInfo(rawRows[r]);
                if (info.sCol !== -1 && info.oiCols.length >= 2 && info.colCount > 1) {
                    let singleColCount = 0;
                    const checkCount = 10;
                    for(let k=1; k<=checkCount && (r+k)<rawRows.length; k++) {
                        if (rawRows[r+k].length === 1 || rawRows[r+k].length < info.colCount / 2) singleColCount++;
                    }
                    if (singleColCount >= 5) {
                        reshapeHeaderIndex = r;
                        reshapeWidth = info.colCount;
                        break;
                    }
                }
            }

            if (reshapeWidth > 0 && reshapeHeaderIndex !== -1) {
                const headerRow = rawRows[reshapeHeaderIndex];
                const flatData = [];
                for (let i = reshapeHeaderIndex + 1; i < rawRows.length; i++) {
                    const row = rawRows[i];
                    for (const cell of row) {
                        if (cell !== null && cell !== undefined && String(cell).trim() !== '') flatData.push(cell);
                    }
                }
                const newRows = [headerRow];
                let currentChunk = [];
                for (const cell of flatData) {
                    currentChunk.push(cell);
                    if (currentChunk.length === reshapeWidth) {
                        newRows.push(currentChunk);
                        currentChunk = [];
                    }
                }
                rawRows = newRows;
            }

            let bestCandidate = { headerIndex: -1, strikeCol: -1, callCol: -1, putCol: -1, score: 0 };
            for (let r = 0; r < Math.min(rawRows.length, 50); r++) {
                const row = rawRows[r].map(c => String(c).trim());
                let sCol = -1, oiCols = [];
                row.forEach((cell, i) => {
                    if (strikeRegex.test(cell)) sCol = i;
                    else if (oiRegex.test(cell)) oiCols.push(i);
                });
                if (sCol !== -1 && oiCols.length >= 2) {
                    let cCol = -1, pCol = -1;
                    const oi1 = row[oiCols[0]].toLowerCase();
                    const oi2 = row[oiCols[1]].toLowerCase();
                    if (oi1.includes('call') || oi1.includes('„Ç≥„Éº„É´')) { cCol = oiCols[0]; }
                    if (oi1.includes('put') || oi1.includes('„Éó„ÉÉ„Éà')) { pCol = oiCols[0]; }
                    if (oi2.includes('call') || oi2.includes('„Ç≥„Éº„É´')) { cCol = oiCols[1]; }
                    if (oi2.includes('put') || oi2.includes('„Éó„ÉÉ„Éà')) { pCol = oiCols[1]; }
                    if (cCol === -1 || pCol === -1) { cCol = oiCols[0]; pCol = oiCols[1]; }
                    bestCandidate = { headerIndex: r, strikeCol: sCol, callCol: cCol, putCol: pCol, score: 10 };
                    break;
                }
            }

            if (bestCandidate.headerIndex === -1) return { data: [], error: '„Éò„ÉÉ„ÉÄ„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ' };

            const { headerIndex, strikeCol, callCol, putCol } = bestCandidate;
            const dataMap = new Map();
            const safeStep = step > 0 ? step : 1; // Prevent division by zero

            for (let i = headerIndex + 1; i < rawRows.length; i++) {
                const row = rawRows[i];
                if (!row || row.length <= Math.max(strikeCol, callCol, putCol)) continue;
                const strike = parseNum(row[strikeCol]);
                const oi1 = parseNum(row[callCol]);
                const oi2 = parseNum(row[putCol]);
                if (strike > 0) {
                    // „Åì„Åì„ÇíÂ§âÊõ¥: step„Å´„Çà„ÇãÂãïÁöÑÂàª„Åø
                    const roundedStrike = Math.round(strike / safeStep) * safeStep;
                    if (!dataMap.has(roundedStrike)) dataMap.set(roundedStrike, { call: 0, put: 0 });
                    const d = dataMap.get(roundedStrike);
                    d.call += oi1;
                    d.put += oi2;
                }
            }

            const sortedData = Array.from(dataMap.entries())
                .sort((a, b) => b[0] - a[0])
                .map(([strike, val]) => ({ strike, diff: val.call - val.put, call: val.call, put: val.put }));

            return { data: sortedData, error: sortedData.length === 0 ? "ÊúâÂäπ„Å™„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü" : null };
        };

        const DataInput = ({ onDataParsed }) => {
            const [text, setText] = useState('');
            const [dragActive, setDragActive] = useState(false);
            const handleParse = (input) => {
                Papa.parse(input, {
                    complete: (results) => onDataParsed(results.data),
                    skipEmptyLines: true,
                    header: false 
                });
            };
            const handleDrop = (e) => {
                e.preventDefault();
                setDragActive(false);
                if (e.dataTransfer.files?.[0]) handleParse(e.dataTransfer.files[0]);
            };
            return (
                <div className="max-w-3xl mx-auto bg-white rounded-xl shadow border border-slate-200 p-6 space-y-6">
                    <div 
                        className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${dragActive ? 'border-blue-500 bg-blue-50' : 'border-slate-300 hover:bg-slate-50'}`}
                        onDragOver={(e) => { e.preventDefault(); setDragActive(true); }}
                        onDragLeave={() => setDragActive(false)}
                        onDrop={handleDrop}
                    >
                        <Icon name="Upload" className="mx-auto text-slate-400 mb-2" size={32} />
                        <p className="text-slate-600 font-medium">CSV„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó</p>
                        <p className="text-slate-400 text-sm">„Åæ„Åü„ÅØ</p>
                        <input type="file" className="mt-2 text-sm text-slate-500" onChange={(e) => e.target.files?.[0] && handleParse(e.target.files[0])} />
                    </div>
                    <div className="flex gap-2">
                        <textarea 
                            className="flex-1 border border-slate-300 rounded-lg p-3 text-sm font-mono focus:ring-2 focus:ring-blue-500 outline-none"
                            rows={4}
                            placeholder="„Åì„Åì„Å´„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë..."
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                        />
                        <button onClick={() => handleParse(text)} disabled={!text} className="bg-slate-800 text-white px-4 rounded-lg hover:bg-slate-700 disabled:opacity-50 font-medium">Ëß£Êûê</button>
                    </div>
                </div>
            );
        };

        const OIChart = ({ data, step, setStep }) => {
            const [zoomY, setZoomY] = useState(1);
            const [zoomX, setZoomX] = useState(1);
            const mainRef = useRef(null);
            const leftRef = useRef(null);
            const bottomRef = useRef(null);
            const handleScroll = () => {
                if (mainRef.current && leftRef.current && bottomRef.current) {
                    leftRef.current.scrollTop = mainRef.current.scrollTop;
                    bottomRef.current.scrollLeft = mainRef.current.scrollLeft;
                }
            };
            const barHeight = 30;
            const totalHeight = Math.max(600, data.length * barHeight * zoomY);
            const chartWidth = `${zoomX * 100}%`;
            const maxVal = Math.max(...data.map(d => Math.abs(d.diff)), 100);
            const handleWheel = (e, axis) => {
                if (e.ctrlKey || axis === 'main') return; 
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                if (axis === 'y') setZoomY(z => Math.max(0.1, Math.min(5, z + delta)));
                if (axis === 'x') setZoomX(z => Math.max(0.5, Math.min(3, z + delta)));
            };
            const CustomTooltip = ({ active, payload, label }) => {
                if (!active || !payload?.length) return null;
                const d = payload[0].payload;
                return (
                    <div className="bg-white p-3 border border-slate-200 shadow-lg rounded text-sm z-50">
                        <p className="font-bold">Strike: {label}</p>
                        <p className={d.diff >= 0 ? 'text-blue-600' : 'text-red-500'}>Diff: {d.diff.toLocaleString()}</p>
                        <div className="text-xs text-slate-500 mt-1 pt-1 border-t">C: {d.call.toLocaleString()} / P: {d.put.toLocaleString()}</div>
                    </div>
                );
            };
            return (
                <div className="bg-white rounded-xl shadow border border-slate-200 h-[80vh] flex flex-col overflow-hidden">
                    <div className="p-2 border-b border-slate-100 flex items-center gap-4 bg-slate-50 shrink-0 flex-wrap">
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-slate-500">HEIGHT</span>
                            <button onClick={()=>setZoomY(z=>Math.max(0.1, z-0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomOut" size={16}/></button>
                            <input type="range" min="0.1" max="5" step="0.1" value={zoomY} onChange={(e)=>setZoomY(parseFloat(e.target.value))} className="w-20" />
                            <button onClick={()=>setZoomY(z=>Math.min(5, z+0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomIn" size={16}/></button>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-slate-500">WIDTH</span>
                            <button onClick={()=>setZoomX(z=>Math.max(0.5, z-0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomOut" size={16}/></button>
                            <button onClick={()=>setZoomX(z=>Math.min(3, z+0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomIn" size={16}/></button>
                        </div>
                        {/* Âàª„ÅøÂπÖÂ§âÊõ¥ÂÖ•Âäõ */}
                        <div className="flex items-center gap-2 border-l pl-4 border-slate-200">
                            <span className="text-xs font-bold text-slate-500">STEP</span>
                            <input 
                                type="number" 
                                className="border border-slate-300 rounded px-1 py-0.5 text-xs w-16 text-center focus:outline-none focus:border-blue-500"
                                value={step}
                                onChange={(e) => setStep(parseFloat(e.target.value) || 0)}
                                min="0.1"
                            />
                        </div>
                        <button onClick={()=>{setZoomY(1);setZoomX(1);}} className="ml-auto text-xs flex items-center gap-1 hover:text-blue-600 border px-2 py-1 rounded bg-white"><Icon name="RotateCcw" size={14}/> Reset</button>
                    </div>
                    <div className="flex-1 flex overflow-hidden relative">
                        <div className="w-24 border-r border-slate-200 bg-slate-50 shrink-0 overflow-hidden" ref={leftRef} onWheel={(e)=>handleWheel(e, 'y')}>
                            <div style={{height: totalHeight, width: '100%'}}>
                                <ResponsiveContainer>
                                    <BarChart layout="vertical" data={data} margin={{top:10, bottom:0}}>
                                        <YAxis type="category" dataKey="strike" width={90} tick={{fontSize:12, fontWeight:600}} interval={0} />
                                        <Bar dataKey="diff" fill="transparent" />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                        <div className="flex-1 overflow-auto bg-slate-50/30" ref={mainRef} onScroll={handleScroll}>
                            <div style={{width: chartWidth, height: totalHeight, minWidth: '100%'}}>
                                <ResponsiveContainer>
                                    <BarChart layout="vertical" data={data} margin={{top:10, right:30, left:0, bottom:0}}>
                                        <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={true} />
                                        <XAxis type="number" domain={[-maxVal, maxVal]} hide />
                                        <YAxis type="category" width={0} tick={false} />
                                        <Tooltip content={<CustomTooltip />} cursor={{fill:'rgba(0,0,0,0.05)'}} />
                                        <ReferenceLine x={0} stroke="#334155" />
                                        <Bar dataKey="diff" barSize={barHeight * 0.8}>
                                            {data.map((entry, index) => (<Cell key={index} fill={entry.diff >= 0 ? '#4A86E8' : '#E67C73'} />))}
                                            <LabelList dataKey="diff" position="insideRight" formatter={(v)=>v.toLocaleString()} style={{fontSize:11, fill:'#64748b'}} />
                                        </Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                    <div className="h-8 border-t border-slate-200 flex shrink-0">
                        <div className="w-24 border-r border-slate-200 bg-slate-100 flex items-center justify-center text-slate-400"><Icon name="MousePointer2" size={14} /></div>
                        <div className="flex-1 overflow-hidden bg-slate-50" ref={bottomRef} onWheel={(e)=>handleWheel(e, 'x')}>
                            <div style={{width: chartWidth, minWidth:'100%', height:'100%'}}>
                                <ResponsiveContainer>
                                    <BarChart layout="vertical" data={[{}]} margin={{right:30, left:0}}>
                                        <XAxis type="number" domain={[-maxVal, maxVal]} tick={{fontSize:10}} />
                                        <YAxis type="category" width={0} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const OptionOI = () => {
            const [data, setData] = useState([]);
            const [hasData, setHasData] = useState(false);
            const [error, setError] = useState(null);
            
            // --- State ---
            const [ticker, setTicker] = useState('');
            const [rawRows, setRawRows] = useState(null); // Áîü„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åó„Å¶StepÂ§âÊõ¥ÊôÇ„Å´ÂÜçË®àÁÆó
            const [step, setStep] = useState(50); // „Éá„Éï„Ç©„É´„Éà50

            // Áîü„Éá„Éº„Çø„Åæ„Åü„ÅØStep„ÅåÂ§âÊõ¥„Åï„Çå„Åü„ÇâÂÜçË®àÁÆó
            useEffect(() => {
                if (rawRows) {
                    const res = processOptionData(rawRows, step);
                    if (res.error) {
                        setError(res.error);
                        setData([]);
                    } else {
                        setData(res.data);
                        setError(null);
                    }
                }
            }, [rawRows, step]);

            const handleData = (rows) => {
                setRawRows(rows);
                setHasData(true);
            };

            // --- ÈÅ∑Áßª„Éè„É≥„Éâ„É© ---
            const handleTickerNav = () => {
                if(!ticker) return;
                const symbol = ticker.trim().toUpperCase();
                window.open(`https://optioncharts.io/options/${symbol}/option-chain`, '_blank');
            };

            // --- Âõ∫ÂÆö„É™„É≥„ÇØ‰∏ÄË¶ß ---
            const links = [
                { label: 'QQQ', url: 'https://optioncharts.io/options/QQQ/option-chain' },
                { label: 'SPY', url: 'https://optioncharts.io/options/SPY/option-chain' },
                { label: 'DJI', url: 'https://optioncharts.io/options/$DJX/option-chain' },
                { label: 'IWM', url: 'https://optioncharts.io/options/IWM/option-chain' },
                { label: 'VIX', url: 'https://optioncharts.io/options/$VIX/option-chain' },
                { label: 'NVIDIA', url: 'https://optioncharts.io/options/NVDA/option-chain' },
                { label: 'APPL', url: 'https://optioncharts.io/options/AAPL/option-chain' },
                { label: 'AMZN', url: 'https://optioncharts.io/options/AMZN/option-chain' },
                { label: 'GLD', url: 'https://optioncharts.io/options/GLD/option-chain' },
                { label: 'SLV', url: 'https://optioncharts.io/options/SLV/option-chain' },
            ];

            return (
                <div className="h-full flex flex-col">
                    <div className="flex justify-between items-center mb-6">
                        <div><h2 className="text-2xl font-bold text-slate-800">Option ÂàÜÊûê</h2><p className="text-slate-500">Âª∫Áéâ„ÅÆÂ£Å„ÇíÂèØË¶ñÂåñ</p></div>
                        {hasData && <button onClick={()=>{setHasData(false); setRawRows(null); setData([]);}} className="text-sm text-red-500 hover:underline">„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢</button>}
                    </div>
                    {error && <div className="mb-4 p-3 bg-red-50 text-red-600 rounded flex items-center gap-2"><Icon name="AlertTriangle" />{error}</div>}
                    {!hasData ? (
                        <div className="flex flex-col items-center justify-center py-12">
                             {/* Âõ∫ÂÆö„É™„É≥„ÇØÁæ§ */}
                             <div className="mb-6 flex flex-wrap justify-center gap-x-4 gap-y-2 max-w-4xl px-4">
                                {links.map(l => (
                                    <a key={l.label} href={l.url} target="_blank" className="text-blue-600 hover:underline text-sm font-medium flex items-center gap-1">
                                        {l.label} <Icon name="ExternalLink" size={10} />
                                    </a>
                                ))}
                             </div>

                             {/* „ÉÜ„Ç£„ÉÉ„Ç´„ÉºÂÖ•Âäõ„Éï„Ç©„Éº„É† */}
                             <div className="mb-10 flex items-center gap-2">
                                <span className="text-sm text-slate-500 font-bold">Ticker:</span>
                                <input 
                                    type="text" 
                                    className="border border-slate-300 rounded px-2 py-1 text-sm w-24 focus:outline-none focus:border-blue-500"
                                    placeholder="e.g. TSLA"
                                    value={ticker}
                                    onChange={(e)=>setTicker(e.target.value)}
                                    onKeyDown={(e)=>e.key === 'Enter' && handleTickerNav()}
                                />
                                <button onClick={handleTickerNav} className="bg-slate-800 text-white text-xs px-3 py-1.5 rounded hover:bg-slate-700 font-medium">Go</button>
                             </div>

                             <DataInput onDataParsed={handleData} />
                        </div>
                    ) : (<OIChart data={data} step={step} setStep={setStep} />)}
                </div>
            );
        };

        // ==========================================
        //  Main Layout
        // ==========================================
        const App = () => {
            // ÂàùÊúü„Éì„É•„Éº„Çí 'option' „Å´Â§âÊõ¥
            const [view, setView] = useState('option');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            
            // --- „Ç´„Çπ„Çø„É†„É™„É≥„ÇØ„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ ---
            const [customLinks, setCustomLinks] = useState(() => {
                const saved = localStorage.getItem('market-dash-links');
                return saved ? JSON.parse(saved) : [];
            });
            const [isAddingLink, setIsAddingLink] = useState(false);
            const [newLinkLabel, setNewLinkLabel] = useState('');
            const [newLinkUrl, setNewLinkUrl] = useState('');

            const addCustomLink = () => {
                if (newLinkLabel && newLinkUrl) {
                    let url = newLinkUrl;
                    if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
                    const updated = [...customLinks, { label: newLinkLabel, url }];
                    setCustomLinks(updated);
                    localStorage.setItem('market-dash-links', JSON.stringify(updated));
                    setNewLinkLabel('');
                    setNewLinkUrl('');
                    setIsAddingLink(false);
                }
            };

            const removeCustomLink = (index) => {
                const updated = customLinks.filter((_, i) => i !== index);
                setCustomLinks(updated);
                localStorage.setItem('market-dash-links', JSON.stringify(updated));
            };

            const NavItem = ({ id, label, icon }) => (
                <button onClick={() => { setView(id); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${view === id ? 'bg-blue-600 text-white shadow' : 'text-slate-600 hover:bg-slate-100'}`}>
                    <Icon name={icon} /><span className="font-medium">{label}</span>
                </button>
            );

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className={`fixed lg:static inset-y-0 left-0 z-50 w-64 bg-white border-r border-slate-200 transform transition-transform ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'} shadow-xl lg:shadow-none flex flex-col`}>
                        {/* „Ç∑„É≥„Éó„É´„Å™‰∏äÈÉ®„Çπ„Éö„Éº„Çπ („É≠„Ç¥ÂâäÈô§) */}
                        <div className="h-6"></div>
                        
                        <div className="flex-1 overflow-y-auto overflow-x-hidden p-4 space-y-2 flex flex-col relative">
                            <div className="text-xs font-bold text-slate-400 px-2 mb-2">MENU</div>
                            {/* „É°„Éã„É•„ÉºÈ†ÜÂ∫èÂ§âÊõ¥: Option„Çí‰∏ä„Å´ */}
                            <NavItem id="option" label="Option ÂàÜÊûê" icon="BarChart3" />
                            <NavItem id="jpx" label="JPX Êµ∑Â§ñÊäïË≥áÂÆ∂ÂãïÂêë" icon="LineChart" />
                            
                            {/* „Çπ„Éö„Éº„Çµ„Éº */}
                            <div className="flex-1 min-h-[20px]"></div>

                            {/* „Ç´„Çπ„Çø„É†„É™„É≥„ÇØ‰∏ÄË¶ß (‰∏ã„Åã„ÇâÁ©ç„Åø‰∏ä„Åí) */}
                            {customLinks.length > 0 && (
                                <div className="space-y-1 mb-4 pb-12">
                                    <div className="text-xs font-bold text-slate-400 px-2 mb-2">QUICK LINKS</div>
                                    <div className="flex flex-col-reverse gap-1">
                                        {customLinks.map((link, i) => (
                                            <div key={i} className="group flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-slate-100 transition-colors">
                                                <a href={link.url} target="_blank" rel="noopener noreferrer" className="flex-1 flex items-center gap-2 text-slate-600 text-sm font-medium overflow-hidden">
                                                    <Icon name="ExternalLink" size={14} className="shrink-0" />
                                                    <span className="truncate">{link.label}</span>
                                                </a>
                                                <button onClick={() => removeCustomLink(i)} className="opacity-0 group-hover:opacity-100 p-1 text-slate-400 hover:text-red-500 transition-opacity">
                                                    <Icon name="Trash2" size={12} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* „É™„É≥„ÇØËøΩÂä†UI (ÊúÄ‰∏ãÈÉ®Âõ∫ÂÆöÈ¢®) */}
                            <div className="absolute bottom-4 left-0 right-0 px-4 flex justify-center">
                                {!isAddingLink ? (
                                    <button 
                                        onClick={() => setIsAddingLink(true)}
                                        className="w-10 h-10 flex items-center justify-center rounded-full bg-slate-50 border border-slate-200 text-slate-400 hover:text-blue-600 hover:bg-white hover:shadow-md transition-all duration-200"
                                        title="„É™„É≥„ÇØ„ÇíËøΩÂä†"
                                    >
                                        <Icon name="Plus" size={20} />
                                    </button>
                                ) : (
                                    <div className="w-full bg-white rounded-xl shadow-xl border border-slate-200 p-4 animate-fade-in-up">
                                        <div className="flex justify-between items-center mb-3">
                                            <p className="text-xs font-bold text-slate-500 uppercase">Add Link</p>
                                            <button onClick={() => setIsAddingLink(false)} className="text-slate-400 hover:text-slate-600"><Icon name="X" size={14}/></button>
                                        </div>
                                        <div className="space-y-3">
                                            <input 
                                                type="text" 
                                                placeholder="Name" 
                                                autoFocus
                                                className="w-full text-xs p-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition-all" 
                                                value={newLinkLabel}
                                                onChange={(e) => setNewLinkLabel(e.target.value)}
                                            />
                                            <input 
                                                type="text" 
                                                placeholder="URL" 
                                                className="w-full text-xs p-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition-all" 
                                                value={newLinkUrl}
                                                onChange={(e) => setNewLinkUrl(e.target.value)}
                                            />
                                            <button 
                                                onClick={addCustomLink}
                                                disabled={!newLinkLabel || !newLinkUrl}
                                                className="w-full bg-slate-800 text-white text-xs py-2 rounded-lg hover:bg-slate-700 disabled:opacity-50 font-bold transition-colors"
                                            >
                                                ËøΩÂä†
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </aside>

                    {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-40 lg:hidden" onClick={() => setSidebarOpen(false)}></div>}
                    
                    <div className="flex-1 flex flex-col min-w-0">
                        <header className="h-16 bg-white border-b border-slate-200 flex items-center px-4 lg:hidden shrink-0">
                            <button onClick={() => setSidebarOpen(true)} className="p-2 text-slate-600"><Icon name="Menu" /></button>
                            {/* „Çø„Ç§„Éà„É´Ë°®Á§∫„É≠„Ç∏„ÉÉ„ÇØ„ÇÇ„É°„Éã„É•„Éº„Å´Âêà„Çè„Åõ„Çã */}
                            <span className="ml-4 font-bold text-slate-700">{view === 'option' ? 'Option ÂàÜÊûê' : 'JPX Êµ∑Â§ñÊäïË≥áÂÆ∂ÂãïÂêë'}</span>
                        </header>
                        <main className="flex-1 overflow-auto p-4 md:p-6 bg-slate-50">
                            <div className="max-w-7xl mx-auto h-full">
                                {view === 'jpx' ? <ForeignInvestors /> : <OptionOI />}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
