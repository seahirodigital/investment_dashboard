<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Market Dashboard</title>
    
    <!-- „Éá„Ç∂„Ç§„É≥„Éª„Çπ„Çø„Ç§„É´ (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ReactÊú¨‰Ωì -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Recharts‰æùÂ≠ò -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    
    <!-- „Ç∞„É©„ÉïÊèèÁîª (Recharts) -->
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>

    <!-- CSVËß£Êûê (PapaParse) -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- „Ç¢„Ç§„Ç≥„É≥ (Lucide) -->
    <script src="https://unpkg.com/lucide@0.294.0/dist/umd/lucide.min.js"></script>

    <!-- JPX„ÉÅ„É£„Éº„ÉàÁî® (Chart.jsÈñ¢ÈÄ£) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- JSXÂ§âÊèõ (Babel) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        body { background-color: #f8fafc; font-family: 'Helvetica Neue', Arial, sans-serif; }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .lifetime-bg {
            background: linear-gradient(135deg, #6366F1 0%, #A855F7 100%);
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dragging {
            opacity: 0.5;
            background-color: #f1f5f9;
        }
        
        /* Calendar Specific Styles */
        .cal-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr) 100px; /* Sun(Labels), Mon-Fri, Sat(Total) */
            gap: 1px;
            background-color: #e2e8f0;
            border: 1px solid #e2e8f0;
        }
        .cal-cell {
            background-color: white;
            min-height: 100px;
            padding: 4px;
            position: relative;
        }
        .cal-header {
            background-color: #f8fafc;
            color: #64748b;
            font-size: 0.75rem;
            font-weight: bold;
            text-align: center;
            padding: 8px 0;
        }
        .cal-label-col {
            background-color: #f1f5f9;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 4px;
            font-size: 0.65rem;
            color: #64748b;
            padding-left: 8px;
            font-weight: 600;
        }
        .cal-total-col {
            background-color: #f8fafc;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-end;
            padding-right: 8px;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.4/",
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "papaparse": "https://esm.sh/papaparse@^5.5.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.563.0",
    "recharts": "https://esm.sh/recharts@^3.7.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Cell, ReferenceLine, ResponsiveContainer, LabelList } = Recharts;

        // --- „Ç¢„Ç§„Ç≥„É≥ ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Menu: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></svg>,
                LayoutDashboard: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
                LineChart: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>,
                BarChart3: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
                ExternalLink: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
                AlertTriangle: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
                Upload: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
                ZoomIn: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>,
                ZoomOut: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>,
                RotateCcw: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
                MousePointer2: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 6-8 13 4.5-1.5 3 7 3-7 4.5 1.5L12 6Z"/><path d="m6 13 6-3 6 3"/></svg>,
                Plus: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                Trash2: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
                Link: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
                X: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
                GripVertical: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>,
                FolderOpen: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2"/></svg>,
                Briefcase: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
                Calendar: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
                FileText: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>,
                Check: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
                Download: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
                ChevronLeft: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
                ChevronRight: <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>
            };
            return icons[name] || null;
        };

        // ==========================================
        //  Êñ∞Ë¶è„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà: ÂèéÁõäÁÆ°ÁêÜ„Ç´„É¨„É≥„ÉÄ„Éº (Profit Manager)
        // ==========================================
        const ProfitManager = () => {
            // --- State ---
            const [currentDate, setCurrentDate] = useState(new Date()); // Ë°®Á§∫‰∏≠„ÅÆÊúà
            const [historyData, setHistoryData] = useState({});
            const [selectedDate, setSelectedDate] = useState(null); // „É¢„Éº„ÉÄ„É´Ë°®Á§∫Áî®
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editData, setEditData] = useState({ stocks: 0, margin: 0, foreign: 0, cfd: 0, note: '' });
            const [modalTab, setModalTab] = useState('edit'); // 'edit' or 'preview'
            
            // --- Helper Functions ---
            const formatMoney = (val) => val ? val.toLocaleString() : '0';
            const getMonthKey = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            const getDateKey = (d) => {
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            };
            
            // --- Persistence ---
            useEffect(() => {
                const saved = localStorage.getItem('history_data');
                if (saved) {
                    try { setHistoryData(JSON.parse(saved)); } catch (e) { console.error("Load failed", e); }
                }
            }, []);

            const saveToStorage = (newData) => {
                setHistoryData(newData);
                localStorage.setItem('history_data', JSON.stringify(newData));
            };

            // --- Stats Calculation ---
            const stats = useMemo(() => {
                let lifetime = 0;
                let prevYear = 0;
                let monthTotal = 0;
                const currentMonthKey = getMonthKey(currentDate);
                const prevYearKey = (currentDate.getFullYear() - 1).toString(); // "2025" etc.

                // Â±•Ê≠¥„Éá„Éº„Çø„Åã„ÇâÈõÜË®à
                Object.entries(historyData).forEach(([key, val]) => {
                    // key„ÅåÊó•‰ªò "YYYY-MM-DD" „ÅÆÂ†¥Âêà
                    if (key.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const dayTotal = (val.stocks || 0) + (val.margin || 0) + (val.foreign || 0) + (val.cfd || 0);
                        lifetime += dayTotal;
                        if (key.startsWith(currentMonthKey)) {
                            monthTotal += dayTotal;
                        }
                        if (key.startsWith(prevYearKey)) {
                             // Êó•‰ªò„Éô„Éº„Çπ„ÅÆÂâçÂπ¥„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà
                             prevYear += dayTotal;
                        }
                    }
                    // key„ÅåÂπ¥ "YYYY" „ÅÆÂ†¥Âêà („Éû„Éã„É•„Ç¢„É´ÂÖ•Âäõ„ÅÆÈÅéÂéª„É≠„Ç∞„Å™„Å©)
                    else if (key === prevYearKey && val.total) {
                         prevYear += val.total;
                    }
                    else if (val.total) {
                        // „Åù„ÅÆ‰ªñ„ÅÆÂπ¥ÂêàË®à
                        lifetime += val.total;
                    }
                });

                return { lifetime, prevYear, monthTotal };
            }, [historyData, currentDate]);

            // --- Calendar Generation Logic ---
            const calendarWeeks = useMemo(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                
                const weeks = [];
                let currentWeek = [];
                
                // ÊúàÂàù„ÇÅ„ÅÆÁ©∫ÁôΩ„Éë„Éá„Ç£„É≥„Ç∞ÔºàÊó•„ÄúÂúü„ÅÆÊßãÈÄ†„Å´„ÅÇ„Çè„Åõ„ÇãÔºâ
                // Êó•ÊõúÂßã„Åæ„Çä: 0
                for (let i = 0; i < firstDay.getDay(); i++) {
                    currentWeek.push(null);
                }
                
                // Êó•‰ªòÂüã„ÇÅ
                for (let d = 1; d <= lastDay.getDate(); d++) {
                    const date = new Date(year, month, d);
                    currentWeek.push(date);
                    
                    if (date.getDay() === 6) { // ÂúüÊõú„ÅßÈÄ±ÁµÇ„Çè„Çä
                        weeks.push(currentWeek);
                        currentWeek = [];
                    }
                }
                
                // ÊúàÊú´„ÅÆ„Éë„Éá„Ç£„É≥„Ç∞
                if (currentWeek.length > 0) {
                    while (currentWeek.length < 7) {
                        currentWeek.push(null);
                    }
                    weeks.push(currentWeek);
                }
                
                return weeks;
            }, [currentDate]);

            // --- Modal Handlers ---
            const openModal = (date) => {
                if (!date) return;
                const key = getDateKey(date);
                const data = historyData[key] || { stocks: 0, margin: 0, foreign: 0, cfd: 0, note: '' };
                setSelectedDate(date);
                setEditData({ ...data }); // Copy
                setIsModalOpen(true);
            };

            const handleSave = () => {
                if (!selectedDate) return;
                const key = getDateKey(selectedDate);
                const newData = { ...historyData, [key]: editData };
                saveToStorage(newData);
                setIsModalOpen(false);
            };

            const handleExport = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                let md = `# ÊäïË≥áÊó•Ë®ò„É¨„Éù„Éº„ÉàÔºö${year}Âπ¥${month}ÊúàÂ∫¶\n`;
                md += `ÔºàÊúàÈñì„ÅÆÁ∑èÂêàË®àÂèéÊîØÔºö${stats.monthTotal > 0 ? '+' : ''}${stats.monthTotal.toLocaleString()}ÂÜÜÔºâ\n\n`;

                const sortedKeys = Object.keys(historyData).filter(k => k.startsWith(getMonthKey(currentDate))).sort();
                
                sortedKeys.forEach(key => {
                    const d = historyData[key];
                    const total = (d.stocks||0) + (d.margin||0) + (d.foreign||0) + (d.cfd||0);
                    if (total === 0 && !d.note) return;

                    md += `## ${key}\n`;
                    md += `### ÂèéÊîØ„Éá„Éº„Çø\n`;
                    md += `- ÁèæÁâ©: ${d.stocks||0} / ‰ø°Áî®: ${d.margin||0} / Êµ∑Â§ñ: ${d.foreign||0} / CFD: ${d.cfd||0}\n`;
                    md += `### ÊåØ„ÇäËøî„Çä\n`;
                    md += `${d.note || 'ÔºàË®òËºâ„Å™„ÅóÔºâ'}\n\n`;
                });

                const blob = new Blob([md], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `investment_diary_${year}_${month}.md`;
                a.click();
            };

            // --- Calendar Cell Component ---
            const DayCell = ({ date }) => {
                if (!date) return <div className="cal-cell bg-slate-50"></div>;
                
                const key = getDateKey(date);
                const data = historyData[key];
                const total = data ? (data.stocks||0) + (data.margin||0) + (data.foreign||0) + (data.cfd||0) : 0;
                const hasNote = data && data.note && data.note.trim().length > 0;
                const isToday = getDateKey(new Date()) === key;

                return (
                    <div 
                        onClick={() => openModal(date)}
                        className={`cal-cell cursor-pointer hover:bg-blue-50 transition-colors border-r border-b border-slate-100 ${isToday ? 'bg-blue-50/50' : ''}`}
                    >
                        <div className="flex justify-between items-start mb-1">
                            <span className={`text-xs font-bold ${isToday ? 'bg-blue-600 text-white px-1.5 py-0.5 rounded-full' : 'text-slate-500'}`}>{date.getDate()}</span>
                            {hasNote && <Icon name="FileText" size={12} className="text-slate-400" />}
                        </div>
                        {data && (
                            <div className="space-y-0.5">
                                <div className="flex justify-between text-[10px] text-slate-500"><span>Áèæ</span><span className={data.stocks > 0 ? 'text-blue-600' : data.stocks < 0 ? 'text-red-500' : ''}>{formatMoney(data.stocks)}</span></div>
                                <div className="flex justify-between text-[10px] text-slate-500"><span>‰ø°</span><span className={data.margin > 0 ? 'text-blue-600' : data.margin < 0 ? 'text-red-500' : ''}>{formatMoney(data.margin)}</span></div>
                                <div className="flex justify-between text-[10px] text-slate-500"><span>Â§ñ</span><span className={data.foreign > 0 ? 'text-blue-600' : data.foreign < 0 ? 'text-red-500' : ''}>{formatMoney(data.foreign)}</span></div>
                                <div className="flex justify-between text-[10px] text-slate-500"><span>C</span><span className={data.cfd > 0 ? 'text-blue-600' : data.cfd < 0 ? 'text-red-500' : ''}>{formatMoney(data.cfd)}</span></div>
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="space-y-6 mb-12">
                    {/* Top Stats Panel */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 animate-fade-in-up">
                        {/* Lifetime */}
                        <div className="lifetime-bg rounded-xl p-6 text-white shadow-lg relative overflow-hidden group">
                            <div className="relative z-10">
                                <p className="text-blue-100 text-sm font-medium mb-1">ÁîüÊ∂ØÂèéÁõä (Lifetime Profit)</p>
                                <h3 className="text-3xl font-bold tracking-tight">¬• {stats.lifetime.toLocaleString()}</h3>
                                <p className="text-xs text-blue-200 mt-2 opacity-80">ÂÖ®ÊúüÈñìÁ¥ØË®à</p>
                            </div>
                            <div className="absolute right-0 bottom-0 opacity-10 transform translate-x-4 translate-y-4 group-hover:scale-110 transition-transform">
                                <Icon name="LineChart" size={100} />
                            </div>
                        </div>
                        
                        {/* Last Year */}
                        <div className="bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
                            <p className="text-slate-500 text-sm font-medium mb-1">ÂâçÂπ¥ÂèéÊîØ (2025)</p>
                            <h3 className={`text-3xl font-bold ${stats.prevYear >= 0 ? 'text-blue-600' : 'text-red-500'}`}>
                                {stats.prevYear >= 0 ? '+' : ''}{stats.prevYear.toLocaleString()}
                            </h3>
                            <p className="text-xs text-slate-400 mt-2">Âπ¥ÈñìÁ¢∫ÂÆöÊêçÁõä</p>
                        </div>

                        {/* This Month */}
                        <div className="bg-white rounded-xl p-6 border border-slate-200 shadow-sm flex flex-col justify-between">
                            <div>
                                <p className="text-slate-500 text-sm font-medium mb-1">‰ªäÊúàÂèéÊîØ ({currentDate.getMonth() + 1}Êúà)</p>
                                <h3 className={`text-3xl font-bold ${stats.monthTotal >= 0 ? 'text-blue-600' : 'text-red-500'}`}>
                                    {stats.monthTotal >= 0 ? '+' : ''}{stats.monthTotal.toLocaleString()}
                                </h3>
                            </div>
                            <div className="mt-2 flex justify-between items-end">
                                <p className="text-xs text-slate-400">„É™„Ç¢„É´„Çø„Ç§„É†ÈõÜË®à</p>
                                <button onClick={handleExport} className="text-xs flex items-center gap-1 text-slate-500 hover:text-blue-600 border border-slate-200 rounded px-2 py-1 bg-slate-50 hover:bg-white transition-colors">
                                    <Icon name="Download" size={12} /> MDÂá∫Âäõ
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Calendar Control & View */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden animate-fade-in-up">
                        <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                            <div className="flex items-center gap-4">
                                <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <Icon name="Calendar" size={20} />
                                    {currentDate.getFullYear()}Âπ¥ {currentDate.getMonth() + 1}Êúà
                                </h2>
                                <div className="flex gap-1">
                                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-1 hover:bg-white hover:shadow rounded text-slate-500"><Icon name="ChevronLeft" size={20} /></button>
                                    <button onClick={() => setCurrentDate(new Date())} className="px-2 py-1 text-xs font-bold text-slate-600 hover:bg-white hover:shadow rounded">Today</button>
                                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-1 hover:bg-white hover:shadow rounded text-slate-500"><Icon name="ChevronRight" size={20} /></button>
                                </div>
                            </div>
                        </div>
                        
                        <div className="cal-grid">
                            {/* Header Row */}
                            <div className="cal-header">Sun</div>
                            <div className="cal-header">Mon</div>
                            <div className="cal-header">Tue</div>
                            <div className="cal-header">Wed</div>
                            <div className="cal-header">Thu</div>
                            <div className="cal-header">Fri</div>
                            <div className="cal-header">Sat (Total)</div>

                            {/* Body Rows */}
                            {calendarWeeks.map((week, wIdx) => {
                                // Calculate Weekly Total
                                const weekTotal = week.reduce((acc, date) => {
                                    if (!date) return acc;
                                    const d = historyData[getDateKey(date)];
                                    if (!d) return acc;
                                    return {
                                        stocks: acc.stocks + (d.stocks || 0),
                                        margin: acc.margin + (d.margin || 0),
                                        foreign: acc.foreign + (d.foreign || 0),
                                        cfd: acc.cfd + (d.cfd || 0),
                                    };
                                }, { stocks: 0, margin: 0, foreign: 0, cfd: 0 });
                                const weekSum = weekTotal.stocks + weekTotal.margin + weekTotal.foreign + weekTotal.cfd;

                                return (
                                    <React.Fragment key={wIdx}>
                                        {/* Sunday Label Column */}
                                        <div className="cal-label-col border-r border-b border-slate-100">
                                            <span>ÁèæÁâ©</span>
                                            <span>‰ø°Áî®</span>
                                            <span>Êµ∑Â§ñ</span>
                                            <span>CFD</span>
                                        </div>
                                        
                                        {/* Days Mon-Fri */}
                                        {week.slice(1, 6).map((date, dIdx) => (
                                            <DayCell key={dIdx} date={date} />
                                        ))}

                                        {/* Saturday Total Column */}
                                        <div className="cal-total-col border-b border-slate-100 bg-slate-50">
                                            <div className="flex flex-col gap-1 w-full text-xs">
                                                 <div className={`text-right ${weekTotal.stocks > 0 ? 'text-blue-600' : weekTotal.stocks < 0 ? 'text-red-500' : 'text-slate-400'}`}>{formatMoney(weekTotal.stocks)}</div>
                                                 <div className={`text-right ${weekTotal.margin > 0 ? 'text-blue-600' : weekTotal.margin < 0 ? 'text-red-500' : 'text-slate-400'}`}>{formatMoney(weekTotal.margin)}</div>
                                                 <div className={`text-right ${weekTotal.foreign > 0 ? 'text-blue-600' : weekTotal.foreign < 0 ? 'text-red-500' : 'text-slate-400'}`}>{formatMoney(weekTotal.foreign)}</div>
                                                 <div className={`text-right ${weekTotal.cfd > 0 ? 'text-blue-600' : weekTotal.cfd < 0 ? 'text-red-500' : 'text-slate-400'}`}>{formatMoney(weekTotal.cfd)}</div>
                                                 <div className={`mt-1 pt-1 border-t border-slate-200 font-bold text-right ${weekSum >= 0 ? 'text-slate-800' : 'text-red-600'}`}>{formatMoney(weekSum)}</div>
                                            </div>
                                        </div>
                                    </React.Fragment>
                                );
                            })}
                        </div>
                    </div>

                    {/* Editor Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in-up">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden">
                                {/* Header */}
                                <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                                    <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                                        <Icon name="FileText" size={20} />
                                        {selectedDate.getFullYear()}Âπ¥{selectedDate.getMonth()+1}Êúà{selectedDate.getDate()}Êó• (Á∑®ÈõÜ)
                                    </h3>
                                    <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600"><Icon name="X" /></button>
                                </div>
                                
                                <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
                                    {/* Left: Numbers */}
                                    <div className="w-full md:w-1/3 p-6 border-r border-slate-200 bg-slate-50/50 overflow-y-auto">
                                        <h4 className="text-sm font-bold text-slate-500 uppercase mb-4">ÂèéÊîØÂÖ•Âäõ (ÂÜÜ)</h4>
                                        <div className="space-y-4">
                                            {[
                                                { k: 'stocks', l: 'ÁèæÁâ©ÂèéÊîØ' },
                                                { k: 'margin', l: '‰ø°Áî®ÂèéÊîØ' },
                                                { k: 'foreign', l: 'Êµ∑Â§ñÊ†™ÂèéÊîØ' },
                                                { k: 'cfd', l: 'CFD/ÂÖàÁâ©' }
                                            ].map(f => (
                                                <div key={f.k}>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">{f.l}</label>
                                                    <input 
                                                        type="number" 
                                                        value={editData[f.k] || ''}
                                                        onChange={(e) => setEditData({...editData, [f.k]: parseInt(e.target.value) || 0})}
                                                        className="w-full border border-slate-300 rounded p-2 font-mono text-right focus:ring-2 focus:ring-blue-500 outline-none"
                                                    />
                                                </div>
                                            ))}
                                            <div className="pt-4 border-t border-slate-200 mt-4">
                                                <div className="flex justify-between items-center">
                                                    <span className="font-bold text-slate-700">ÂêàË®à</span>
                                                    <span className={`text-xl font-bold font-mono ${(editData.stocks+editData.margin+editData.foreign+editData.cfd) >= 0 ? 'text-blue-600' : 'text-red-500'}`}>
                                                        {formatMoney(editData.stocks + editData.margin + editData.foreign + editData.cfd)}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Right: Diary */}
                                    <div className="flex-1 flex flex-col h-full bg-white">
                                        <div className="flex border-b border-slate-200">
                                            <button 
                                                onClick={() => setModalTab('edit')}
                                                className={`px-6 py-3 text-sm font-bold ${modalTab === 'edit' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:bg-slate-50'}`}
                                            >
                                                Á∑®ÈõÜ (Markdown)
                                            </button>
                                            <button 
                                                onClick={() => setModalTab('preview')}
                                                className={`px-6 py-3 text-sm font-bold ${modalTab === 'preview' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:bg-slate-50'}`}
                                            >
                                                „Éó„É¨„Éì„É•„Éº
                                            </button>
                                        </div>
                                        <div className="flex-1 overflow-hidden relative">
                                            {modalTab === 'edit' ? (
                                                <textarea 
                                                    className="w-full h-full p-4 resize-none outline-none font-mono text-sm leading-relaxed"
                                                    placeholder="# ‰ªäÊó•„ÅÆÊåØ„ÇäËøî„Çä&#13;&#10;- „Éà„É¨„Éº„ÉâÊ†πÊã†: ...&#13;&#10;- ÂèçÁúÅÁÇπ: ..."
                                                    value={editData.note}
                                                    onChange={(e) => setEditData({...editData, note: e.target.value})}
                                                />
                                            ) : (
                                                <div 
                                                    className="w-full h-full p-4 overflow-y-auto prose prose-sm prose-slate max-w-none"
                                                    dangerouslySetInnerHTML={{ __html: marked.parse(editData.note || '') }}
                                                />
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* Footer */}
                                <div className="p-4 border-t border-slate-200 bg-slate-50 flex justify-end gap-3">
                                    <button onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg text-sm font-bold transition-colors">„Ç≠„É£„É≥„Çª„É´</button>
                                    <button onClick={handleSave} className="px-6 py-2 bg-slate-800 text-white hover:bg-slate-700 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors">
                                        <Icon name="Check" size={16} /> ‰øùÂ≠ò
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        //  Êñ∞Ë¶è„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà: ÂèñÂºïÂèÇÂä†ËÄÖÂà•ÂèñÂºïÈ´ò
        // ==========================================
        const ParticipantVolume = () => {
            const [data, setData] = useState(null);
            const [session, setSession] = useState('night'); // 'night' or 'day'
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const res = await fetch('./data/daily_participant.json');
                        if (res.ok) {
                            const json = await res.json();
                            setData(json);
                        } else {
                            console.warn("Daily participant data not found.");
                        }
                    } catch (e) {
                        console.error(e);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, []);

            if (loading) return <div className="p-8 text-center text-slate-500">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>;
            if (!data) return <div className="p-8 text-center text-red-500 bg-red-50 rounded-lg">ÊúÄÊñ∞„ÅÆÊâãÂè£„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ<br/>Âπ≥Êó•20ÊôÇ‰ª•Èôç„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åô„ÄÇ</div>;

            const targetData = session === 'night' ? data.night_session : data.day_session;
            const sessionLabel = session === 'night' ? '„Éä„Ç§„Éà„Éª„Çª„ÉÉ„Ç∑„Éß„É≥ (Á´ã‰ºö)' : 'Êó•‰∏≠ÂèñÂºï (Á´ã‰ºö)';

            const categoryColors = {
                'US': 'bg-blue-100 text-blue-800 border-blue-200',
                'EU': 'bg-green-100 text-green-800 border-green-200',
                'JP': 'bg-orange-100 text-orange-800 border-orange-200',
                'NET': 'bg-purple-100 text-purple-800 border-purple-200',
                'OTHERS': 'bg-slate-100 text-slate-800 border-slate-200'
            };

            const grouped = targetData.reduce((acc, item) => {
                const cat = item.category || 'OTHERS';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(item);
                return acc;
            }, {});

            const categories = ['US', 'EU', 'JP', 'NET', 'OTHERS'];

            return (
                <div className="space-y-6">
                    <div className="gradient-bg text-white shadow-lg rounded-xl p-6 md:p-8 animate-fade-in-up">
                        <h1 className="text-3xl font-bold mb-2">ÂèñÂºïÂèÇÂä†ËÄÖÂà•ÂèñÂºïÈ´ò (ÊâãÂè£‰∏ä‰Ωç)</h1>
                        <p className="text-blue-100 text-sm">„Éá„Éº„ÇøÊó•‰ªò: {data.date} (ÊúÄÁµÇÊõ¥Êñ∞: {data.updated_at})</p>
                    </div>

                    <div className="flex space-x-2 bg-white p-2 rounded-lg shadow-sm border border-slate-200 w-fit">
                        <button 
                            onClick={() => setSession('night')}
                            className={`px-4 py-2 rounded-md text-sm font-bold transition-all ${session === 'night' ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:bg-slate-100'}`}
                        >
                            üåô „Éä„Ç§„Éà„Éª„Çª„ÉÉ„Ç∑„Éß„É≥
                        </button>
                        <button 
                            onClick={() => setSession('day')}
                            className={`px-4 py-2 rounded-md text-sm font-bold transition-all ${session === 'day' ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:bg-slate-100'}`}
                        >
                            ‚òÄÔ∏è Êó•‰∏≠ÂèñÂºï
                        </button>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in-up">
                        <h2 className="text-xl font-bold text-slate-800 mb-4">{sessionLabel}</h2>
                        {targetData.length === 0 ? (
                            <p className="text-slate-500">„Åì„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆ„Éá„Éº„Çø„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                        ) : (
                            <div className="space-y-8">
                                {categories.map(cat => {
                                    if (!grouped[cat]) return null;
                                    return (
                                        <div key={cat} className="border border-slate-200 rounded-lg overflow-hidden">
                                            <div className={`px-4 py-2 font-bold text-sm border-b ${categoryColors[cat]}`}>
                                                {cat === 'US' && 'üá∫üá∏ Á±≥Á≥ªË®ºÂà∏'}
                                                {cat === 'EU' && 'üá™üá∫ Ê¨ßÂ∑ûÁ≥ªË®ºÂà∏'}
                                                {cat === 'JP' && 'üáØüáµ Êó•Á≥ªË®ºÂà∏'}
                                                {cat === 'NET' && 'üåê „Éç„ÉÉ„ÉàË®ºÂà∏'}
                                                {cat === 'OTHERS' && '„Åù„ÅÆ‰ªñ'}
                                            </div>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm text-left">
                                                    <thead className="bg-slate-5 text-slate-500 border-b border-slate-200">
                                                        <tr>
                                                            <th className="px-4 py-2 w-48">Ë®ºÂà∏‰ºöÁ§æ</th>
                                                            {Object.keys(grouped[cat][0].data).map(key => (
                                                                <th key={key} className="px-4 py-2 text-right whitespace-nowrap">{key}</th>
                                                            ))}
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-100">
                                                        {grouped[cat].map((item, idx) => (
                                                            <tr key={idx} className="hover:bg-slate-50">
                                                                <td className="px-4 py-2 font-medium text-slate-700">{item.name}</td>
                                                                {Object.entries(item.data).map(([k, val], i) => (
                                                                    <td key={i} className="px-4 py-2 text-right font-mono">
                                                                        {val.toLocaleString()}
                                                                    </td>
                                                                ))}
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                     <div className="mt-4 text-right text-xs text-slate-400">
                        ‚ÄªJPXÂÖ¨Ë°®„ÅÆExcel„Éï„Ç°„Ç§„É´„Çà„ÇäËá™ÂãïÂèñÂæó„ÉªÈõÜË®à„ÄÇÂçò‰Ωç: Êûö („Åæ„Åü„ÅØÈáëÈ°ç)„ÄÇ
                    </div>
                </div>
            );
        };

        // ==========================================
        //  Êó¢Â≠ò„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà: JPX Chart (Â§âÊõ¥„Å™„Åó)
        // ==========================================
        const ForeignInvestors = () => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            
            const [allData, setAllData] = useState([]);
            const [currentTimeRange, setCurrentTimeRange] = useState('all');
            const [stats, setStats] = useState(null);
            const [dataCount, setDataCount] = useState(0);
            const [lastUpdate, setLastUpdate] = useState('„Éá„Éº„ÇøÂèñÂæó‰∏≠...');

            useEffect(() => {
                const canvas = chartRef.current;
                if (!canvas) return;

                const handleWheel = (e) => {
                    if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
                        e.preventDefault();
                    }
                };

                canvas.addEventListener('wheel', handleWheel, { passive: false });
                return () => canvas.removeEventListener('wheel', handleWheel);
            }, [allData]);

            // --- Helper Functions ---
            const formatNumber = (num) => Math.round(num).toLocaleString('ja-JP');
            const formatLargeNumber = (value) => {
                if (typeof value === 'number') {
                    const sign = value >= 0 ? '+' : '';
                    return sign + formatNumber(value) + 'ÂÑÑÂÜÜ';
                }
                return value.toString();
            };

            const calculateWeekLabels = (data) => {
                const weekCounter = {};
                return data.map(row => {
                    const date = new Date(row.date);
                    const year = date.getFullYear();
                    const month = date.getMonth() + 1;
                    const yearMonthKey = `${year}-${month}`;
                    if (!weekCounter[yearMonthKey]) weekCounter[yearMonthKey] = 1;
                    else weekCounter[yearMonthKey]++;
                    const weekNum = weekCounter[yearMonthKey];
                    return {
                        ...row,
                        displayDate: `${year}Âπ¥${month}Êúà${weekNum}ÈÄ±`,
                        tooltipDate: `${year}Âπ¥${month}ÊúàÁ¨¨${weekNum}ÈÄ±`
                    };
                });
            };

            const calculateStats = (data) => {
                const positiveData = data.filter(item => item.balance > 0).map(item => item.balance);
                const negativeData = data.filter(item => item.balance < 0).map(item => item.balance);
                const calcMedian = (arr) => {
                    if (arr.length === 0) return 0;
                    const sorted = [...arr].sort((a, b) => a - b);
                    const mid = Math.floor(sorted.length / 2);
                    return sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid];
                };
                const calcAverage = (arr) => arr.length === 0 ? 0 : arr.reduce((sum, val) => sum + val, 0) / arr.length;
                return {
                    positiveAvg: calcAverage(positiveData),
                    positiveMedian: calcMedian(positiveData),
                    negativeAvg: calcAverage(negativeData),
                    negativeMedian: calcMedian(negativeData),
                    latest: data[data.length - 1]
                };
            };

            const getFormattedReleaseDate = (lastDateStr) => {
                try {
                    const date = new Date(lastDateStr);
                    if (isNaN(date.getTime())) return lastDateStr;
                    const releaseDate = new Date(date);
                    releaseDate.setDate(date.getDate() + 6);
                    const y = releaseDate.getFullYear();
                    const m = String(releaseDate.getMonth() + 1).padStart(2, '0');
                    const d = String(releaseDate.getDate()).padStart(2, '0');
                    return `${y}-${m}-${d}-18:00`;
                } catch (e) {
                    return lastDateStr;
                }
            };

            // --- Chart Actions ---
            const zoomChart = (direction) => {
                if (!chartInstance.current) return;
                chartInstance.current.zoom(direction === 'in' ? 1.2 : 0.8);
                updateStatsFromChart();
            };
            const panChart = (direction) => {
                if (!chartInstance.current) return;
                const chart = chartInstance.current;
                const range = chart.scales.x.max - chart.scales.x.min;
                chart.pan({ x: direction === 'left' ? range * 0.2 : -range * 0.2 });
                updateStatsFromChart();
            };
            const resetZoom = () => {
                if (!chartInstance.current) return;
                chartInstance.current.resetZoom();
                updateStatsFromChart();
            };

            const updateStatsFromChart = () => {
                if (!chartInstance.current) return;
                const chart = chartInstance.current;
                const xScale = chart.scales.x;
                const filtered = getFilteredData(allData, currentTimeRange);
                const startIndex = Math.max(0, Math.floor(xScale.min));
                const endIndex = Math.min(filtered.length - 1, Math.ceil(xScale.max));
                const visibleData = filtered.slice(startIndex, endIndex + 1);
                if (visibleData.length > 0) setStats(calculateStats(visibleData));
            };

            const getFilteredData = (data, range) => {
                if (range === 'all') return data;
                const now = new Date();
                const cutoffDate = new Date();
                if (range === '3m') cutoffDate.setMonth(now.getMonth() - 3);
                else if (range === '6m') cutoffDate.setMonth(now.getMonth() - 6);
                else if (range === '1y') cutoffDate.setFullYear(now.getFullYear() - 1);
                return data.filter(item => new Date(item.date) >= cutoffDate);
            };

            const drawChart = (data) => {
                if (!chartRef.current) return;
                const ctx = chartRef.current.getContext('2d');
                if (chartInstance.current) chartInstance.current.destroy();
                const config = {
                    type: 'bar',
                    data: {
                        datasets: [{
                            label: 'Â∑ÆÂºïÔºàÂÑÑÂÜÜÔºâ',
                            data: data.map((d, index) => ({ x: index, y: d.balance })),
                            backgroundColor: (ctx) => (!ctx.parsed || ctx.parsed.y === undefined) ? 'rgba(74, 134, 232, 0.7)' : ctx.parsed.y >= 0 ? 'rgba(74, 134, 232, 0.7)' : 'rgba(230, 124, 115, 0.7)',
                            borderColor: (ctx) => (!ctx.parsed || ctx.parsed.y === undefined) ? '#4A86E8' : ctx.parsed.y >= 0 ? '#4A86E8' : '#E67C73',
                            borderWidth: 1,
                            barPercentage: 0.9,
                            categoryPercentage: 0.9
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'white',
                                titleColor: '#334155',
                                bodyColor: '#334155',
                                borderColor: '#e2e8f0',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    title: (context) => data[Math.round(context[0].parsed.x)]?.tooltipDate || '',
                                    label: (context) => {
                                        const index = Math.round(context.parsed.x);
                                        if (index >= 0 && index < data.length) {
                                            const val = data[index].balance;
                                            const raw = data[index].rawBalance;
                                            const sign = val >= 0 ? '+' : '';
                                            return `${sign}${formatNumber(val)}ÂÑÑÂÜÜ (${sign}${(raw * 1000).toLocaleString('ja-JP')}ÂÜÜ)`;
                                        }
                                        return '';
                                    },
                                    afterLabel: (context) => context.parsed.y >= 0 ? 'Ë≤∑„ÅÑË∂ä„Åó' : 'Â£≤„ÇäË∂ä„Åó'
                                }
                            },
                            zoom: {
                                pan: { enabled: true, mode: 'x', threshold: 0 },
                                zoom: { wheel: { enabled: true, speed: 0.1 }, pinch: { enabled: true }, mode: 'x', onZoomComplete: updateStatsFromChart }
                            }
                        },
                        scales: {
                            y: { ticks: { callback: (value, index, ticks) => index === ticks.length - 1 ? formatNumber(value) + 'ÂÑÑÂÜÜ' : formatNumber(value) }, grid: { color: '#e2e8f0' } },
                            x: { type: 'linear', min: 0, max: data.length - 1, ticks: { callback: (value) => data[Math.round(value)]?.displayDate || '', maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 20 }, grid: { color: '#e2e8f0' } }
                        }
                    }
                };
                chartInstance.current = new Chart(ctx, config);
            };

            useEffect(() => {
                const loadData = async () => {
                    try {
                        const res = await fetch('history.csv');
                        const text = res.ok ? await res.text() : null;
                        if (!text) throw new Error("CSV load failed");
                        Papa.parse(text, {
                            header: true,
                            dynamicTyping: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                const raw = results.data.filter(r => r.date && r.balance != null).map(r => ({ date: r.date, balance: r.balance / 100000, rawBalance: r.balance })).sort((a, b) => new Date(a.date) - new Date(b.date));
                                const processed = calculateWeekLabels(raw);
                                setAllData(processed);
                                if (processed.length > 0) setLastUpdate(`ÊúÄÁµÇÊõ¥Êñ∞: ${getFormattedReleaseDate(processed[processed.length - 1].date)}`);
                            }
                        });
                    } catch (e) { console.error(e); setLastUpdate("„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"); }
                };
                loadData();
                const interval = setInterval(loadData, 5 * 60 * 1000);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                if (allData.length === 0) return;
                const filtered = getFilteredData(allData, currentTimeRange);
                setDataCount(filtered.length);
                drawChart(filtered);
                setStats(calculateStats(filtered));
            }, [allData, currentTimeRange]);

            return (
                <div className="space-y-6">
                    <div className="gradient-bg text-white shadow-lg rounded-xl -mx-4 md:mx-0 p-6 md:p-8 mb-8 animate-fade-in-up">
                        <h1 className="text-3xl md:text-4xl font-bold mb-2">JPX Êµ∑Â§ñÊäïË≥áÂÆ∂ÂãïÂêë</h1>
                        <p className="text-blue-100 text-sm mt-2">{lastUpdate}</p>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6 animate-fade-in-up">
                        <h2 className="text-xl font-bold text-slate-900 mb-4">Â∑ÆÂºïÊé®Áßª <span className="text-sm font-normal text-slate-500 ml-2">({dataCount}‰ª∂„ÅÆ„Éá„Éº„Çø)</span></h2>
                        <div style={{ position: 'relative', height: '500px' }}>
                            <canvas ref={chartRef}></canvas>
                            <div style={{ position: 'absolute', bottom: '90px', left: '80px', display: 'flex', gap: '8px', zIndex: 10 }}>
                                <button onClick={() => zoomChart('in')} className="px-3 py-2 bg-white/90 backdrop-blur text-slate-700 rounded-lg shadow-md hover:bg-white transition-colors text-sm font-medium border border-slate-300">Ôºã</button>
                                <button onClick={() => zoomChart('out')} className="px-3 py-2 bg-white/90 backdrop-blur text-slate-700 rounded-lg shadow-md hover:bg-white transition-colors text-sm font-medium border border-slate-300">„Éº</button>
                            </div>
                            <div style={{ position: 'absolute', bottom: '90px', right: '20px', display: 'flex', gap: '8px', zIndex: 10 }}>
                                <button onClick={() => panChart('left')} className="px-3 py-2 bg-white/90 backdrop-blur text-slate-700 rounded-lg shadow-md hover:bg-white transition-colors text-sm font-medium border border-slate-300">‚Üê Â∑¶„Å∏</button>
                                <button onClick={() => panChart('right')} className="px-3 py-2 bg-white/90 backdrop-blur text-slate-700 rounded-lg shadow-md hover:bg-white transition-colors text-sm font-medium border border-slate-300">Âè≥„Å∏ ‚Üí</button>
                            </div>
                        </div>
                        <div className="mt-4 pt-4 border-t border-slate-200"><p className="text-xs text-slate-500">üí° PC: „Éâ„É©„ÉÉ„Ç∞„ÅßÂ∑¶Âè≥ÁßªÂãï„ÄÅ„Éõ„Ç§„Éº„É´(Á∏¶)„Åß„Ç∫„Éº„É† | „Çπ„Éû„Éõ: „Éî„É≥„ÉÅ„Ç§„É≥„Éª„Ç¢„Ç¶„Éà„Åß„Ç∫„Éº„É†„ÄÅ„Çπ„ÉØ„Ç§„Éó„ÅßÁßªÂãï</p></div>
                    </div>
                    {stats && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6 animate-fade-in-up">
                            {[
                                { label: 'ÊúÄÊñ∞ÈÄ±ÔºàÂÖàÈÄ±Ôºâ„ÅÆÂ£≤Ë≤∑Áä∂Ê≥Å', value: stats.latest.balance, color: stats.latest.balance >= 0 ? 'text-blue-600' : 'text-red-500', sub: stats.latest.balance >= 0 ? 'Ë≤∑„ÅÑË∂ä„Åó' : 'Â£≤„ÇäË∂ä„Åó' },
                                { label: 'Ë≤∑„ÅÑË∂ä„Åó Âπ≥Âùá', value: stats.positiveAvg, color: 'text-blue-600', sub: 'Ë°®Á§∫ÁØÑÂõ≤ÂÜÖ' },
                                { label: 'Ë≤∑„ÅÑË∂ä„Åó ‰∏≠Â§ÆÂÄ§', value: stats.positiveMedian, color: 'text-blue-600', sub: 'Ë°®Á§∫ÁØÑÂõ≤ÂÜÖ' },
                                { label: 'Â£≤„ÇäË∂ä„Åó Âπ≥Âùá', value: stats.negativeAvg, color: 'text-red-500', sub: 'Ë°®Á§∫ÁØÑÂõ≤ÂÜÖ' },
                                { label: 'Â£≤„ÇäË∂ä„Åó ‰∏≠Â§ÆÂÄ§', value: stats.negativeMedian, color: 'text-red-500', sub: 'Ë°®Á§∫ÁØÑÂõ≤ÂÜÖ' },
                            ].map((s, i) => (
                                <div key={i} className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                    <p className="text-slate-600 text-sm font-medium mb-2">{s.label}</p>
                                    <p className={`text-3xl font-bold ${s.color}`}>{formatLargeNumber(s.value)}</p>
                                    <p className="text-slate-400 text-xs mt-1">{s.sub}</p>
                                </div>
                            ))}
                        </div>
                    )}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 animate-fade-in-up">
                        <div className="flex flex-wrap gap-4 items-center">
                            <div className="flex items-center gap-2"><span className="text-slate-600 text-sm font-medium">ÊúüÈñì:</span><div className="flex gap-1">{[{ v: 'all', l: 'ÂÖ®ÊúüÈñì' }, { v: '1y', l: '1Âπ¥' }, { v: '6m', l: '6„É∂Êúà' }, { v: '3m', l: '3„É∂Êúà' }].map(opt => (<button key={opt.v} onClick={() => setCurrentTimeRange(opt.v)} className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${currentTimeRange === opt.v ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>{opt.l}</button>))}</div></div>
                            <button onClick={resetZoom} className="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition-colors text-sm font-medium">üîÑ „Ç∫„Éº„É†„É™„Çª„ÉÉ„Éà</button>
                        </div>
                    </div>
                    <div className="mt-8 text-center text-slate-500 text-sm"><p>„Éá„Éº„Çø„ÇΩ„Éº„Çπ: <a href="https://www.jpx.co.jp/markets/statistics-equities/investor-type/00-00-archives-00.html" target="_blank" className="text-blue-600 hover:underline">Êó•Êú¨ÂèñÂºïÊâÄ„Ç∞„É´„Éº„Éó (JPX)</a></p></div>
                </div>
            );
        };

        // ==========================================
        //  Êó¢Â≠ò„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà: Option OI (Â§âÊõ¥„Å™„Åó)
        // ==========================================
        const processOptionData = (rawRows, step = 50) => {
            if (!rawRows || rawRows.length < 2) return { data: [], error: '„Éá„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ' };
            const strikeRegex = /(strike|Ë°å‰Ωø‰æ°Ê†º|koushi)/i;
            const oiRegex = /(open\s*int|oi|Âª∫Áéâ|tategyoku)/i;
            const parseNum = (val) => {
                if (typeof val === 'number') return val;
                if (!val) return 0;
                let str = String(val).toUpperCase();
                let multiplier = 1;
                if (str.endsWith('K')) multiplier = 1000;
                else if (str.endsWith('M')) multiplier = 1000000;
                str = str.replace(/[^0-9.-]/g, '').trim(); 
                const num = parseFloat(str);
                return isNaN(num) ? 0 : num * multiplier;
            };

            let reshapeHeaderIndex = -1;
            let reshapeWidth = 0;
            const getHeaderInfo = (row) => {
                const sRow = row.map(c => String(c).trim());
                let sCol = -1, oiCols = [];
                sRow.forEach((cell, i) => { if (strikeRegex.test(cell)) sCol = i; else if (oiRegex.test(cell)) oiCols.push(i); });
                return { sCol, oiCols, colCount: row.length };
            };

            for (let r = 0; r < Math.min(rawRows.length, 50); r++) {
                const info = getHeaderInfo(rawRows[r]);
                if (info.sCol !== -1 && info.oiCols.length >= 2 && info.colCount > 1) {
                    let singleColCount = 0;
                    for(let k=1; k<=10 && (r+k)<rawRows.length; k++) { if (rawRows[r+k].length === 1 || rawRows[r+k].length < info.colCount / 2) singleColCount++; }
                    if (singleColCount >= 5) { reshapeHeaderIndex = r; reshapeWidth = info.colCount; break; }
                }
            }

            if (reshapeWidth > 0 && reshapeHeaderIndex !== -1) {
                const headerRow = rawRows[reshapeHeaderIndex];
                const flatData = [];
                for (let i = reshapeHeaderIndex + 1; i < rawRows.length; i++) {
                    const row = rawRows[i];
                    for (const cell of row) { if (cell !== null && cell !== undefined && String(cell).trim() !== '') flatData.push(cell); }
                }
                const newRows = [headerRow];
                let currentChunk = [];
                for (const cell of flatData) {
                    currentChunk.push(cell);
                    if (currentChunk.length === reshapeWidth) { newRows.push(currentChunk); currentChunk = []; }
                }
                rawRows = newRows;
            }

            let bestCandidate = { headerIndex: -1, strikeCol: -1, callCol: -1, putCol: -1, score: 0 };
            for (let r = 0; r < Math.min(rawRows.length, 50); r++) {
                const row = rawRows[r].map(c => String(c).trim());
                let sCol = -1, oiCols = [];
                row.forEach((cell, i) => { if (strikeRegex.test(cell)) sCol = i; else if (oiRegex.test(cell)) oiCols.push(i); });
                if (sCol !== -1 && oiCols.length >= 2) {
                    let cCol = -1, pCol = -1;
                    const oi1 = row[oiCols[0]].toLowerCase();
                    const oi2 = row[oiCols[1]].toLowerCase();
                    if (oi1.includes('call') || oi1.includes('„Ç≥„Éº„É´')) { cCol = oiCols[0]; }
                    if (oi1.includes('put') || oi1.includes('„Éó„ÉÉ„Éà')) { pCol = oiCols[0]; }
                    if (oi2.includes('call') || oi2.includes('„Ç≥„Éº„É´')) { cCol = oiCols[1]; }
                    if (oi2.includes('put') || oi2.includes('„Éó„ÉÉ„Éà')) { pCol = oiCols[1]; }
                    if (cCol === -1 || pCol === -1) { cCol = oiCols[0]; pCol = oiCols[1]; }
                    bestCandidate = { headerIndex: r, strikeCol: sCol, callCol: cCol, putCol: pCol, score: 10 };
                    break;
                }
            }

            if (bestCandidate.headerIndex === -1) return { data: [], error: '„Éò„ÉÉ„ÉÄ„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ' };

            const { headerIndex, strikeCol, callCol, putCol } = bestCandidate;
            const dataMap = new Map();
            const safeStep = step > 0 ? step : 1;

            for (let i = headerIndex + 1; i < rawRows.length; i++) {
                const row = rawRows[i];
                if (!row || row.length <= Math.max(strikeCol, callCol, putCol)) continue;
                const strike = parseNum(row[strikeCol]);
                const oi1 = parseNum(row[callCol]);
                const oi2 = parseNum(row[putCol]);
                if (strike > 0) {
                    const roundedStrike = Math.round(strike / safeStep) * safeStep;
                    if (!dataMap.has(roundedStrike)) dataMap.set(roundedStrike, { call: 0, put: 0 });
                    const d = dataMap.get(roundedStrike);
                    d.call += oi1;
                    d.put += oi2;
                }
            }

            const sortedData = Array.from(dataMap.entries())
                .sort((a, b) => b[0] - a[0])
                .map(([strike, val]) => ({ strike, diff: val.call - val.put, call: val.call, put: val.put }));

            return { data: sortedData, error: sortedData.length === 0 ? "ÊúâÂäπ„Å™„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü" : null };
        };

        const DataInput = ({ onDataParsed }) => {
            const [text, setText] = useState('');
            const [dragActive, setDragActive] = useState(false);
            const handleParse = (input) => {
                Papa.parse(input, {
                    complete: (results) => onDataParsed(results.data),
                    skipEmptyLines: true,
                    header: false 
                });
            };
            const handleDrop = (e) => {
                e.preventDefault();
                setDragActive(false);
                if (e.dataTransfer.files?.[0]) handleParse(e.dataTransfer.files[0]);
            };
            return (
                <div className="max-w-3xl mx-auto bg-white rounded-xl shadow border border-slate-200 p-6 space-y-6">
                    <div 
                        className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${dragActive ? 'border-blue-500 bg-blue-50' : 'border-slate-300 hover:bg-slate-50'}`}
                        onDragOver={(e) => { e.preventDefault(); setDragActive(true); }}
                        onDragLeave={() => setDragActive(false)}
                        onDrop={handleDrop}
                    >
                        <Icon name="Upload" className="mx-auto text-slate-400 mb-2" size={32} />
                        <p className="text-slate-600 font-medium">CSV„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó</p>
                        <p className="text-slate-400 text-sm">„Åæ„Åü„ÅØ</p>
                        <input type="file" className="mt-2 text-sm text-slate-500" onChange={(e) => e.target.files?.[0] && handleParse(e.target.files[0])} />
                    </div>
                    <div className="flex gap-2">
                        <textarea 
                            className="flex-1 border border-slate-300 rounded-lg p-3 text-sm font-mono focus:ring-2 focus:ring-blue-500 outline-none"
                            rows={4}
                            placeholder="„Åì„Åì„Å´„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë..."
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                        />
                        <button onClick={() => handleParse(text)} disabled={!text} className="bg-slate-800 text-white px-4 rounded-lg hover:bg-slate-700 disabled:opacity-50 font-medium">Ëß£Êûê</button>
                    </div>
                </div>
            );
        };

        const OIChart = ({ id, initialData, initialStep, rawRows, onStepChange }) => {
            const [data, setData] = useState(initialData);
            const [step, setStep] = useState(initialStep);
            
            // Recharts Controls
            const [zoomY, setZoomY] = useState(1);
            const [zoomX, setZoomX] = useState(1);
            const mainRef = useRef(null);
            const leftRef = useRef(null);
            const bottomRef = useRef(null);

            // StepÂ§âÊõ¥ÊôÇ„Å´ÂÜçË®àÁÆó
            useEffect(() => {
                if(rawRows && step !== initialStep) {
                    const res = processOptionData(rawRows, step);
                    if(!res.error) {
                        setData(res.data);
                        onStepChange(id, step, res.data); // Ë¶™„ÅÆstate„ÇÇÊõ¥Êñ∞
                    }
                }
            }, [step]);

            const handleScroll = () => {
                if (mainRef.current && leftRef.current && bottomRef.current) {
                    leftRef.current.scrollTop = mainRef.current.scrollTop;
                    bottomRef.current.scrollLeft = mainRef.current.scrollLeft;
                }
            };
            const barHeight = 30;
            const totalHeight = Math.max(450, data.length * barHeight * zoomY);
            const chartWidth = `${zoomX * 100}%`;
            const maxVal = Math.max(...data.map(d => Math.abs(d.diff)), 100);
            
            const handleWheel = (e, axis) => {
                if (e.ctrlKey || axis === 'main') return; 
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                if (axis === 'y') setZoomY(z => Math.max(0.1, Math.min(5, z + delta)));
                if (axis === 'x') setZoomX(z => Math.max(0.5, Math.min(3, z + delta)));
            };

            const CustomTooltip = ({ active, payload, label }) => {
                if (!active || !payload?.length) return null;
                const d = payload[0].payload;
                return (
                    <div className="bg-white p-3 border border-slate-200 shadow-lg rounded text-sm z-50">
                        <p className="font-bold">Strike: {label}</p>
                        <p className={d.diff >= 0 ? 'text-blue-600' : 'text-red-500'}>Diff: {d.diff.toLocaleString()}</p>
                        <div className="text-xs text-slate-500 mt-1 pt-1 border-t">C: {d.call.toLocaleString()} / P: {d.put.toLocaleString()}</div>
                    </div>
                );
            };

            return (
                <div className="bg-white rounded-xl shadow border border-slate-200 h-[80vh] flex flex-col overflow-hidden mb-6 animate-fade-in-up">
                    <div className="p-2 border-b border-slate-100 flex items-center gap-4 bg-slate-50 shrink-0 flex-wrap">
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-slate-500">HEIGHT</span>
                            <button onClick={()=>setZoomY(z=>Math.max(0.1, z-0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomOut" size={16}/></button>
                            <input type="range" min="0.1" max="5" step="0.1" value={zoomY} onChange={(e)=>setZoomY(parseFloat(e.target.value))} className="w-20" />
                            <button onClick={()=>setZoomY(z=>Math.min(5, z+0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomIn" size={16}/></button>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-slate-500">WIDTH</span>
                            <button onClick={()=>setZoomX(z=>Math.max(0.5, z-0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomOut" size={16}/></button>
                            <button onClick={()=>setZoomX(z=>Math.min(3, z+0.2))} className="p-1 hover:bg-slate-200 rounded"><Icon name="ZoomIn" size={16}/></button>
                        </div>
                        {/* Âàª„ÅøÂπÖÂ§âÊõ¥ÂÖ•Âäõ */}
                        <div className="flex items-center gap-2 border-l pl-4 border-slate-200">
                            <span className="text-xs font-bold text-slate-500">STEP</span>
                            <input 
                                type="number" 
                                className="border border-slate-300 rounded px-1 py-0.5 text-xs w-16 text-center focus:outline-none focus:border-blue-500"
                                value={step}
                                onChange={(e) => setStep(parseFloat(e.target.value) || 0)}
                                min="0.1"
                            />
                        </div>
                        <button onClick={()=>{setZoomY(1);setZoomX(1);}} className="ml-auto text-xs flex items-center gap-1 hover:text-blue-600 border px-2 py-1 rounded bg-white"><Icon name="RotateCcw" size={14}/> Reset</button>
                    </div>
                    <div className="flex-1 flex overflow-hidden relative">
                        <div className="w-24 border-r border-slate-200 bg-slate-50 shrink-0 overflow-hidden" ref={leftRef} onWheel={(e)=>handleWheel(e, 'y')}>
                            <div style={{height: totalHeight, width: '100%'}}>
                                <ResponsiveContainer>
                                    <BarChart layout="vertical" data={data} margin={{top:10, bottom:0}}>
                                        <YAxis type="category" dataKey="strike" width={90} tick={{fontSize:12, fontWeight:600}} interval={0} />
                                        <Bar dataKey="diff" fill="transparent" />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                        <div className="flex-1 overflow-auto bg-slate-50/30" ref={mainRef} onScroll={handleScroll}>
                            <div style={{width: chartWidth, height: totalHeight, minWidth: '100%'}}>
                                <ResponsiveContainer>
                                    <BarChart layout="vertical" data={data} margin={{top:10, right:30, left:0, bottom:0}}>
                                        <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={true} />
                                        <XAxis type="number" domain={[-maxVal, maxVal]} hide />
                                        <YAxis type="category" width={0} tick={false} />
                                        <Tooltip content={<CustomTooltip />} cursor={{fill:'rgba(0,0,0,0.05)'}} />
                                        <ReferenceLine x={0} stroke="#334155" />
                                        <Bar dataKey="diff" barSize={barHeight * 0.8}>
                                            {data.map((entry, index) => (<Cell key={index} fill={entry.diff >= 0 ? '#4A86E8' : '#E67C73'} />))}
                                            <LabelList dataKey="diff" position="insideRight" formatter={(v)=>v.toLocaleString()} style={{fontSize:11, fill:'#64748b'}} />
                                        </Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                    <div className="h-8 border-t border-slate-200 flex shrink-0">
                        <div className="w-24 border-r border-slate-200 bg-slate-100 flex items-center justify-center text-slate-400"><Icon name="MousePointer2" size={14} /></div>
                        <div className="flex-1 overflow-hidden bg-slate-50" ref={bottomRef} onWheel={(e)=>handleWheel(e, 'x')}>
                            <div style={{width: chartWidth, minWidth:'100%', height:'100%'}}>
                                <ResponsiveContainer>
                                    <BarChart layout="vertical" data={[{}]} margin={{right:30, left:0}}>
                                        <XAxis type="number" domain={[-maxVal, maxVal]} tick={{fontSize:10}} />
                                        <YAxis type="category" width={0} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const OptionOI = ({ charts, setCharts }) => {
            const [ticker, setTicker] = useState('');
            const [error, setError] = useState(null);

            // Êñ∞„Åó„ÅÑ„Éá„Éº„Çø„ÇíËøΩÂä†Âá¶ÁêÜ
            const handleData = (rows) => {
                const step = 50; // „Éá„Éï„Ç©„É´„ÉàStep
                const res = processOptionData(rows, step);
                if (res.error) {
                    setError(res.error);
                } else {
                    setError(null);
                    // Êó¢Â≠ò„ÅÆ„ÉÅ„É£„Éº„Éà„É™„Çπ„Éà„Å´Êñ∞„Åó„ÅÑ„ÉÅ„É£„Éº„Éà„ÇíËøΩÂä†
                    const newChart = {
                        id: Date.now().toString(), // „É¶„Éã„Éº„ÇØID
                        data: res.data,
                        step: step,
                        rawRows: rows
                    };
                    setCharts([...charts, newChart]);
                }
            };

            // „ÉÅ„É£„Éº„ÉàÂÅ¥„ÅßStepÂ§âÊõ¥„Åå„ÅÇ„Å£„ÅüÂ†¥Âêà„Å´Ë¶™„ÅÆState„ÇíÊõ¥Êñ∞
            const handleStepChange = (id, newStep, newData) => {
                setCharts(charts.map(c => 
                    c.id === id ? { ...c, step: newStep, data: newData } : c
                ));
            };

            const handleTickerNav = () => {
                if(!ticker) return;
                const symbol = ticker.trim().toUpperCase();
                window.open(`https://optioncharts.io/options/${symbol}/option-chain`, '_blank');
            };

            const links = [
                { label: 'QQQ', url: 'https://optioncharts.io/options/QQQ/option-chain' },
                { label: 'SPY', url: 'https://optioncharts.io/options/SPY/option-chain' },
                { label: 'DJI', url: 'https://optioncharts.io/options/$DJX/option-chain' },
                { label: 'IWM', url: 'https://optioncharts.io/options/IWM/option-chain' },
                { label: 'VIX', url: 'https://optioncharts.io/options/$VIX/option-chain' },
                { label: 'NVIDIA', url: 'https://optioncharts.io/options/NVDA/option-chain' },
                { label: 'APPL', url: 'https://optioncharts.io/options/AAPL/option-chain' },
                { label: 'AMZN', url: 'https://optioncharts.io/options/AMZN/option-chain' },
                { label: 'GLD', url: 'https://optioncharts.io/options/GLD/option-chain' },
                { label: 'SLV', url: 'https://optioncharts.io/options/SLV/option-chain' },
            ];

            return (
                <div className="h-full flex flex-col pb-20">
                    <div className="flex justify-between items-center mb-6">
                        <div><h2 className="text-2xl font-bold text-slate-800">Option ÂàÜÊûê</h2><p className="text-slate-500">Âª∫Áéâ„ÅÆÂ£Å„ÇíÂèØË¶ñÂåñ</p></div>
                        {charts.length > 0 && <button onClick={() => setCharts([])} className="text-sm text-red-500 hover:underline">„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢</button>}
                    </div>

                    {/* „ÉÅ„É£„Éº„Éà‰∏ÄË¶ß */}
                    {charts.map(chart => (
                        <OIChart 
                            key={chart.id} 
                            id={chart.id}
                            initialData={chart.data} 
                            initialStep={chart.step}
                            rawRows={chart.rawRows}
                            onStepChange={handleStepChange}
                        />
                    ))}

                    {error && <div className="mb-4 p-3 bg-red-50 text-red-600 rounded flex items-center gap-2"><Icon name="AlertTriangle" />{error}</div>}

                    {/* ÂÖ•Âäõ„Éï„Ç©„Éº„É† (Â∏∏„Å´ÊúÄ‰∏ãÈÉ®„Å´Ë°®Á§∫) */}
                    <div className="flex flex-col items-center justify-center py-8 border-t border-slate-200 mt-4 bg-slate-50/50 rounded-xl">
                        <p className="text-slate-400 font-bold mb-4 text-sm uppercase">Add New Chart</p>
                         <div className="mb-6 flex flex-wrap justify-center gap-x-4 gap-y-2 max-w-4xl px-4">
                            {links.map(l => (
                                <a key={l.label} href={l.url} target="_blank" className="text-blue-600 hover:underline text-sm font-medium flex items-center gap-1">
                                    {l.label} <Icon name="ExternalLink" size={10} />
                                </a>
                            ))}
                         </div>
                         <div className="mb-10 flex items-center gap-2">
                            <span className="text-sm text-slate-500 font-bold">Ticker:</span>
                            <input 
                                type="text" 
                                className="border border-slate-300 rounded px-2 py-1 text-sm w-24 focus:outline-none focus:border-blue-500"
                                placeholder="e.g. TSLA"
                                value={ticker}
                                onChange={(e)=>setTicker(e.target.value)}
                                onKeyDown={(e)=>e.key === 'Enter' && handleTickerNav()}
                            />
                            <button onClick={handleTickerNav} className="bg-slate-800 text-white text-xs px-3 py-1.5 rounded hover:bg-slate-700 font-medium">Go</button>
                         </div>
                         <DataInput onDataParsed={handleData} />
                    </div>
                </div>
            );
        };

        // ==========================================
        //  Main Layout
        // ==========================================
        const App = () => {
            const [view, setView] = useState('option');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            
            // --- Option Charts State (Persisted in App) ---
            const [optionCharts, setOptionCharts] = useState([]);

            // --- Custom Links State ---
            const [customLinks, setCustomLinks] = useState(() => {
                const saved = localStorage.getItem('market-dash-links');
                return saved ? JSON.parse(saved) : [];
            });
            const [isAddingLink, setIsAddingLink] = useState(false);
            const [newLinkLabel, setNewLinkLabel] = useState('');
            const [newLinkUrl, setNewLinkUrl] = useState('');
            const [linkType, setLinkType] = useState('link'); // 'link' | 'divider'

            const addCustomLink = () => {
                if (linkType === 'link') {
                    if (newLinkLabel && newLinkUrl) {
                        let url = newLinkUrl;
                        if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
                        const updated = [...customLinks, { label: newLinkLabel, url, type: 'link' }];
                        setCustomLinks(updated);
                        localStorage.setItem('market-dash-links', JSON.stringify(updated));
                        setNewLinkLabel('');
                        setNewLinkUrl('');
                        setIsAddingLink(false);
                    }
                } else {
                    // Category
                    if (newLinkLabel) {
                        const updated = [...customLinks, { label: newLinkLabel, url: '', type: 'divider' }];
                        setCustomLinks(updated);
                        localStorage.setItem('market-dash-links', JSON.stringify(updated));
                        setNewLinkLabel('');
                        setNewLinkUrl('');
                        setIsAddingLink(false);
                    }
                }
            };

            const removeCustomLink = (index) => {
                const updated = customLinks.filter((_, i) => i !== index);
                setCustomLinks(updated);
                localStorage.setItem('market-dash-links', JSON.stringify(updated));
            };

            // --- Drag & Drop for Quick Links ---
            const [draggedIndex, setDraggedIndex] = useState(null);

            const handleDragStart = (e, index) => {
                setDraggedIndex(index);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                if (draggedIndex === null || draggedIndex === index) return;
                
                const newLinks = [...customLinks];
                const [removed] = newLinks.splice(draggedIndex, 1);
                newLinks.splice(index, 0, removed);
                
                setCustomLinks(newLinks);
                setDraggedIndex(index);
            };

            const handleDragEnd = () => {
                setDraggedIndex(null);
                localStorage.setItem('market-dash-links', JSON.stringify(customLinks));
            };

            const NavItem = ({ id, label, icon }) => (
                <button onClick={() => { setView(id); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${view === id ? 'bg-blue-600 text-white shadow' : 'text-slate-600 hover:bg-slate-100'}`}>
                    <Icon name={icon} /><span className="font-medium">{label}</span>
                </button>
            );

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className={`fixed lg:static inset-y-0 left-0 z-50 w-64 bg-white border-r border-slate-200 transform transition-transform ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'} shadow-xl lg:shadow-none flex flex-col`}>
                        <div className="h-6"></div>
                        
                        <div className="flex-1 overflow-y-auto overflow-x-hidden p-4 space-y-2 flex flex-col relative">
                            <div className="text-xs font-bold text-slate-400 px-2 mb-2">MENU</div>
                            <NavItem id="option" label="Option ÂàÜÊûê" icon="BarChart3" />
                            <NavItem id="jpx" label="JPX Êµ∑Â§ñÊäïË≥áÂÆ∂ÂãïÂêë" icon="LineChart" />
                            <NavItem id="participant" label="ÂèñÂºïÂèÇÂä†ËÄÖÂà•ÂèñÂºïÈ´ò" icon="Briefcase" />
                            
                            <div className="flex-1 min-h-[20px]"></div>

                            {/* Reorderable Quick Links */}
                            {customLinks.length > 0 && (
                                <div className="space-y-1 mb-4 pb-12">
                                    <div className="text-xs font-bold text-slate-400 px-2 mb-2">QUICK LINKS</div>
                                    <div className="flex flex-col gap-1">
                                        {customLinks.map((link, i) => {
                                            const isDivider = link.type === 'divider';
                                            return (
                                                <div 
                                                    key={i} 
                                                    draggable
                                                    onDragStart={(e) => handleDragStart(e, i)}
                                                    onDragOver={(e) => handleDragOver(e, i)}
                                                    onDragEnd={handleDragEnd}
                                                    className={`group flex items-center gap-2 px-3 py-1 rounded-lg transition-colors cursor-move ${draggedIndex === i ? 'dragging' : ''} ${isDivider ? 'mt-2 mb-1' : 'hover:bg-slate-100'}`}
                                                >
                                                    <div className="text-slate-300 group-hover:text-slate-400 cursor-grab active:cursor-grabbing">
                                                        <Icon name="GripVertical" size={14} />
                                                    </div>
                                                    
                                                    {isDivider ? (
                                                        <div className="flex-1 flex items-center gap-2 text-slate-400 text-xs font-bold uppercase tracking-wider overflow-hidden">
                                                            <Icon name="FolderOpen" size={12} />
                                                            <span className="truncate">{link.label}</span>
                                                            <div className="flex-1 h-px bg-slate-200 ml-2"></div>
                                                        </div>
                                                    ) : (
                                                        <a href={link.url} target="_blank" rel="noopener noreferrer" className="flex-1 flex items-center gap-2 text-slate-600 text-sm font-medium overflow-hidden pointer-events-none group-hover:pointer-events-auto">
                                                            <Icon name="ExternalLink" size={14} className="shrink-0" />
                                                            <span className="truncate">{link.label}</span>
                                                        </a>
                                                    )}

                                                    <button onClick={() => removeCustomLink(i)} className="opacity-0 group-hover:opacity-100 p-1 text-slate-400 hover:text-red-500 transition-opacity">
                                                        <Icon name="Trash2" size={12} />
                                                    </button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            <div className="absolute bottom-4 left-0 right-0 px-4 flex justify-center">
                                {!isAddingLink ? (
                                    <button 
                                        onClick={() => setIsAddingLink(true)}
                                        className="w-10 h-10 flex items-center justify-center rounded-full bg-slate-50 border border-slate-200 text-slate-400 hover:text-blue-600 hover:bg-white hover:shadow-md transition-all duration-200"
                                        title="„É™„É≥„ÇØ„ÇíËøΩÂä†"
                                    >
                                        <Icon name="Plus" size={20} />
                                    </button>
                                ) : (
                                    <div className="w-full bg-white rounded-xl shadow-xl border border-slate-200 p-4 animate-fade-in-up">
                                        <div className="flex justify-between items-center mb-3">
                                            <p className="text-xs font-bold text-slate-500 uppercase">Add Item</p>
                                            <button onClick={() => setIsAddingLink(false)} className="text-slate-400 hover:text-slate-600"><Icon name="X" size={14}/></button>
                                        </div>
                                        
                                        {/* Type Toggle */}
                                        <div className="flex bg-slate-100 p-1 rounded-lg mb-3">
                                            <button 
                                                onClick={() => setLinkType('link')}
                                                className={`flex-1 text-xs py-1.5 rounded-md font-bold transition-all ${linkType === 'link' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                            >
                                                LINK
                                            </button>
                                            <button 
                                                onClick={() => setLinkType('divider')}
                                                className={`flex-1 text-xs py-1.5 rounded-md font-bold transition-all ${linkType === 'divider' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                            >
                                                CATEGORY
                                            </button>
                                        </div>

                                        <div className="space-y-3">
                                            <input 
                                                type="text" 
                                                placeholder="Name" 
                                                autoFocus
                                                className="w-full text-xs p-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition-all" 
                                                value={newLinkLabel}
                                                onChange={(e) => setNewLinkLabel(e.target.value)}
                                            />
                                            {linkType === 'link' && (
                                                <input 
                                                    type="text" 
                                                    placeholder="URL" 
                                                    className="w-full text-xs p-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition-all" 
                                                    value={newLinkUrl}
                                                    onChange={(e) => setNewLinkUrl(e.target.value)}
                                                />
                                            )}
                                            <button 
                                                onClick={addCustomLink}
                                                disabled={!newLinkLabel || (linkType === 'link' && !newLinkUrl)}
                                                className="w-full bg-slate-800 text-white text-xs py-2 rounded-lg hover:bg-slate-700 disabled:opacity-50 font-bold transition-colors"
                                            >
                                                ËøΩÂä†
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </aside>

                    {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-40 lg:hidden" onClick={() => setSidebarOpen(false)}></div>}
                    
                    <div className="flex-1 flex flex-col min-w-0">
                        <header className="h-16 bg-white border-b border-slate-200 flex items-center px-4 lg:hidden shrink-0">
                            <button onClick={() => setSidebarOpen(true)} className="p-2 text-slate-600"><Icon name="Menu" /></button>
                            <span className="ml-4 font-bold text-slate-700">
                                {view === 'option' ? 'Option ÂàÜÊûê' : view === 'jpx' ? 'JPX Êµ∑Â§ñÊäïË≥áÂÆ∂ÂãïÂêë' : 'ÂèñÂºïÂèÇÂä†ËÄÖÂà•ÂèñÂºïÈ´ò'}
                            </span>
                        </header>
                        <main className="flex-1 overflow-auto p-4 md:p-6 bg-slate-50">
                            <div className="max-w-7xl mx-auto h-full">
                                {/* Profit Management Dashboard (Always visible at top) */}
                                <ProfitManager />
                                
                                {/* Switched Views */}
                                {view === 'jpx' ? <ForeignInvestors /> : 
                                 view === 'participant' ? <ParticipantVolume /> : 
                                 <OptionOI charts={optionCharts} setCharts={setOptionCharts} />}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
