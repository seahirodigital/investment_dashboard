<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Market Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@0.294.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        body { background-color: #f8fafc; font-family: 'Helvetica Neue', Arial, sans-serif; color: #334155; }
        .animate-fade-in-up { animation: fadeInUp 0.6s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .cal-grid { display: grid; grid-template-columns: 90px repeat(5, 1fr) 100px; gap: 1px; background-color: #e2e8f0; border: 1px solid #e2e8f0; }
        @media (max-width: 768px) { .cal-grid { grid-template-columns: repeat(5, 1fr) 60px; } .cal-label-col { display: none !important; } .cal-header:first-child { display: none; } .stat-box-mobile { min-width: 60% !important; max-width: 60% !important; flex: 0 0 60% !important; } .unified-header-card { height: auto; flex-direction: column; align-items: flex-start; gap: 0.5rem; padding: 1rem; } .unified-header-title { font-size: 1.25rem; } }
        .cal-cell { background-color: white; min-height: 150px; padding: 4px; position: relative; transition: background-color 0.2s; }
        .cal-cell:hover { background-color: #F3E5F5; z-index: 20; }
        .cal-header { background-color: #f8fafc; color: #64748b; font-size: 0.75rem; font-weight: bold; text-align: center; padding: 8px 0; }
        .cal-label-col { background-color: #f8fafc; display: flex; flex-direction: column; justify-content: center; gap: 4px; padding: 8px; }
        .cal-total-col { background-color: #f8fafc; display: flex; flex-direction: column; justify-content: center; align-items: flex-end; padding-right: 8px; gap: 4px; }
        .markdown-preview, .editor-preview, .editor-preview-side { color: #334155; font-size: 13px; line-height: 1.6; }
        .editor-preview img, .editor-preview-side img, .markdown-preview img { max-width: 100%; height: auto; border-radius: 4px; margin: 8px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .CodeMirror { border: 1px solid #e2e8f0; border-radius: 0 0 0.5rem 0.5rem; font-family: monospace; font-size: 14px; flex: 1; height: auto !important; }
        .stock-tooltip { visibility: hidden; opacity: 0; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-5px); z-index: 100; background-color: rgba(255, 255, 255, 0.98); border: 1px solid #cbd5e1; padding: 0; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); width: 260px; max-height: 300px; overflow-y: auto; font-size: 11px; pointer-events: none; transition: opacity 0.15s, transform 0.15s; }
        .cal-cell:hover .stock-tooltip { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(-10px); pointer-events: auto; }
        .quote-scroll-container { display: flex; overflow-x: auto; gap: 16px; padding: 16px; scroll-behavior: smooth; }
        .quote-card { flex: 0 0 300px; min-height: 120px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); position: relative; transition: transform 0.2s, box-shadow 0.2s; }
        .quote-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .card-scroll-content { max-height: 180px; overflow-y: auto; }
        .unified-header-card { background: linear-gradient(135deg, #7C4DFF 0%, #651FFF 100%); color: white; border-radius: 0.75rem; padding: 1rem 1.5rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); height: 96px; }
        .unified-header-title { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; }
        .unified-header-sub { font-size: 0.75rem; opacity: 0.9; }
        .search-results-dropdown { position: absolute; top: 100%; right: 0; margin-top: 4px; width: 300px; max-height: 400px; overflow-y: auto; background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 60; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Cell, ReferenceLine, ResponsiveContainer } = Recharts;

        // --- Icons (共通) ---
        const Icon = ({ name, size = 20, className = "", style = {} }) => {
            const icons = {
                Menu: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="12" x2="20" y2="12" /><line x1="4" y1="6" x2="20" y2="6" /><line x1="4" y1="18" x2="20" y2="18" /></svg>,
                Calendar: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></svg>,
                Lightbulb: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5 0-2.2-1.8-4-4-4a4 4 0 0 0-4 4c0 1.5.5 2.5 1.5 3.5.8.8 1.3 1.5 1.5 2.5" /><path d="M9 18h6" /><path d="M10 22h4" /></svg>,
                TrendingUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></svg>,
                LineChart: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18" /><path d="m19 9-5 5-4-4-3 3" /></svg>,
                BarChart3: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18" /><path d="M18 17V9" /><path d="M13 17V5" /><path d="M8 17v-3" /></svg>,
                Briefcase: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></svg>,
                LayoutDashboard: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1" /><rect width="7" height="5" x="14" y="3" rx="1" /><rect width="7" height="9" x="14" y="12" rx="1" /><rect width="7" height="5" x="3" y="16" rx="1" /></svg>,
                ChevronLeft: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6" /></svg>,
                ChevronRight: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6" /></svg>,
                Search: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></svg>,
                Settings: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></svg>,
                X: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>,
                FileUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" /><path d="M12 12v9" /><path d="m16 16-4-4-4 4" /></svg>,
                FileText: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><line x1="10" y1="9" x2="8" y2="9" /></svg>,
                Database: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" /><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" /></svg>,
                Pencil: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" /><path d="m15 5 4 4" /></svg>,
                Trash2: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></svg>,
                FolderOpen: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2" /></svg>,
                Link: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></svg>,
                ExternalLink: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></svg>,
                Plus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>,
                GripVertical: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></svg>,
                Pin: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="17" x2="12" y2="22" /><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z" /></svg>,
                PinOff: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="2" y1="2" x2="22" y2="22" /><line x1="12" y1="17" x2="12" y2="22" /><path d="M9 9v1.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V17h14" /><path d="M15 9.34V6h1a2 2 0 0 0 0-4H7.89" /></svg>,
                Archive: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="5" x="2" y="3" rx="1" /><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8" /><path d="M10 12h4" /></svg>,
                Bookmark: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z" /></svg>,
                ArrowLeft: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7" /><path d="M19 12H5" /></svg>,
                ArrowRight: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></svg>,
                RotateCcw: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></svg>,
                List: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></svg>,
                Send: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
                Check: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12" /></svg>,
                FileCsv: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><path d="M8 13h2" /><path d="M8 17h2" /><path d="M14 13h2" /><path d="M14 17h2" /></svg>,
                Upload: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></svg>
            };
            return icons[name] || null;
        };

        const CATEGORY_STYLES = {
            stocks: { bg: 'bg-[#F3E5F5]', text: 'text-[#7E57C2]', label: '現物' },
            margin: { bg: 'bg-[#E8EAF6]', text: 'text-[#5C6BC0]', label: '信用' },
            foreign: { bg: 'bg-[#EDE7F6]', text: 'text-[#673AB7]', label: '米国' },
            cfd: { bg: 'bg-[#FCE4EC]', text: 'text-[#D81B60]', label: 'CFD' },
            event: { bg: 'bg-white', text: 'text-[#7C4DFF]', label: 'Event' }
        };

        // --- Components ---
        const EasyMDEEditor = ({ value, onChange, uploadConfig, onSave }) => {
            const textareaRef = useRef(null);
            const mdeRef = useRef(null);
            const onSaveRef = useRef(onSave); 
            useEffect(() => { onSaveRef.current = onSave; }, [onSave]);
            useEffect(() => {
                if (!textareaRef.current) return;
                mdeRef.current = new EasyMDE({
                    element: textareaRef.current, initialValue: value, spellChecker: false, status: false,
                    toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "|", "preview", "side-by-side", "fullscreen"],
                    placeholder: "内容を入力...", forceSync: true,
                    previewRender: function(plainText) { return window.marked ? window.marked.parse(plainText) : plainText; },
                    extraKeys: { "Ctrl-S": function(cm) { if (onSaveRef.current) onSaveRef.current(); }, "Cmd-S": function(cm) { if (onSaveRef.current) onSaveRef.current(); } }
                });
                mdeRef.current.codemirror.on("change", () => onChange(mdeRef.current.value()));
                // Paste Image Logic (omitted for brevity but kept same structure)
                return () => { mdeRef.current.toTextArea(); mdeRef.current = null; };
            }, []);
            useEffect(() => { if (mdeRef.current && value !== mdeRef.current.value()) { mdeRef.current.value(value); } }, [value]);
            return <textarea ref={textareaRef} />;
        };

        const QuotesManager = ({ quotes, setQuotes, prefillBody }) => {
            const [input, setInput] = useState("");
            const [editId, setEditId] = useState(null);
            const [filterBookmarked, setFilterBookmarked] = useState(false);
            const [filterArchived, setFilterArchived] = useState(false); 
            const scrollRef = useRef(null);
            const [autoScroll, setAutoScroll] = useState(true);
            const scrollInterval = useRef(null);
            const [displayQuotes, setDisplayQuotes] = useState([]);
            const isInitialized = useRef(false);

            useEffect(() => {
                if (isInitialized.current) return;
                if (quotes.length > 0) {
                    const streamSource = quotes.filter(q => !q.archived); 
                    const shuffled = [...streamSource].sort(() => Math.random() - 0.5);
                    setDisplayQuotes(shuffled);
                    isInitialized.current = true;
                } else if (quotes.length === 0) { setDisplayQuotes([]); isInitialized.current = true; }
            }, [quotes]);
            useEffect(() => { if (prefillBody) { setInput(prefillBody); } }, [prefillBody]);
            useEffect(() => {
                if (autoScroll) {
                    scrollInterval.current = setInterval(() => {
                        if (scrollRef.current) {
                            const container = scrollRef.current;
                            if (container.scrollLeft >= container.scrollWidth - container.clientWidth - 5) { container.scrollLeft = 0; } else { container.scrollLeft += 1; }
                        }
                    }, 30);
                } else clearInterval(scrollInterval.current);
                return () => clearInterval(scrollInterval.current);
            }, [autoScroll]);
            const handleScrollLeft = () => { if (scrollRef.current) scrollRef.current.scrollLeft -= 316; };
            const handleScrollRight = () => { if (scrollRef.current) scrollRef.current.scrollLeft += 316; };
            const addQuote = (forcePin = false) => { 
                if (!input.trim()) return; 
                if (editId) { setQuotes(quotes.map(q => q.id === editId ? { ...q, text: input, pinned: forcePin ? true : q.pinned } : q)); setEditId(null); } else { 
                    const parts = input.split(/ーーー|---/);
                    const newQuotes = parts.map((part, index) => { if (!part.trim()) return null; return { id: Date.now().toString() + index, text: part.trim(), pinned: forcePin, bookmarked: false, archived: false, order: quotes.length + index, createdAt: Date.now() }; }).filter(q => q !== null);
                    const updatedQuotes = [...newQuotes, ...quotes]; setQuotes(updatedQuotes); setDisplayQuotes(prev => [...newQuotes, ...prev]); if (scrollRef.current) scrollRef.current.scrollLeft = 0;
                }
                setInput("");
            };
            const deleteQuote = (id) => { setQuotes(quotes.filter(q => q.id !== id)); };
            const archiveQuote = (id) => { setQuotes(quotes.map(q => q.id === id ? { ...q, archived: true } : q)); }; 
            const restoreQuote = (id) => { setQuotes(quotes.map(q => q.id === id ? { ...q, archived: false } : q)); }; 
            const restoreToStream = (id) => { setQuotes(quotes.map(q => q.id === id ? { ...q, archived: false, pinned: false } : q)); }; 
            const togglePin = (id) => setQuotes(quotes.map(q => q.id === id ? { ...q, pinned: !q.pinned } : q));
            const toggleBookmark = (id) => setQuotes(quotes.map(q => q.id === id ? { ...q, bookmarked: !q.bookmarked } : q));
            const startEdit = (quote) => { setInput(quote.text); setEditId(quote.id); };
            const visiblePinnedQuotes = quotes.filter(q => q.pinned && (filterArchived ? q.archived : !q.archived));
            const streamQuotes = displayQuotes.filter(dq => { const exists = quotes.find(q => q.id === dq.id); if (!exists) return false; if (filterBookmarked) { return exists.bookmarked; } if (exists.archived) return false; return true; }).map(dq => quotes.find(q => q.id === dq.id));

            return (
                <div className="space-y-6 pb-10">
                    <div className="unified-header-card"><div className="unified-header-title"><Icon name="Lightbulb" size={28} /> 投資の格言集</div><p className="unified-header-sub">心に留めておくべきルールと戒め</p></div>
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in-up">
                        <div className="flex justify-between items-center mb-4"><h2 className="text-sm font-bold text-slate-500 flex items-center gap-2"><Icon name="Pin" size={16} /> 重要ピン</h2><button onClick={() => setFilterArchived(!filterArchived)} className={`flex items-center gap-1 text-xs px-2 py-1 rounded border ${filterArchived ? 'bg-[#7C4DFF] text-white border-[#7C4DFF]' : 'bg-white text-slate-500 border-slate-300'}`}><Icon name="Archive" size={12} /> アーカイブ</button></div>
                        {visiblePinnedQuotes.length > 0 && (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{visiblePinnedQuotes.map((q, i) => (<div key={q.id} className={`bg-white rounded-xl shadow-sm border-l-4 ${q.archived ? 'border-slate-400 opacity-70' : 'border-[#7C4DFF]'} p-4 relative group hover:shadow-md transition-all`}><div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white z-10">{q.archived ? (<><button onClick={() => restoreToStream(q.id)} className="p-1 text-slate-400 hover:text-[#7C4DFF]"><Icon name="List" size={14} /></button><button onClick={() => restoreQuote(q.id)} className="p-1 text-slate-400 hover:text-green-500"><Icon name="RotateCcw" size={14} /></button><button onClick={() => deleteQuote(q.id)} className="p-1 text-slate-400 hover:text-red-500"><Icon name="Trash2" size={14} /></button></>) : (<><button onClick={() => togglePin(q.id)} className="p-1 text-slate-400 hover:text-[#7C4DFF]"><Icon name="PinOff" size={14} /></button><button onClick={() => startEdit(q)} className="p-1 text-slate-400 hover:text-[#536DFE]"><Icon name="Pencil" size={14} /></button><button onClick={() => archiveQuote(q.id)} className="p-1 text-slate-400 hover:text-red-500"><Icon name="X" size={14} /></button></>)}</div><div className="card-scroll-content"><div className="markdown-preview text-sm" dangerouslySetInnerHTML={{ __html: window.marked ? window.marked.parse(q.text) : q.text }} /></div></div>))}</div>)}
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 relative animate-fade-in-up group mt-6" onMouseEnter={() => setAutoScroll(false)} onMouseLeave={() => setAutoScroll(true)}>
                        <div className="flex justify-between items-center mb-4"><h2 className="text-sm font-bold text-slate-500">格言ストリーム</h2><button onClick={() => setFilterBookmarked(!filterBookmarked)} className={`flex items-center gap-1 text-xs px-2 py-1 rounded border ${filterBookmarked ? 'bg-[#7C4DFF] text-white border-[#7C4DFF]' : 'bg-white text-[#7C4DFF] border-[#7C4DFF]'}`}><Icon name="Bookmark" size={12} fill={filterBookmarked ? "currentColor" : "none"} /> ブックマーク</button></div>
                        <button onClick={handleScrollLeft} className="absolute left-2 top-1/2 -translate-y-1/2 z-10 bg-white/80 p-2 rounded-full shadow hover:bg-white text-[#7C4DFF] opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="ArrowLeft" /></button>
                        <button onClick={handleScrollRight} className="absolute right-2 top-1/2 -translate-y-1/2 z-10 bg-white/80 p-2 rounded-full shadow hover:bg-white text-[#7C4DFF] opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="ArrowRight" /></button>
                        <div ref={scrollRef} className="quote-scroll-container">{streamQuotes.map(q => (<div key={q.id} className="quote-card shrink-0"><div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white/90 z-20"><button onClick={() => toggleBookmark(q.id)} className={`p-1 ${q.bookmarked ? 'text-[#7C4DFF]' : 'text-slate-400'} hover:text-[#7C4DFF]`}><Icon name="Bookmark" size={14} fill={q.bookmarked ? "#7C4DFF" : "none"} /></button><button onClick={() => togglePin(q.id)} className={`p-1 ${q.pinned ? 'text-[#7C4DFF]' : 'text-slate-400'} hover:text-[#7C4DFF]`}><Icon name="Pin" size={14} fill={q.pinned ? "#7C4DFF" : "none"} /></button><button onClick={() => startEdit(q)} className="p-1 text-slate-400 hover:text-[#536DFE]"><Icon name="Pencil" size={14} /></button><button onClick={() => deleteQuote(q.id)} className="p-1 text-slate-400 hover:text-red-500"><Icon name="X" size={14} /></button></div><div className="card-scroll-content"><div className="markdown-preview text-sm" dangerouslySetInnerHTML={{ __html: window.marked ? window.marked.parse(q.text) : q.text }} /></div>{q.bookmarked && <div className="absolute top-2 left-2 text-[#7C4DFF]"><Icon name="Bookmark" size={16} fill="#7C4DFF" /></div>}{q.pinned && <div className="absolute top-2 left-8 text-[#7C4DFF]"><Icon name="Pin" size={16} fill="#7C4DFF" /></div>}</div>))}</div>
                    </div>
                    <div className="bg-white rounded-xl shadow-xl border border-slate-200 p-4 animate-fade-in-up mt-6"><div className="flex flex-col md:flex-row gap-2"><div className="flex-1"><EasyMDEEditor value={input} onChange={setInput} onSave={() => addQuote(false)} /></div><div className="flex md:flex-col gap-2 self-end md:self-start w-full md:w-auto"><button onClick={() => addQuote(false)} className="flex-1 bg-[#7C4DFF] text-white px-6 rounded-lg font-bold hover:bg-[#651FFF] transition-colors py-2 md:py-3 whitespace-nowrap">STREAM</button><button onClick={() => addQuote(true)} className="flex-1 bg-white text-[#7C4DFF] border border-[#7C4DFF] px-6 rounded-lg font-bold hover:bg-purple-50 transition-colors py-2 md:py-3 whitespace-nowrap flex items-center justify-center gap-1"><Icon name="Pin" size={16} /> PIN</button></div></div></div>
                </div>
            );
        };

        const ProfitManager = ({ customLinks, setCustomLinks, quotes, setQuotes, historyData, updateHistoryData, saveAllData, onMoveToQuotes }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [editData, setEditData] = useState({ event: '', stocks: 0, margin: 0, foreign: 0, cfd: 0, note: '', important: false, details: [] });
            const [importCategory, setImportCategory] = useState('stocks');
            const [chartMode, setChartMode] = useState('daily');
            const [searchQuery, setSearchQuery] = useState('');
            const [isSearchFocused, setIsSearchFocused] = useState(false);
            const [gistToken, setGistToken] = useState(localStorage.getItem('gist_token') || '');
            const [gistId, setGistId] = useState(localStorage.getItem('gist_id') || '');
            const [repoOwner, setRepoOwner] = useState(localStorage.getItem('repo_owner') || 'seahirodigital');
            const [repoName, setRepoName] = useState(localStorage.getItem('repo_name') || 'investment_dashboard');

            const formatMoney = (val) => val ? val.toLocaleString() : '0';
            const getDateKey = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            const uploadConfig = useMemo(() => ({ token: gistToken, owner: repoOwner, repo: repoName }), [gistToken, repoOwner, repoName]);

            const handleSaveSettings = () => { localStorage.setItem('gist_token', gistToken.trim()); localStorage.setItem('gist_id', gistId.trim()); localStorage.setItem('repo_owner', repoOwner.trim()); localStorage.setItem('repo_name', repoName.trim()); setIsSettingsOpen(false); alert("設定を保存しました。"); };
            const searchResults = useMemo(() => { if (!searchQuery.trim()) return []; const query = searchQuery.toLowerCase(); return Object.entries(historyData).filter(([key, val]) => { const noteMatch = val.note && val.note.toLowerCase().includes(query); const eventMatch = val.event && val.event.toLowerCase().includes(query); return noteMatch || eventMatch; }).sort((a, b) => new Date(b[0]) - new Date(a[0])).map(([key, val]) => ({ date: key, ...val })); }, [searchQuery, historyData]);
            const stats = useMemo(() => { const y = currentDate.getFullYear().toString(); const m = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`; const prevDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1); const pm = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}`; let yt = 0, mt = 0, pt = 0; let mb = { s: 0, m: 0, f: 0, c: 0 }; Object.entries(historyData).forEach(([key, val]) => { if (key.match(/^\d{4}-\d{2}-\d{2}$/)) { const t = (val.stocks || 0) + (val.margin || 0) + (val.foreign || 0) + (val.cfd || 0); if (key.startsWith(y)) yt += t; if (key.startsWith(m)) { mt += t; mb.s += (val.stocks || 0); mb.m += (val.margin || 0); mb.f += (val.foreign || 0); mb.c += (val.cfd || 0); } if (key.startsWith(pm)) pt += t; } }); return { yt, pt, mt, prevDate, mb }; }, [historyData, currentDate]);
            const calendarWeeks = useMemo(() => { const year = currentDate.getFullYear(); const month = currentDate.getMonth(); const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const weeks = []; let currentWeek = []; for (let i = 0; i < firstDay.getDay(); i++) currentWeek.push(null); for (let d = 1; d <= lastDay.getDate(); d++) { const date = new Date(year, month, d); currentWeek.push(date); if (date.getDay() === 6) { weeks.push(currentWeek); currentWeek = []; } } if (currentWeek.length > 0) { while (currentWeek.length < 7) currentWeek.push(null); weeks.push(currentWeek); } return weeks; }, [currentDate]);
            const dailyChartData = useMemo(() => { if (chartMode === 'daily') { const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate(); const data = []; for (let d = 1; d <= daysInMonth; d++) { const key = getDateKey(new Date(currentDate.getFullYear(), currentDate.getMonth(), d)); const dData = historyData[key]; data.push({ day: d, date: key, total: dData ? ((dData.stocks || 0) + (dData.margin || 0) + (dData.foreign || 0) + (dData.cfd || 0)) : 0 }); } return data; } else { const year = currentDate.getFullYear(); const data = []; for (let m = 1; m <= 12; m++) { const monthKeyPrefix = `${year}-${String(m).padStart(2, '0')}`; let monthTotal = 0; Object.entries(historyData).forEach(([key, val]) => { if (key.startsWith(monthKeyPrefix)) { monthTotal += (val.stocks || 0) + (val.margin || 0) + (val.foreign || 0) + (val.cfd || 0); } }); data.push({ day: m, name: `${m}月`, total: monthTotal }); } return data; } }, [historyData, currentDate, chartMode]);

            const openModal = (date) => { if (!date) return; const key = getDateKey(date); const data = historyData[key] || { event: '', stocks: 0, margin: 0, foreign: 0, cfd: 0, note: '', important: false, details: [] }; if (!data.note) data.note = `# ${key.replace(/-/g, '/')}`; setSelectedDate(date); setEditData({ ...data }); setIsModalOpen(true); setSearchQuery(''); };
            const handleSave = () => { const key = getDateKey(selectedDate); updateHistoryData({ ...historyData, [key]: editData }); setIsModalOpen(false); };
            const handleSaveAndQuote = () => { handleSave(); if (onMoveToQuotes) onMoveToQuotes(editData.note); };
            const handleDeleteEvent = (e, date) => { e.stopPropagation(); if (!window.confirm("イベントを削除しますか？")) return; const key = getDateKey(date); const current = historyData[key]; if (current) { updateHistoryData({ ...historyData, [key]: { ...current, event: '' } }); } };
            const handleFileImport = (file) => { if (!file) return; const reader = new FileReader(); reader.onload = (event) => Papa.parse(event.target.result, { header: false, skipEmptyLines: true, complete: (res) => { /* CSV process logic omitted for brevity */ alert("CSV取込機能 (詳細は省略)"); setIsImportModalOpen(false); } }); reader.readAsText(file, 'Shift_JIS'); };

            const DayCell = ({ date }) => {
                if (!date) return <div className="cal-cell bg-slate-50"></div>;
                const key = getDateKey(date); const data = historyData[key]; const isToday = getDateKey(new Date()) === key;
                return (<div onClick={() => openModal(date)} className={`cal-cell cursor-pointer hover:bg-[#F3E5F5] transition-colors border-r border-b border-slate-100 group ${isToday ? 'bg-[#F3E5F5]/30 ring-2 ring-inset ring-[#7C4DFF]/20' : ''}`}><div className="flex justify-center items-center mb-1 relative"><span className={`text-xs font-bold ${isToday ? 'bg-[#7C4DFF] text-white px-1.5 py-0.5 rounded-full' : 'text-slate-500'}`}>{date.getDate()}</span>{data?.note && <Icon name="FileText" size={10} className={`absolute right-0 top-0.5 ${data.important ? "text-[#7C4DFF]" : "text-[#64748B]"}`} />}</div><div className="flex flex-col gap-0.5">{data?.event ? (<div className="relative flex justify-between items-center px-1.5 py-1 rounded text-[10px] font-bold mb-1 bg-white border-l-4 border-[#7C4DFF] shadow-sm text-[#7C4DFF] group/event"><span className="truncate">{data.event}</span><div className="absolute right-1 hidden group-hover/event:flex gap-1 bg-white pl-1"><button onClick={(e)=>{e.stopPropagation();handleDeleteEvent(e,date);}} className="hover:text-[#FF4081]"><Icon name="X" size={10}/></button></div></div>) : (<div className="h-[22px] mb-1"></div>)}{data ? (<>{['stocks','margin','foreign','cfd'].map(t=>(<div key={t} className={`flex justify-end px-1.5 py-0.5 rounded text-[10px] font-medium mb-0.5 ${CATEGORY_STYLES[t].bg} ${CATEGORY_STYLES[t].text}`}><span className="w-full text-right">{formatMoney(data[t]||0)}</span></div>))}</>) : (<><div className="h-[18px]"></div><div className="h-[18px]"></div><div className="h-[18px]"></div><div className="h-[18px]"></div></>)}</div></div>);
            };

            return (
                <div className="space-y-6 mb-12">
                    <div className="flex md:grid md:grid-cols-3 gap-4 animate-fade-in-up overflow-x-auto snap-x pb-2 md:pb-0">
                        <div className="bg-white rounded-xl p-4 border border-slate-200 shadow-sm flex flex-col justify-center h-20 stat-box-mobile md:min-w-[240px] snap-center order-2 md:order-1"><p className="text-[#64748B] text-xs font-medium mb-1">今年の収益 ({currentDate.getFullYear()})</p><h3 className={`text-2xl font-bold ${stats.yt >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]'}`}>{stats.yt >= 0 ? '+' : ''}{stats.yt.toLocaleString()}</h3></div>
                        <div className="bg-white rounded-xl p-4 border border-slate-200 shadow-sm flex flex-col justify-center h-20 stat-box-mobile md:min-w-[240px] snap-center order-3 md:order-2"><p className="text-[#64748B] text-xs font-medium mb-1">先月の収益 ({stats.prevDate.getMonth()+1}月)</p><h3 className={`text-2xl font-bold ${stats.pt >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]'}`}>{stats.pt >= 0 ? '+' : ''}{stats.pt.toLocaleString()}</h3></div>
                        <div className="bg-white rounded-xl p-4 border border-slate-200 shadow-sm flex flex-col justify-center h-20 stat-box-mobile md:min-w-[240px] snap-center order-1 md:order-3"><p className="text-[#64748B] text-xs font-medium mb-1">今月の収益 ({currentDate.getMonth()+1}月)</p><h3 className={`text-2xl font-bold ${stats.mt >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]'}`}>{stats.mt >= 0 ? '+' : ''}{stats.mt.toLocaleString()}</h3></div>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-visible animate-fade-in-up">
                        <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                            <div className="flex items-center gap-4"><h2 className="text-sm md:text-xl font-bold text-[#334155] flex items-center gap-2"><Icon name="Calendar" size={20} />{currentDate.getFullYear()}年 {currentDate.getMonth() + 1}月</h2><div className="flex gap-1"><button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-1 hover:bg-white hover:shadow rounded text-slate-500"><Icon name="ChevronLeft" size={20} /></button><button onClick={() => setCurrentDate(new Date())} className="px-2 py-1 text-xs font-bold text-slate-600 hover:bg-white hover:shadow rounded">Today</button><button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-1 hover:bg-white hover:shadow rounded text-slate-500"><Icon name="ChevronRight" size={20} /></button></div></div>
                            <div className="flex gap-2 relative">
                                <div className="relative"><div className={`flex items-center gap-1 border rounded px-2 py-1.5 bg-white transition-all shadow-sm ${isSearchFocused ? 'border-[#7C4DFF] w-64' : 'border-slate-300 w-32 md:w-48'}`}><Icon name="Search" size={14} className="text-slate-400" /><input type="text" placeholder="日記を検索..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} onFocus={() => setIsSearchFocused(true)} className="w-full text-xs outline-none bg-transparent" />{searchQuery && <button onClick={() => setSearchQuery('')} className="text-slate-400 hover:text-slate-600"><Icon name="X" size={12} /></button>}</div>{searchQuery && (<div className="search-results-dropdown">{searchResults.length === 0 ? (<div className="p-3 text-xs text-slate-500 text-center">一致するデータはありません</div>) : (<ul>{searchResults.map((res) => (<li key={res.date} onClick={() => openModal(res.date)} className="p-2 border-b border-slate-100 hover:bg-purple-50 cursor-pointer flex flex-col gap-1"><div className="flex justify-between items-center"><span className="text-xs font-bold text-[#7C4DFF]">{res.date}</span>{res.event && <span className="text-[10px] bg-slate-100 px-1 rounded text-slate-600 truncate max-w-[100px]">{res.event}</span>}</div>{res.note && <div className="text-xs text-slate-500 truncate">{res.note.replace(/[#\-*]/g, '').trim()}</div>}</li>))}</ul>)}</div>)}</div>
                                <div className="relative"><button onClick={() => setIsMenuOpen(!isMenuOpen)} className={`w-8 h-8 flex items-center justify-center rounded-lg border transition-colors ${isMenuOpen ? 'bg-purple-50 border-[#7C4DFF] text-[#7C4DFF]' : 'bg-white border-slate-300 text-slate-600 hover:bg-slate-50'}`}><Icon name="Settings" size={18} /></button>{isMenuOpen && (<div className="absolute right-0 mt-2 w-56 bg-white border border-slate-200 rounded-xl shadow-xl z-50 py-1 animate-fade-in-up overflow-hidden"><button onClick={() => { setIsMenuOpen(false); setIsImportModalOpen(true); }} className="w-full text-left px-4 py-2.5 text-xs hover:bg-purple-50 flex items-center gap-3 text-slate-600">インポート</button><button onClick={() => { setIsMenuOpen(false); setIsSettingsOpen(true); }} className="w-full text-left px-4 py-2.5 text-xs hover:bg-purple-50 flex items-center gap-3 text-slate-600">同期設定</button></div>)}</div>
                            </div>
                        </div>
                        <div className="cal-grid"><div className="cal-header">Category</div>{['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].map(d => <div key={d} className="cal-header">{d}</div>)}<div className="cal-header">週計</div>{calendarWeeks.map((week, wIdx) => { const weekTotal = week.reduce((acc, d) => { if (!d) return acc; const dat = historyData[getDateKey(d)]; if (!dat) return acc; return { s: acc.s + (dat.stocks || 0), m: acc.m + (dat.margin || 0), f: acc.f + (dat.foreign || 0), c: acc.c + (dat.cfd || 0) }; }, { s: 0, m: 0, f: 0, c: 0 }); const wSum = weekTotal.s + weekTotal.m + weekTotal.f + weekTotal.c; return (<React.Fragment key={wIdx}><div className="cal-label-col border-r border-b border-slate-100"><div className="h-[26px] mb-1"></div>{Object.entries(CATEGORY_STYLES).filter(([k]) => k !== 'event').map(([key, style]) => (<div key={key} className={`text-[10px] font-bold text-center py-0.5 rounded ${style.bg} ${style.text}`}>{style.label}</div>))}</div>{week.slice(1, 6).map((date, dIdx) => (<DayCell key={dIdx} date={date} />))}<div className="cal-total-col border-b border-slate-100 bg-slate-50"><div className="flex flex-col gap-0.5 w-full text-xs"><div className="h-[26px] mb-1"></div><div className="text-right h-[18px] text-slate-400">{formatMoney(weekTotal.s)}</div><div className="text-right h-[18px] text-slate-400">{formatMoney(weekTotal.m)}</div><div className="text-right h-[18px] text-slate-400">{formatMoney(weekTotal.f)}</div><div className="text-right h-[18px] text-slate-400">{formatMoney(weekTotal.c)}</div><div className={`mt-1 pt-1 border-t border-slate-200 font-bold text-right ${wSum < 0 ? 'text-[#FF4081]' : 'text-[#7C4DFF]'}`}>{formatMoney(wSum)}</div></div></div></React.Fragment>); })}</div>
                    </div>
                    {isModalOpen && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in-up"><div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[85vh] flex flex-col overflow-hidden"><div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50"><h3 className="font-bold text-lg text-[#334155] flex items-center gap-2">{selectedDate.toLocaleDateString()}</h3><button onClick={() => setIsModalOpen(false)}><Icon name="X" /></button></div><div className="flex-1 flex overflow-hidden"><div className="w-1/4 p-6 border-r border-slate-200 bg-slate-50/50 overflow-y-auto"><div className="mb-6"><label className="block text-xs font-bold text-[#7C4DFF] mb-1 uppercase">Event</label><input type="text" value={editData.event} onChange={(e) => setEditData({...editData, event: e.target.value})} className="w-full border p-2 rounded text-sm"/></div><h4 className="text-sm font-bold text-[#64748B] uppercase mb-4">収支入力</h4>{['stocks','margin','foreign','cfd'].map(k=>(<div key={k}><label className="block text-xs font-bold text-slate-500 mb-1">{k}</label><input type="number" value={editData[k]} onChange={(e)=>setEditData({...editData,[k]:parseInt(e.target.value)||0})} className="w-full border p-2 text-right rounded"/></div>))}</div><div className="flex-1 p-6 flex flex-col"><div className="flex-1 relative"><EasyMDEEditor value={editData.note} onChange={(v)=>setEditData({...editData,note:v})} uploadConfig={uploadConfig} onSave={handleSave}/></div></div></div><div className="p-4 border-t bg-slate-50 flex justify-end gap-3"><button onClick={handleSaveAndQuote} className="px-4 py-2 bg-slate-100 text-[#7C4DFF] border border-[#7C4DFF] rounded-lg font-bold">格言へ</button><button onClick={handleSave} className="px-6 py-2 bg-[#7C4DFF] text-white rounded-lg font-bold">保存</button></div></div></div>)}
                    {isSettingsOpen && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6"><h3 className="font-bold text-lg mb-4">同期設定</h3><input type="password" value={gistToken} onChange={e=>setGistToken(e.target.value)} placeholder="GitHub Token" className="w-full border p-2 mb-2 rounded"/><input type="text" value={gistId} onChange={e=>setGistId(e.target.value)} placeholder="Gist ID" className="w-full border p-2 mb-2 rounded"/><button onClick={handleSaveSettings} className="bg-[#7C4DFF] text-white px-4 py-2 rounded font-bold w-full">保存</button></div></div>)}
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('calendar');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [sidebarWidth, setSidebarWidth] = useState(260);
            const [isCollapsed, setIsCollapsed] = useState(false);
            const [historyData, setHistoryData] = useState({});
            const [customLinks, setCustomLinks] = useState([]);
            const [quotes, setQuotes] = useState([]);
            const [gistToken, setGistToken] = useState(localStorage.getItem('gist_token') || '');
            const [gistId, setGistId] = useState(localStorage.getItem('gist_id') || '');
            const [quotePrefill, setQuotePrefill] = useState('');

            useEffect(() => {
                const loadData = async () => {
                    let cloudLoaded = false;
                    if (gistToken && gistId) {
                        try {
                            const response = await fetch(`https://api.github.com/gists/${gistId.trim()}`, { headers: { 'Authorization': `token ${gistToken.trim()}` } });
                            if (response.ok) {
                                const json = await response.json();
                                if (json.files && json.files['market_data.json']) {
                                    const content = JSON.parse(json.files['market_data.json'].content);
                                    if (content.history) { setHistoryData(content.history); localStorage.setItem('history_data', JSON.stringify(content.history)); }
                                    if (content.links) { setCustomLinks(content.links); localStorage.setItem('market-dash-links', JSON.stringify(content.links)); }
                                    if (content.quotes) { setQuotes(content.quotes); localStorage.setItem('market-dash-quotes', JSON.stringify(content.quotes)); }
                                    cloudLoaded = true;
                                }
                            }
                        } catch (e) { console.error("Gist Load Failed", e); }
                    }
                    if (!cloudLoaded) {
                        try {
                            const h = localStorage.getItem('history_data'); if (h) setHistoryData(JSON.parse(h));
                            const l = localStorage.getItem('market-dash-links'); if (l) setCustomLinks(JSON.parse(l));
                            const q = localStorage.getItem('market-dash-quotes'); if (q) setQuotes(JSON.parse(q));
                        } catch (e) { console.error("Local Load Failed", e); }
                    }
                };
                loadData();
            }, []);

            const saveAllData = (newHistory, newLinks, newQuotes) => {
                const h = newHistory !== undefined ? newHistory : historyData; const l = newLinks !== undefined ? newLinks : customLinks; const q = newQuotes !== undefined ? newQuotes : quotes;
                if (newHistory !== undefined) setHistoryData(h); if (newLinks !== undefined) setCustomLinks(l); if (newQuotes !== undefined) setQuotes(q);
                try {
                    if (newHistory !== undefined) localStorage.setItem('history_data', JSON.stringify(h));
                    if (newLinks !== undefined) localStorage.setItem('market-dash-links', JSON.stringify(l));
                    if (newQuotes !== undefined) localStorage.setItem('market-dash-quotes', JSON.stringify(q));
                } catch (e) { console.error("Local Save Failed", e); }
                if (gistToken && gistId) {
                    const content = JSON.stringify({ history: h, links: l, quotes: q, lastUpdated: new Date().toISOString() });
                    fetch(`https://api.github.com/gists/${gistId.trim()}`, { method: 'PATCH', headers: { 'Authorization': `token ${gistToken.trim()}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ files: { 'market_data.json': { content: content } } }) });
                }
            };
            const handleMoveToQuotes = (text) => { setQuotePrefill(text); setView('quotes'); };
            const NavItem = ({ href, active, label, icon }) => (
                <a href={href} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors mb-1 ${active ? 'bg-[#7C4DFF] text-white shadow' : 'text-[#64748B] hover:bg-slate-100'} ${isCollapsed ? 'justify-center' : ''}`} title={isCollapsed ? label : ''}>
                    <Icon name={icon} size={20} />{!isCollapsed && <span className="font-medium text-sm">{label}</span>}
                </a>
            );
            const InternalNavItem = ({ id, label, icon }) => (
                <button onClick={() => setView(id)} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors mb-1 ${view === id ? 'bg-[#7C4DFF] text-white shadow' : 'text-[#64748B] hover:bg-slate-100'} ${isCollapsed ? 'justify-center' : ''}`} title={isCollapsed ? label : ''}>
                    <Icon name={icon} size={20} />{!isCollapsed && <span className="font-medium text-sm">{label}</span>}
                </button>
            );

            return (
                <div className="flex h-screen overflow-hidden bg-[#f8fafc]">
                    <aside className={`fixed lg:static inset-y-0 left-0 z-50 bg-white border-r border-slate-200 flex flex-col`} style={{ width: isCollapsed ? 70 : sidebarWidth }}>
                        <div className="h-14 flex items-center justify-between px-4 border-b border-slate-100 shrink-0">{!isCollapsed && <span className="font-bold text-lg tracking-tight text-[#334155]">Dashboard</span>}<button onClick={() => setIsCollapsed(!isCollapsed)} className="p-1 text-slate-400 hover:text-[#7C4DFF]"><Icon name={isCollapsed ? "ChevronRight" : "ChevronLeft"} size={20} /></button></div>
                        <div className="flex-1 overflow-y-auto p-3 space-y-1 custom-scrollbar">
                            <InternalNavItem id="calendar" label="投資カレンダー" icon="Calendar" />
                            <InternalNavItem id="quotes" label="投資の格言集" icon="Lightbulb" />
                            <NavItem href="shutai.html" active={false} label="主体別投資動向" icon="TrendingUp" />
                            <NavItem href="jpxf.html" active={false} label="JPX 海外動向" icon="LineChart" />
                            <NavItem href="options.html" active={false} label="Option 分析" icon="BarChart3" />
                            <NavItem href="teguchi.html" active={false} label="手口上位" icon="Briefcase" />
                            <NavItem href="analytics.html" active={false} label="Analytics" icon="LayoutDashboard" />
                            {!isCollapsed && customLinks.length > 0 && <div className="mt-4"><div className="text-[10px] font-bold text-slate-400 px-2 mb-2">LINKS</div>{customLinks.map((l,i)=>(l.type==='divider'?<div key={i} className="px-2 py-1 text-xs font-bold text-slate-500 mt-2">{l.label}</div>:<a key={i} href={l.url} target="_blank" className="block px-3 py-1 text-sm text-slate-600 hover:text-[#7C4DFF] truncate">{l.label}</a>))}</div>}
                        </div>
                    </aside>
                    <div className="flex-1 flex flex-col min-w-0">
                        <header className="h-14 bg-white border-b border-slate-200 flex items-center px-4 lg:hidden shrink-0"><button onClick={() => setSidebarOpen(true)} className="p-2 text-slate-600"><Icon name="Menu" /></button><span className="ml-4 font-bold text-[#334155]">{view === 'calendar' ? '投資カレンダー' : '投資の格言集'}</span></header>
                        <main className="flex-1 overflow-auto p-4 md:p-6 bg-slate-50/50">
                            <div className="max-w-7xl mx-auto h-full">
                                {view === 'calendar' ? <ProfitManager historyData={historyData} updateHistoryData={(nd) => saveAllData(nd, undefined, undefined)} customLinks={customLinks} setCustomLinks={(nl) => saveAllData(undefined, nl, undefined)} quotes={quotes} setQuotes={(nq) => saveAllData(undefined, undefined, nq)} saveAllData={saveAllData} onMoveToQuotes={handleMoveToQuotes} /> :
                                    <QuotesManager quotes={quotes} setQuotes={(nq) => saveAllData(undefined, undefined, nq)} prefillBody={quotePrefill} />}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
