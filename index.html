<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JPX æµ·å¤–æŠ•è³‡å®¶å‹•å‘ - Foreign Investors Balance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }
        
        /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="app">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="animate-fade-in-up">
                    <h1 class="text-4xl font-bold mb-2">JPX æµ·å¤–æŠ•è³‡å®¶å‹•å‘</h1>
                    <p class="text-blue-100 text-lg">Foreign Investors Balance Tracker</p>
                    <p class="text-blue-200 text-sm mt-2" id="last-update">
                        èª­ã¿è¾¼ã¿ä¸­...
                    </p>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-8 pb-12">
            <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 animate-fade-in-up" id="stats-container">
                <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
            </div>

            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6 animate-fade-in-up">
                <div class="flex flex-wrap gap-4 items-center">
                    <!-- æœŸé–“é¸æŠ -->
                    <div class="flex items-center gap-2">
                        <span class="text-slate-600 text-sm font-medium">æœŸé–“:</span>
                        <div class="flex gap-1" id="time-range-buttons">
                            <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- ãƒãƒ£ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—é¸æŠ -->
                    <div class="flex items-center gap-2">
                        <span class="text-slate-600 text-sm font-medium">è¡¨ç¤º:</span>
                        <div class="flex gap-1" id="chart-type-buttons">
                            <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
                    <button onclick="resetZoom()" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition-colors text-sm font-medium">
                        ğŸ”„ ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                    </button>

                    <!-- æ›´æ–°ãƒœã‚¿ãƒ³ -->
                    <button onclick="loadData()" class="ml-auto px-4 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition-colors text-sm font-medium">
                        ğŸ”„ æ›´æ–°
                    </button>
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆ -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in-up">
                <h2 class="text-xl font-bold text-slate-900 mb-4">
                    å·®å¼•æ¨ç§»
                    <span class="text-sm font-normal text-slate-500 ml-2" id="data-count">
                        (ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...)
                    </span>
                </h2>
                
                <div style="position: relative; height: 500px;">
                    <canvas id="mainChart"></canvas>
                </div>

                <div class="mt-4 pt-4 border-t border-slate-200">
                    <p class="text-xs text-slate-500">
                        ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦æ‹¡å¤§ãƒ»ç¸®å°ã§ãã¾ã™
                    </p>
                </div>
            </div>

            <!-- ãƒ•ãƒƒã‚¿ãƒ¼æƒ…å ± -->
            <div class="mt-8 text-center text-slate-500 text-sm">
                <p>ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: æ—¥æœ¬å–å¼•æ‰€ã‚°ãƒ«ãƒ¼ãƒ— (JPX)</p>
                <p class="mt-1">è‡ªå‹•æ›´æ–°: æ¯é€±æœ¨æ›œæ—¥ 18:00 (JST)</p>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let chart = null;
        let currentTimeRange = 'all';
        let currentChartType = 'line';

        // é€±ç•ªå·ã‚’è¨ˆç®—
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        // æœˆã®é€±ç•ªå·ã‚’è¨ˆç®—
        function getWeekOfMonth(date) {
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
            const firstDayOfWeek = firstDay.getDay();
            const offsetDate = date.getDate() + firstDayOfWeek - 1;
            return Math.floor(offsetDate / 7) + 1;
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadData() {
            try {
                const response = await fetch('history.csv');
                if (!response.ok) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        allData = results.data
                            .filter(row => row.date && row.balance !== null && row.balance !== undefined)
                            .map(row => {
                                const date = new Date(row.date);
                                const year = date.getFullYear();
                                const weekNum = getWeekNumber(date);
                                const month = date.getMonth() + 1;
                                const weekOfMonth = getWeekOfMonth(date);
                                
                                return {
                                    date: row.date,
                                    balance: row.balance,
                                    year: year,
                                    weekNum: weekNum,
                                    month: month,
                                    weekOfMonth: weekOfMonth,
                                    displayDate: `${year}å¹´ ç¬¬${weekNum}é€±`,
                                    tooltipDate: `${year}å¹´${month}æœˆ ç¬¬${weekOfMonth}é€±`
                                };
                            })
                            .sort((a, b) => new Date(a.date) - new Date(b.date));
                        
                        if (allData.length === 0) {
                            alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                            return;
                        }
                        
                        updateStats();
                        updateChart();
                        initControls();
                        
                        // æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’è¡¨ç¤º
                        const latest = allData[allData.length - 1];
                        document.getElementById('last-update').textContent = 
                            `æœ€çµ‚æ›´æ–°: ${latest.date} | ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: ${allData.length}ä»¶`;
                    },
                    error: function(error) {
                        console.error('CSVã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                        alert('CSVã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    }
                });
            } catch (err) {
                console.error('ã‚¨ãƒ©ãƒ¼:', err);
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            }
        }

        // çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
        function calculateStats(data) {
            const positiveData = data.filter(item => item.balance > 0).map(item => item.balance);
            const negativeData = data.filter(item => item.balance < 0).map(item => item.balance);
            
            const calcMedian = (arr) => {
                if (arr.length === 0) return 0;
                const sorted = [...arr].sort((a, b) => a - b);
                const mid = Math.floor(sorted.length / 2);
                return sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid];
            };
            
            const calcAverage = (arr) => {
                if (arr.length === 0) return 0;
                return arr.reduce((sum, val) => sum + val, 0) / arr.length;
            };
            
            return {
                positiveAvg: calcAverage(positiveData),
                positiveMedian: calcMedian(positiveData),
                negativeAvg: calcAverage(negativeData),
                negativeMedian: calcMedian(negativeData),
                latest: data[data.length - 1]
            };
        }

        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        function updateStats(visibleData = null) {
            const data = visibleData || allData;
            if (data.length === 0) return;
            
            const stats = calculateStats(data);
            
            const statsConfig = [
                {
                    label: 'æœ€æ–°ã®å·®å¼•',
                    value: formatLargeNumber(stats.latest.balance),
                    subtext: stats.latest.balance >= 0 ? 'è²·ã„è¶Šã—' : 'å£²ã‚Šè¶Šã—',
                    color: stats.latest.balance >= 0 ? 'text-blue-600' : 'text-red-500'
                },
                {
                    label: 'è²·ã„è¶Šã— å¹³å‡',
                    value: formatLargeNumber(stats.positiveAvg),
                    subtext: 'è¡¨ç¤ºç¯„å›²å†…',
                    color: 'text-blue-600'
                },
                {
                    label: 'è²·ã„è¶Šã— ä¸­å¤®å€¤',
                    value: formatLargeNumber(stats.positiveMedian),
                    subtext: 'è¡¨ç¤ºç¯„å›²å†…',
                    color: 'text-blue-600'
                },
                {
                    label: 'å£²ã‚Šè¶Šã— å¹³å‡',
                    value: formatLargeNumber(stats.negativeAvg),
                    subtext: 'è¡¨ç¤ºç¯„å›²å†…',
                    color: 'text-red-500'
                },
                {
                    label: 'å£²ã‚Šè¶Šã— ä¸­å¤®å€¤',
                    value: formatLargeNumber(stats.negativeMedian),
                    subtext: 'è¡¨ç¤ºç¯„å›²å†…',
                    color: 'text-red-500'
                }
            ];
            
            const container = document.getElementById('stats-container');
            container.innerHTML = statsConfig.map(stat => `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <p class="text-slate-600 text-sm font-medium mb-2">${stat.label}</p>
                    <p class="text-3xl font-bold ${stat.color}">${stat.value}</p>
                    <p class="text-slate-400 text-xs mt-1">${stat.subtext}</p>
                </div>
            `).join('');
        }

        // å¤§ããªæ•°å€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatLargeNumber(value) {
            if (typeof value === 'number') {
                const sign = value >= 0 ? '+' : '';
                const absValue = Math.abs(value);
                if (absValue >= 100000000) {
                    return sign + (value / 100000000).toFixed(1) + 'å„„å††';
                }
                return sign + (value / 1000000).toFixed(0) + 'Må††';
            }
            return value.toString();
        }

        // æ™‚é–“ç¯„å›²ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function getFilteredData() {
            if (currentTimeRange === 'all') return allData;
            
            const now = new Date();
            const cutoffDate = new Date();
            
            switch (currentTimeRange) {
                case '3m':
                    cutoffDate.setMonth(now.getMonth() - 3);
                    break;
                case '6m':
                    cutoffDate.setMonth(now.getMonth() - 6);
                    break;
                case '1y':
                    cutoffDate.setFullYear(now.getFullYear() - 1);
                    break;
                default:
                    return allData;
            }
            
            return allData.filter(item => new Date(item.date) >= cutoffDate);
        }

        // ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
        function updateChart() {
            const filteredData = getFilteredData();
            
            document.getElementById('data-count').textContent = 
                `(${filteredData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿)`;
            
            const ctx = document.getElementById('mainChart');
            
            if (chart) {
                chart.destroy();
            }
            
            const chartConfig = {
                type: currentChartType,
                data: {
                    labels: filteredData.map(d => d.displayDate),
                    datasets: [{
                        label: 'å·®å¼•ï¼ˆå„„å††ï¼‰',
                        data: filteredData.map(d => d.balance),
                        backgroundColor: function(context) {
                            if (!context.parsed || context.parsed.y === undefined) {
                                return 'rgba(74, 134, 232, 0.5)';
                            }
                            const value = context.parsed.y;
                            return value >= 0 ? 'rgba(74, 134, 232, 0.5)' : 'rgba(230, 124, 115, 0.5)';
                        },
                        borderColor: function(context) {
                            if (!context.parsed || context.parsed.y === undefined) {
                                return '#4A86E8';
                            }
                            const value = context.parsed.y;
                            return value >= 0 ? '#4A86E8' : '#E67C73';
                        },
                        borderWidth: 2,
                        tension: 0.4,
                        fill: currentChartType === 'line' ? false : true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'white',
                            titleColor: '#334155',
                            bodyColor: '#334155',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return filteredData[index].tooltipDate;
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const sign = value >= 0 ? '+' : '';
                                    const oku = (value / 100000000).toFixed(2);
                                    return `${sign}${oku}å„„å†† (${sign}${value.toLocaleString('ja-JP')}å††)`;
                                },
                                afterLabel: function(context) {
                                    const value = context.parsed.y;
                                    return value >= 0 ? 'è²·ã„è¶Šã—' : 'å£²ã‚Šè¶Šã—';
                                }
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                    speed: 0.1
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                                onZoomComplete: function({chart}) {
                                    // ã‚ºãƒ¼ãƒ å¾Œã«è¡¨ç¤ºç¯„å›²ã®ãƒ‡ãƒ¼ã‚¿ã§çµ±è¨ˆã‚’æ›´æ–°
                                    const xAxis = chart.scales.x;
                                    const startIndex = Math.max(0, Math.floor(xAxis.min));
                                    const endIndex = Math.min(filteredData.length - 1, Math.ceil(xAxis.max));
                                    const visibleData = filteredData.slice(startIndex, endIndex + 1);
                                    updateStats(visibleData);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return (value / 100000000).toFixed(0) + 'å„„å††';
                                }
                            },
                            grid: {
                                color: '#e2e8f0'
                            }
                        },
                        x: {
                            grid: {
                                color: '#e2e8f0'
                            }
                        }
                    }
                }
            };
            
            chart = new Chart(ctx, chartConfig);
            
            // åˆæœŸçµ±è¨ˆã‚’æ›´æ–°
            updateStats(filteredData);
        }

        // ã‚ºãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetZoom() {
            if (chart) {
                chart.resetZoom();
                const filteredData = getFilteredData();
                updateStats(filteredData);
            }
        }

        // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’åˆæœŸåŒ–
        function initControls() {
            // æœŸé–“é¸æŠãƒœã‚¿ãƒ³
            const timeRanges = [
                { value: 'all', label: 'å…¨æœŸé–“' },
                { value: '1y', label: '1å¹´' },
                { value: '6m', label: '6ãƒ¶æœˆ' },
                { value: '3m', label: '3ãƒ¶æœˆ' }
            ];
            
            document.getElementById('time-range-buttons').innerHTML = timeRanges.map(option => `
                <button 
                    onclick="setTimeRange('${option.value}')"
                    class="px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                        currentTimeRange === option.value
                            ? 'bg-blue-600 text-white'
                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                    }"
                >
                    ${option.label}
                </button>
            `).join('');
            
            // ãƒãƒ£ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—é¸æŠãƒœã‚¿ãƒ³
            const chartTypes = [
                { value: 'line', label: 'ãƒ©ã‚¤ãƒ³' },
                { value: 'bar', label: 'ãƒãƒ¼' }
            ];
            
            document.getElementById('chart-type-buttons').innerHTML = chartTypes.map(option => `
                <button 
                    onclick="setChartType('${option.value}')"
                    class="px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                        currentChartType === option.value
                            ? 'bg-blue-600 text-white'
                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                    }"
                >
                    ${option.label}
                </button>
            `).join('');
        }

        // æœŸé–“å¤‰æ›´
        function setTimeRange(range) {
            currentTimeRange = range;
            updateChart();
            initControls();
        }

        // ãƒãƒ£ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—å¤‰æ›´
        function setChartType(type) {
            currentChartType = type;
            updateChart();
            initControls();
        }

        // åˆæœŸãƒ­ãƒ¼ãƒ‰
        window.addEventListener('DOMContentLoaded', loadData);
        
        // 5åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>
