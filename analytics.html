<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>セクター別 海外資金感応度分析</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
    
    <!-- Utilities -->
    <script src="https://unpkg.com/lucide@0.294.0/dist/umd/lucide.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: 'Helvetica Neue', Arial, sans-serif; color: #334155; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Error Box */
        #global-error { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; background: #fee2e2; color: #b91c1c; padding: 16px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 90%; width: 400px; border: 1px solid #ef4444; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="global-error"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const el = document.getElementById('global-error');
            el.style.display = 'block';
            el.innerHTML = `<strong>システムエラー:</strong><br>${message}<br><small class="text-xs opacity-75">${source}:${lineno}</small>`;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine, ComposedChart, Area } = window.Recharts || {};

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Filter: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" /></svg>,
                BarChart2: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10" /><line x1="12" y1="20" x2="12" y2="4" /><line x1="6" y1="20" x2="6" y2="14" /></svg>,
                TrendingUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></svg>,
                Plus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                Trash2: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
                AlertCircle: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            };
            return <span className={className}>{icons[name] || null}</span>;
        };

        const App = () => {
            const [rawData, setRawData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            
            // 銘柄管理用 (localStorage)
            const [visibleTickers, setVisibleTickers] = useState([]);
            const [newTickerInput, setNewTickerInput] = useState('');
            const [addMessage, setAddMessage] = useState(null);

            useEffect(() => {
                if (!window.Recharts) {
                    setError("グラフライブラリの読み込みに失敗しました。ページを更新してください。");
                    setLoading(false);
                    return;
                }

                fetch(`./sector_data.json?t=${new Date().getTime()}`)
                    .then(res => {
                        if (!res.ok) throw new Error("データファイルが見つかりません。GitHub Actionsの完了をお待ちください。");
                        return res.json();
                    })
                    .then(json => {
                        if (!json.data || json.data.length === 0) throw new Error("データが空です。");
                        setRawData(json);
                        
                        // 日付設定
                        const dates = json.data.map(d => d.date).sort();
                        setEndDate(dates[dates.length - 1]);
                        const startIdx = Math.max(0, dates.length - 26); // デフォルト半年
                        setStartDate(dates[startIdx]);

                        // 表示銘柄の初期化 (Local Storage or All)
                        const saved = localStorage.getItem('analytics_visible_tickers');
                        if (saved) {
                            setVisibleTickers(JSON.parse(saved));
                        } else {
                            // デフォルトはJSONにある全銘柄
                            const allTickers = json.metadata.sectors.map(s => s.ticker);
                            setVisibleTickers(allTickers);
                        }
                        
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            // 表示銘柄の保存
            useEffect(() => {
                if (visibleTickers.length > 0) {
                    localStorage.setItem('analytics_visible_tickers', JSON.stringify(visibleTickers));
                }
            }, [visibleTickers]);

            // 銘柄追加ロジック
            const handleAddTicker = () => {
                if (!newTickerInput) return;
                const tickerToAdd = newTickerInput.trim().toUpperCase();
                
                // 1. 既に表示リストにあるか
                if (visibleTickers.includes(tickerToAdd)) {
                    setAddMessage({ type: 'info', text: '既に表示されています。' });
                    setNewTickerInput('');
                    return;
                }

                // 2. データソース(JSON)に存在するか確認
                const existsInSource = rawData.metadata.sectors.find(s => s.ticker === tickerToAdd);
                
                if (existsInSource) {
                    // データがあるので表示リストに追加
                    setVisibleTickers([...visibleTickers, tickerToAdd]);
                    setAddMessage({ type: 'success', text: 'リストに追加しました。' });
                } else {
                    // データがない場合 (Backend更新が必要)
                    setAddMessage({ 
                        type: 'error', 
                        text: `データ未取得: ${tickerToAdd} は sector_data.json に含まれていません。sectors.json を更新してActionsを実行してください。` 
                    });
                }
                setNewTickerInput('');
                setTimeout(() => setAddMessage(null), 5000);
            };

            const handleRemoveTicker = (ticker) => {
                const newList = visibleTickers.filter(t => t !== ticker);
                setVisibleTickers(newList);
            };

            const processedData = useMemo(() => {
                if (!rawData || !startDate || !endDate) return null;
                try {
                    const filtered = rawData.data.filter(d => d.date >= startDate && d.date <= endDate);
                    if (filtered.length === 0) return null;

                    // 表示対象の銘柄情報のみ抽出
                    const activeSectors = rawData.metadata.sectors.filter(s => visibleTickers.includes(s.ticker));

                    // 1. 感応度分析 (Mean Diff)
                    const flowPositive = filtered.filter(d => d.flow > 0);
                    const flowNegative = filtered.filter(d => d.flow <= 0);

                    const sensitivity = activeSectors.map(sec => {
                        const ticker = sec.ticker;
                        const meanPos = flowPositive.length ? flowPositive.reduce((acc, d) => acc + (d.returns[ticker] || 0), 0) / flowPositive.length : 0;
                        const meanNeg = flowNegative.length ? flowNegative.reduce((acc, d) => acc + (d.returns[ticker] || 0), 0) / flowNegative.length : 0;
                        return { 
                            name: sec.name, 
                            ticker: sec.ticker, 
                            category: sec.category, 
                            meanDiff: meanPos - meanNeg, 
                            meanPos, 
                            meanNeg 
                        };
                    }).sort((a, b) => b.meanDiff - a.meanDiff);

                    // 2. 累積資金流入
                    // JPXデータは「千円」単位。これを「億円」にするには / 100,000
                    let cumFlow = 0;
                    const timeSeries = filtered.map(d => {
                        cumFlow += d.flow;
                        return { 
                            date: d.date, 
                            flow: d.flow, 
                            cumFlow: cumFlow / 100000 // 修正: 100,000,000ではなく100,000で割る
                        };
                    });

                    return { sensitivity, timeSeries, activeSectors, totalFlow: cumFlow };
                } catch (e) {
                    console.error("Processing error:", e);
                    return null;
                }
            }, [rawData, startDate, endDate, visibleTickers]);

            if (loading) return <div className="min-h-screen flex items-center justify-center text-slate-500 animate-pulse">データを読み込んでいます...</div>;
            if (error) return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-50">
                    <div className="bg-white p-8 rounded-xl shadow-lg max-w-lg text-center border-t-4 border-red-500">
                        <h3 className="font-bold text-xl mb-2 text-slate-800">データ読み込みエラー</h3>
                        <p className="text-sm bg-red-50 text-red-600 p-3 rounded mb-4 font-mono">{error}</p>
                        <button onClick={() => window.location.reload()} className="mt-4 px-6 py-2 bg-slate-800 text-white rounded hover:bg-slate-700">再試行</button>
                    </div>
                </div>
            );
            if (!processedData) return <div className="min-h-screen flex items-center justify-center">指定された期間のデータがありません。</div>;

            return (
                <div className="min-h-screen bg-[#f8fafc] pb-20">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-[#7C4DFF] text-white p-2 rounded-lg"><Icon name="BarChart2" /></div>
                                <div><h1 className="font-bold text-slate-800 text-lg">セクター別 海外資金感応度分析</h1><p className="text-xs text-slate-500">Foreign Flow Sensitivity & Sector Performance</p></div>
                            </div>
                            <div className="text-xs text-slate-400 font-mono hidden md:block">最終更新: {rawData.metadata.generated_at}</div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8 space-y-6">
                        {/* コントロールパネル */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 flex flex-wrap gap-4 items-center justify-between animate-fade-in">
                            <div className="flex items-center gap-4 flex-wrap">
                                <div className="flex items-center gap-2 text-slate-600"><Icon name="Filter" size={16} /><span className="text-sm font-bold">分析期間:</span></div>
                                <div className="flex items-center gap-2">
                                    <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="border border-slate-300 rounded px-2 py-1 text-sm text-slate-600 focus:border-[#7C4DFF] outline-none" />
                                    <span className="text-slate-400">〜</span>
                                    <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="border border-slate-300 rounded px-2 py-1 text-sm text-slate-600 focus:border-[#7C4DFF] outline-none" />
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="text-xs text-slate-400">期間内 累積海外資金流入額</p>
                                <p className={`text-lg font-bold font-mono ${processedData.totalFlow >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]'}`}>
                                    {(processedData.totalFlow / 100000).toLocaleString(undefined, { maximumFractionDigits: 0 })} 億円
                                </p>
                            </div>
                        </div>

                        {/* グラフエリア */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {/* 感応度チャート */}
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in">
                                <h2 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><Icon name="BarChart2" className="text-[#7C4DFF]" />セクター感応度 (リターン乖離)</h2>
                                <p className="text-xs text-slate-500 mb-4">海外勢が「買い越した週」と「売り越した週」の平均リターンの差。プラスが大きいほど海外マネー流入時に上昇しやすい銘柄。</p>
                                <div className="h-[400px]">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart layout="vertical" data={processedData.sensitivity} margin={{ top: 5, right: 30, left: 40, bottom: 5 }}>
                                            <CartesianGrid strokeDasharray="3 3" />
                                            <XAxis type="number" fontSize={12} tickFormatter={(val) => `${val.toFixed(2)}%`} />
                                            <YAxis type="category" dataKey="name" width={120} fontSize={11} />
                                            <Tooltip formatter={(val) => `${val.toFixed(3)}%`} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0,0,0,0.1)' }} />
                                            <ReferenceLine x={0} stroke="#94a3b8" />
                                            <Bar dataKey="meanDiff" fill="#7C4DFF" radius={[0, 4, 4, 0]} name="感応度 (Mean Diff)" />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* 資金フローチャート */}
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in">
                                <h2 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2"><Icon name="TrendingUp" className="text-[#7C4DFF]" />期間内 累積資金流入</h2>
                                <p className="text-xs text-slate-500 mb-4">選択された期間における、海外投資家の累積買越額推移（開始日を0として計算）。</p>
                                <div className="h-[400px]">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <ComposedChart data={processedData.timeSeries}>
                                            <defs><linearGradient id="colorFlow" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#7C4DFF" stopOpacity={0.1}/><stop offset="95%" stopColor="#7C4DFF" stopOpacity={0}/></linearGradient></defs>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                            <XAxis dataKey="date" tickFormatter={(str) => { const d = new Date(str); return `${d.getMonth()+1}/${d.getDate()}`; }} fontSize={11} />
                                            <YAxis fontSize={11} tickFormatter={(val) => `${val.toLocaleString()}億`} width={45} />
                                            <Tooltip labelFormatter={(label) => new Date(label).toLocaleDateString()} formatter={(val, name) => [name === 'cumFlow' ? `${Math.round(val).toLocaleString()}億円` : val]} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0,0,0,0.1)' }} />
                                            <ReferenceLine y={0} stroke="#94a3b8" />
                                            <Area type="monotone" dataKey="cumFlow" stroke="#7C4DFF" strokeWidth={2} fillOpacity={1} fill="url(#colorFlow)" name="累積流入額" />
                                        </ComposedChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>

                        {/* 詳細統計 & 銘柄管理 */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* 左カラム: 銘柄管理 */}
                            <div className="lg:col-span-1 bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in h-fit">
                                <h2 className="text-lg font-bold text-slate-800 mb-4">表示銘柄の管理</h2>
                                <div className="mb-4">
                                    <div className="flex gap-2">
                                        <input 
                                            type="text" 
                                            placeholder="例: 1570.T" 
                                            value={newTickerInput}
                                            onChange={(e) => setNewTickerInput(e.target.value)}
                                            onKeyDown={(e) => e.key === 'Enter' && handleAddTicker()}
                                            className="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:border-[#7C4DFF] outline-none uppercase"
                                        />
                                        <button onClick={handleAddTicker} className="bg-[#7C4DFF] text-white p-2 rounded hover:bg-[#651FFF] transition"><Icon name="Plus" size={20} /></button>
                                    </div>
                                    {addMessage && (
                                        <div className={`mt-2 p-2 rounded text-xs flex items-start gap-2 ${addMessage.type === 'error' ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'}`}>
                                            <Icon name="AlertCircle" size={14} className="shrink-0 mt-0.5" />
                                            <span>{addMessage.text}</span>
                                        </div>
                                    )}
                                </div>
                                <div className="text-xs text-slate-500 mb-2">表示中の銘柄 (クリックで削除):</div>
                                <div className="flex flex-wrap gap-2">
                                    {visibleTickers.map(t => (
                                        <span key={t} className="bg-slate-100 text-slate-700 px-2 py-1 rounded text-xs flex items-center gap-1 group">
                                            {t}
                                            <button onClick={() => handleRemoveTicker(t)} className="text-slate-400 group-hover:text-red-500"><Icon name="Trash2" size={12} /></button>
                                        </span>
                                    ))}
                                </div>
                            </div>

                            {/* 右カラム: 詳細テーブル */}
                            <div className="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden animate-fade-in">
                                <div className="p-6 border-b border-slate-200"><h2 className="text-lg font-bold text-slate-800">詳細統計データ</h2></div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left text-slate-600">
                                        <thead className="bg-slate-50 text-xs uppercase font-bold text-slate-500">
                                            <tr>
                                                <th className="px-6 py-3">セクター / ETF</th>
                                                <th className="px-6 py-3 text-right text-[#7C4DFF]">感応度 (Diff)</th>
                                                <th className="px-6 py-3 text-right">平均リターン (買越時)</th>
                                                <th className="px-6 py-3 text-right">平均リターン (売越時)</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {processedData.sensitivity.map((row) => (
                                                <tr key={row.ticker} className="hover:bg-slate-50 transition-colors">
                                                    <td className="px-6 py-4 font-medium text-slate-800">{row.name} <span className="text-xs text-slate-400 ml-1">({row.ticker})</span></td>
                                                    <td className="px-6 py-4 text-right font-bold text-[#7C4DFF]">{row.meanDiff > 0 ? '+' : ''}{row.meanDiff.toFixed(3)}%</td>
                                                    <td className="px-6 py-4 text-right">{row.meanPos.toFixed(3)}%</td>
                                                    <td className="px-6 py-4 text-right">{row.meanNeg.toFixed(3)}%</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
