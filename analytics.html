<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>J-Equity Flow & Sector Performance Analyzer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Recharts -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide@0.294.0/dist/umd/lucide.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: 'Helvetica Neue', Arial, sans-serif; color: #334155; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine, ComposedChart, Line, Area } = Recharts;

        // --- Icons Component ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Filter: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" /></svg>,
                BarChart2: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10" /><line x1="12" y1="20" x2="12" y2="4" /><line x1="6" y1="20" x2="6" y2="14" /></svg>,
                TrendingUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></svg>,
                Calendar: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></svg>,
                RefreshCw: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            };
            return <span className={className}>{icons[name] || null}</span>;
        };

        const App = () => {
            const [rawData, setRawData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            // Filter States
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            
            // Load Data
            useEffect(() => {
                fetch('./sector_data.json')
                    .then(res => {
                        if (!res.ok) throw new Error("sector_data.json not found. Run python script first.");
                        return res.json();
                    })
                    .then(json => {
                        setRawData(json);
                        // Default Range: Last 6 months
                        if (json.data && json.data.length > 0) {
                            const dates = json.data.map(d => d.date).sort();
                            setEndDate(dates[dates.length - 1]);
                            // Approx 6 months ago
                            const startIdx = Math.max(0, dates.length - 26);
                            setStartDate(dates[startIdx]);
                        }
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            // Process Data based on Filter
            const processedData = useMemo(() => {
                if (!rawData || !startDate || !endDate) return null;

                const filtered = rawData.data.filter(d => d.date >= startDate && d.date <= endDate);
                const sectors = rawData.metadata.sectors;

                // 1. Mean Diff Calculation
                // Calculate average return when Foreign Flow > 0 vs <= 0
                const flowPositive = filtered.filter(d => d.flow > 0);
                const flowNegative = filtered.filter(d => d.flow <= 0);

                const sensitivity = sectors.map(sec => {
                    const ticker = sec.ticker;
                    
                    const meanPos = flowPositive.length ? flowPositive.reduce((acc, d) => acc + (d.returns[ticker] || 0), 0) / flowPositive.length : 0;
                    const meanNeg = flowNegative.length ? flowNegative.reduce((acc, d) => acc + (d.returns[ticker] || 0), 0) / flowNegative.length : 0;
                    
                    return {
                        name: sec.name,
                        ticker: sec.ticker,
                        category: sec.category,
                        meanDiff: meanPos - meanNeg, // Key Metric
                        meanPos,
                        meanNeg
                    };
                }).sort((a, b) => b.meanDiff - a.meanDiff);

                // 2. Cumulative Flow & Return (for Chart)
                // Normalize for visualization
                let cumFlow = 0;
                const timeSeries = filtered.map(d => {
                    cumFlow += d.flow;
                    return {
                        date: d.date,
                        flow: d.flow,
                        cumFlow: cumFlow / 100000000, // 億円単位
                        // Add specific sector returns if needed for correlation check
                    };
                });

                return { sensitivity, timeSeries, sectors, totalFlow: cumFlow };
            }, [rawData, startDate, endDate]);

            if (loading) return <div className="min-h-screen flex items-center justify-center text-slate-500">Loading analysis data...</div>;
            if (error) return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-red-50 text-red-600 p-6 rounded-lg shadow max-w-md text-center">
                        <h3 className="font-bold text-lg mb-2">Data Load Error</h3>
                        <p className="text-sm">{error}</p>
                        <p className="text-xs mt-4 text-slate-500">Please ensure <code>sector_manager.py</code> has been executed successfully.</p>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-[#f8fafc] pb-20">
                    {/* Header */}
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-30">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-[#7C4DFF] text-white p-2 rounded-lg">
                                    <Icon name="BarChart2" />
                                </div>
                                <div>
                                    <h1 className="font-bold text-slate-800 text-lg leading-tight">Sector Performance Analyzer</h1>
                                    <p className="text-xs text-slate-500">Foreign Flow Sensitivity & Trends</p>
                                </div>
                            </div>
                            <div className="text-xs text-slate-400 font-mono hidden md:block">
                                Generated: {rawData.metadata.generated_at}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8 space-y-6">
                        
                        {/* Controls */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 flex flex-wrap gap-4 items-center justify-between animate-fade-in">
                            <div className="flex items-center gap-4 flex-wrap">
                                <div className="flex items-center gap-2">
                                    <Icon name="Filter" className="text-slate-400" size={16} />
                                    <span className="text-sm font-bold text-slate-600">Analysis Period:</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <input 
                                        type="date" 
                                        value={startDate} 
                                        onChange={(e) => setStartDate(e.target.value)}
                                        className="border border-slate-300 rounded px-2 py-1 text-sm text-slate-600 focus:outline-none focus:border-[#7C4DFF]"
                                    />
                                    <span className="text-slate-400">to</span>
                                    <input 
                                        type="date" 
                                        value={endDate} 
                                        onChange={(e) => setEndDate(e.target.value)}
                                        className="border border-slate-300 rounded px-2 py-1 text-sm text-slate-600 focus:outline-none focus:border-[#7C4DFF]"
                                    />
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="text-right">
                                    <p className="text-xs text-slate-400">Cumulative Flow (Selected Period)</p>
                                    <p className={`text-lg font-bold font-mono ${processedData.totalFlow >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]'}`}>
                                        {(processedData.totalFlow / 100000000).toLocaleString(undefined, { maximumFractionDigits: 0 })} 億円
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* Top Section: Sensitivity & Flow */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            
                            {/* 1. Sensitivity Chart (Mean Diff) */}
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in">
                                <div className="mb-6">
                                    <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                        <Icon name="BarChart2" className="text-[#7C4DFF]" />
                                        Sector Sensitivity (Return Tilt)
                                    </h2>
                                    <p className="text-xs text-slate-500 mt-1">
                                        Difference in average weekly returns: (Weeks with Foreign Buying) - (Weeks with Foreign Selling).
                                        <br/>Positive values indicate sectors that outperform when foreigners are buying.
                                    </p>
                                </div>
                                <div className="h-[400px]">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart 
                                            layout="vertical" 
                                            data={processedData.sensitivity} 
                                            margin={{ top: 5, right: 30, left: 40, bottom: 5 }}
                                        >
                                            <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={true} stroke="#e2e8f0" />
                                            <XAxis type="number" stroke="#94a3b8" fontSize={12} tickFormatter={(val) => `${val.toFixed(2)}%`} />
                                            <YAxis type="category" dataKey="name" width={100} stroke="#64748b" fontSize={11} />
                                            <Tooltip 
                                                cursor={{fill: '#f8fafc'}}
                                                contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                                                formatter={(val) => `${val.toFixed(3)}%`}
                                            />
                                            <ReferenceLine x={0} stroke="#94a3b8" />
                                            <Bar dataKey="meanDiff" fill="#7C4DFF" radius={[0, 4, 4, 0]} name="Mean Diff">
                                                {/* Color logic could go here */}
                                            </Bar>
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* 2. Cumulative Flow Chart */}
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in">
                                <div className="mb-6">
                                    <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                        <Icon name="TrendingUp" className="text-[#7C4DFF]" />
                                        Cumulative Foreign Flow
                                    </h2>
                                    <p className="text-xs text-slate-500 mt-1">
                                        Accumulated net buying/selling by foreign investors over the selected period.
                                    </p>
                                </div>
                                <div className="h-[400px]">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <ComposedChart data={processedData.timeSeries} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                                            <defs>
                                                <linearGradient id="colorFlow" x1="0" y1="0" x2="0" y2="1">
                                                    <stop offset="5%" stopColor="#7C4DFF" stopOpacity={0.1}/>
                                                    <stop offset="95%" stopColor="#7C4DFF" stopOpacity={0}/>
                                                </linearGradient>
                                            </defs>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" vertical={false} />
                                            <XAxis 
                                                dataKey="date" 
                                                tickFormatter={(str) => {
                                                    const d = new Date(str);
                                                    return `${d.getMonth()+1}/${d.getDate()}`;
                                                }}
                                                fontSize={11}
                                                stroke="#94a3b8"
                                            />
                                            <YAxis 
                                                fontSize={11} 
                                                stroke="#94a3b8"
                                                tickFormatter={(val) => `${val.toLocaleString()}億`}
                                            />
                                            <Tooltip 
                                                labelFormatter={(label) => new Date(label).toLocaleDateString()}
                                                formatter={(val, name) => [
                                                    name === 'cumFlow' ? `${Math.round(val).toLocaleString()}億円` : val,
                                                    name === 'cumFlow' ? 'Cumulative Flow' : name
                                                ]}
                                                contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                                            />
                                            <ReferenceLine y={0} stroke="#94a3b8" />
                                            <Area type="monotone" dataKey="cumFlow" stroke="#7C4DFF" strokeWidth={2} fillOpacity={1} fill="url(#colorFlow)" />
                                        </ComposedChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>

                        {/* Detailed Stats Table */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden animate-fade-in">
                            <div className="p-6 border-b border-slate-200">
                                <h2 className="text-lg font-bold text-slate-800">Detailed Statistics by Sector</h2>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-600">
                                    <thead className="bg-slate-50 text-xs uppercase text-slate-500 font-bold">
                                        <tr>
                                            <th className="px-6 py-3">Sector / ETF</th>
                                            <th className="px-6 py-3">Category</th>
                                            <th className="px-6 py-3 text-right text-[#7C4DFF]">Mean Diff</th>
                                            <th className="px-6 py-3 text-right">Avg Return (Foreign Buy)</th>
                                            <th className="px-6 py-3 text-right">Avg Return (Foreign Sell)</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {processedData.sensitivity.map((row) => (
                                            <tr key={row.ticker} className="hover:bg-slate-50 transition-colors">
                                                <td className="px-6 py-4 font-medium text-slate-800">{row.name} <span className="text-xs text-slate-400 ml-1">({row.ticker})</span></td>
                                                <td className="px-6 py-4"><span className="px-2 py-1 bg-slate-100 rounded text-xs">{row.category}</span></td>
                                                <td className="px-6 py-4 text-right font-bold text-[#7C4DFF]">{row.meanDiff > 0 ? '+' : ''}{row.meanDiff.toFixed(3)}%</td>
                                                <td className="px-6 py-4 text-right">{row.meanPos.toFixed(3)}%</td>
                                                <td className="px-6 py-4 text-right">{row.meanNeg.toFixed(3)}%</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
