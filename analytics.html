<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>セクター別 海外資金感応度分析</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
    
    <!-- Screenshot Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Utilities -->
    <script src="https://unpkg.com/lucide@0.294.0/dist/umd/lucide.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: 'Helvetica Neue', Arial, sans-serif; color: #334155; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Error Box */
        #global-error { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; background: #fee2e2; color: #b91c1c; padding: 16px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 90%; width: 400px; border: 1px solid #ef4444; }
        /* Modal Overlay */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background: white; padding: 24px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* Hide ONLY Spin Buttons, Keep Calendar Icon */
        input[type="date"]::-webkit-inner-spin-button {
            display: none;
            -webkit-appearance: none;
        }
        input[type="date"] {
            position: relative;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="global-error"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const el = document.getElementById('global-error');
            el.style.display = 'block';
            el.innerHTML = `<strong>システムエラー:</strong><br>${message}<br><small class="text-xs opacity-75">${source}:${lineno}</small>`;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine, ComposedChart, Area, Cell } = window.Recharts || {};

        const BENCHMARKS = ['^N225', '1306.T', '^GSPC', '^NDX'];

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Filter: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" /></svg>,
                BarChart2: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10" /><line x1="12" y1="20" x2="12" y2="4" /><line x1="6" y1="20" x2="6" y2="14" /></svg>,
                TrendingUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></svg>,
                Plus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                Trash2: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
                Check: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
                ChevronLeft: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6" /></svg>,
                ChevronRight: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6" /></svg>,
                HelpCircle: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>,
                X: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
                Camera: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>,
                Copy: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            };
            return <span className={className}>{icons[name] || null}</span>;
        };

        const InfoModal = ({ onClose }) => {
            return (
                <div className="modal-overlay animate-fade-in" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <Icon name="HelpCircle" className="text-[#7C4DFF]" />
                                感応度 (Mean DIFF) とは？
                            </h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><Icon name="X" /></button>
                        </div>
                        <div className="text-sm text-slate-600 space-y-4">
                            <p>
                                <strong>意味合い:</strong><br/>
                                海外投資家が日本株を「買い越している週」と「売り越している週」で、そのセクターがどれだけパフォーマンス(株価変動率)に差が出るかを表します。値が大きいほど、海外マネーの流入出に敏感に反応するセクターと言えます。
                            </p>
                            <div className="bg-slate-50 p-3 rounded border border-slate-200">
                                <strong>計算式:</strong><br/>
                                <span className="font-mono text-xs block mt-1">
                                    Mean DIFF = (買越週の平均リターン) - (売越週の平均リターン)
                                </span>
                            </div>
                            <p>
                                <strong>データ取得元:</strong><br/>
                                <ul className="list-disc ml-5 space-y-1">
                                    <li><strong>資金フロー:</strong> 日本取引所グループ (JPX) 投資部門別売買状況</li>
                                    <li><strong>株価リターン:</strong> Yahoo Finance (各セクター/ETFの調整後終値)</li>
                                </ul>
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const ScreenshotButton = ({ targetId, className = "" }) => {
            const handleScreenshot = async () => {
                const element = document.getElementById(targetId);
                if (!element) return;
                
                try {
                    const canvas = await html2canvas(element, { 
                        backgroundColor: '#ffffff',
                        scale: 2
                    });
                    
                    canvas.toBlob(blob => {
                        if (!blob) {
                            alert("画像の生成に失敗しました。");
                            return;
                        }
                        const item = new ClipboardItem({ "image/png": blob });
                        navigator.clipboard.write([item])
                            .then(() => alert("画像をクリップボードにコピーしました!"))
                            .catch(err => {
                                console.error("Clipboard write failed:", err);
                                alert("クリップボードへのコピーに失敗しました。");
                            });
                    });
                } catch (err) {
                    console.error("Screenshot failed:", err);
                    alert("スクリーンショットの生成に失敗しました。");
                }
            };

            return (
                <button 
                    onClick={handleScreenshot} 
                    className={`p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors ${className}`}
                    title="クリップボードにコピー"
                >
                    <Icon name="Copy" size={18} />
                </button>
            );
        };

        const App = () => {
            const [rawData, setRawData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [showModal, setShowModal] = useState(false);
            
            const [activeTickers, setActiveTickers] = useState(new Set());

            useEffect(() => {
                if (!window.Recharts) {
                    setError("グラフライブラリの読み込みに失敗しました。ページを更新してください。");
                    setLoading(false);
                    return;
                }

                fetch(`./sector_data.json?t=${new Date().getTime()}`)
                    .then(res => {
                        if (!res.ok) {
                            if (res.status === 404) {
                                throw new Error("データファイル(sector_data.json)が未生成です。GitHub Actionsの完了をお待ちください。");
                            }
                            throw new Error(`データ読み込み失敗: ${res.status} ${res.statusText}`);
                        }
                        return res.json();
                    })
                    .then(json => {
                        if (!json.data || json.data.length === 0) {
                            setRawData(json);
                            setLoading(false);
                            return;
                        }
                        setRawData(json);
                        
                        const today = new Date();
                        const formatYMD = (d) => d.toISOString().split('T')[0];
                        
                        setEndDate(formatYMD(today));

                        const twoMonthsAgo = new Date(today);
                        twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
                        setStartDate(formatYMD(twoMonthsAgo));
                        
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            const allStats = useMemo(() => {
                if (!rawData || !rawData.data || !startDate || !endDate) return null;
                
                // 【修正】週の期間でフィルタリング
                const filtered = rawData.data.filter(d => {
                    if (!d.week_start || !d.week_end) return false;
                    // 週の開始日が分析終了日以前 かつ 週の終了日が分析開始日以降
                    return d.week_start <= endDate && d.week_end >= startDate;
                });
                
                if (filtered.length === 0) return [];

                const flowPositive = filtered.filter(d => d.flow > 0);
                const flowNegative = filtered.filter(d => d.flow <= 0);

                return rawData.metadata.sectors.map(sec => {
                    const ticker = sec.ticker;
                    const meanPos = flowPositive.length ? flowPositive.reduce((acc, d) => acc + (d.returns[ticker] || 0), 0) / flowPositive.length : 0;
                    const meanNeg = flowNegative.length ? flowNegative.reduce((acc, d) => acc + (d.returns[ticker] || 0), 0) / flowNegative.length : 0;
                    return {
                        ...sec,
                        meanDiff: meanPos - meanNeg,
                        meanPos,
                        meanNeg
                    };
                }).sort((a, b) => b.meanDiff - a.meanDiff);
            }, [rawData, startDate, endDate]);

            useEffect(() => {
                if (allStats && allStats.length > 0 && activeTickers.size === 0) {
                    const initialSet = new Set();
                    allStats.forEach(item => initialSet.add(item.ticker));
                    setActiveTickers(initialSet);
                }
            }, [allStats]);

            const processedData = useMemo(() => {
                if (!allStats || !rawData || !startDate || !endDate) return null;

                const chartData = allStats.filter(s => activeTickers.has(s.ticker));

                // 【修正】週の期間でフィルタリング
                const filtered = rawData.data.filter(d => {
                    if (!d.week_start || !d.week_end) return false;
                    return d.week_start <= endDate && d.week_end >= startDate;
                });
                
                filtered.sort((a, b) => a.date.localeCompare(b.date));
                
                let cumFlow = 0;
                
                const timeSeries = filtered.map(d => {
                    cumFlow += d.flow;
                    
                    // dateフォーマット: "2024-06-01" → 年=2024, 月=6, 週=01
                    const parts = d.date.split('-');
                    const month = parseInt(parts[1]);
                    const weekNumber = parseInt(parts[2]);
                    
                    const weekLabel = `${month}月${weekNumber}週目`;

                    return { 
                        date: d.date, 
                        weekLabel: weekLabel, 
                        flow: d.flow / 100000, 
                        cumFlow: cumFlow / 100000 
                    }; 
                });

                return { chartData, timeSeries, totalFlow: cumFlow, allStats };
            }, [allStats, activeTickers, rawData, startDate, endDate]);

            const getBarColor = (ticker, value) => {
                if (ticker && BENCHMARKS.includes(ticker)) return '#475569';
                return value > 0 ? '#A78BFA' : '#F472B6';
            };

            const toggleTicker = (ticker) => {
                const newSet = new Set(activeTickers);
                if (newSet.has(ticker)) newSet.delete(ticker);
                else newSet.add(ticker);
                setActiveTickers(newSet);
            };

            const shiftDate = (type, months) => {
                const currentVal = type === 'start' ? startDate : endDate;
                if (!currentVal) return;
                const d = new Date(currentVal);
                d.setMonth(d.getMonth() + months);
                const newStr = d.toISOString().split('T')[0];
                if (type === 'start') setStartDate(newStr);
                else setEndDate(newStr);
                setActiveTickers(new Set());
            };

            const handleDateClick = (e) => {
                try {
                    e.target.showPicker();
                } catch (err) {
                    // ignore
                }
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center text-slate-500 animate-pulse">データを読み込んでいます...</div>;
            if (error) return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-50">
                    <div className="bg-white p-8 rounded-xl shadow-lg max-w-lg text-center border-t-4 border-red-500">
                        <h3 className="font-bold text-xl mb-2 text-slate-800">データ読み込みエラー</h3>
                        <p className="text-sm bg-red-50 text-red-600 p-3 rounded mb-4 font-mono">{error}</p>
                        <button onClick={() => window.location.reload()} className="mt-4 px-6 py-2 bg-slate-800 text-white rounded hover:bg-slate-700">再試行</button>
                    </div>
                </div>
            );

            const hasData = processedData && processedData.chartData.length > 0;
            const totalFlowDisplay = processedData ? processedData.totalFlow : 0;
            const generatedAt = rawData && rawData.metadata ? rawData.metadata.generated_at : "";

            return (
                <div className="min-h-screen bg-[#f8fafc] pb-20">
                    {showModal && <InfoModal onClose={() => setShowModal(false)} />}
                    
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-[#7C4DFF] text-white p-2 rounded-lg"><Icon name="BarChart2" /></div>
                                <div><h1 className="font-bold text-slate-800 text-lg">セクター別 海外資金感応度分析</h1><p className="text-xs text-slate-500">Foreign Flow Sensitivity & Sector Performance</p></div>
                            </div>
                            <div className="text-xs text-slate-400 font-mono hidden md:block">最終更新: {generatedAt}</div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8 space-y-6">
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 flex flex-wrap gap-4 items-center justify-between animate-fade-in">
                            <div className="flex items-center gap-4 flex-wrap">
                                <div className="flex items-center gap-2 text-slate-600"><Icon name="Filter" size={16} /><span className="text-sm font-bold">分析期間:</span></div>
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center">
                                        <button onClick={() => shiftDate('start', -1)} className="p-1 hover:bg-slate-100 rounded text-slate-500"><Icon name="ChevronLeft" size={16} /></button>
                                        <input 
                                            type="date" 
                                            value={startDate} 
                                            onChange={(e) => { setStartDate(e.target.value); setActiveTickers(new Set()); }} 
                                            onClick={handleDateClick}
                                            className="border border-slate-300 rounded px-2 py-1 text-sm text-slate-600 focus:border-[#7C4DFF] outline-none mx-1 bg-transparent text-center w-32 cursor-pointer hover:bg-slate-50" 
                                        />
                                        <button onClick={() => shiftDate('start', 1)} className="p-1 hover:bg-slate-100 rounded text-slate-500"><Icon name="ChevronRight" size={16} /></button>
                                    </div>
                                    <span className="text-slate-400">〜</span>
                                    <div className="flex items-center">
                                        <button onClick={() => shiftDate('end', -1)} className="p-1 hover:bg-slate-100 rounded text-slate-500"><Icon name="ChevronLeft" size={16} /></button>
                                        <input 
                                            type="date" 
                                            value={endDate} 
                                            onChange={(e) => { setEndDate(e.target.value); setActiveTickers(new Set()); }} 
                                            onClick={handleDateClick}
                                            className="border border-slate-300 rounded px-2 py-1 text-sm text-slate-600 focus:border-[#7C4DFF] outline-none mx-1 bg-transparent text-center w-32 cursor-pointer hover:bg-slate-50" 
                                        />
                                        <button onClick={() => shiftDate('end', 1)} className="p-1 hover:bg-slate-100 rounded text-slate-500"><Icon name="ChevronRight" size={16} /></button>
                                    </div>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="text-xs text-slate-400">期間内 累積海外資金流入額</p>
                                <p className={`text-lg font-bold font-mono ${totalFlowDisplay >= 0 ? 'text-[#7C4DFF]' : 'text-[#FF4081]'}`}>
                                    {(totalFlowDisplay / 100000).toLocaleString(undefined, { maximumFractionDigits: 0 })} 億円
                                </p>
                            </div>
                        </div>

                        {!hasData ? (
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-12 text-center text-slate-500">
                                <p className="mb-2 font-bold text-lg">指定された期間のデータがありません。</p>
                                <p className="text-sm">日付を変更して再度お試しください。</p>
                            </div>
                        ) : (
                            <>
                            <div id="chart-container" className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 animate-fade-in relative">
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                            <Icon name="BarChart2" className="text-[#7C4DFF]" />
                                            分析レポート
                                        </h2>
                                        <p className="text-xs text-slate-500">市場動向とセクター反応の相関分析</p>
                                    </div>
                                    <ScreenshotButton targetId="chart-container" className="bg-slate-50 border border-slate-200" />
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div id="chart-sensitivity" className="relative p-2 rounded hover:bg-slate-50/50 transition-colors">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="text-sm font-bold text-slate-700 flex items-center gap-2">
                                                セクター感応度 (リターン乖離)
                                                <button onClick={() => setShowModal(true)} className="text-slate-400 hover:text-[#7C4DFF]" title="詳細"><Icon name="HelpCircle" size={16} /></button>
                                            </h3>
                                            <ScreenshotButton targetId="chart-sensitivity" />
                                        </div>
                                        <div className="h-[500px]">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart layout="vertical" data={processedData.chartData} margin={{ top: 5, right: 30, left: 40, bottom: 5 }}>
                                                    <CartesianGrid strokeDasharray="3 3" />
                                                    <XAxis type="number" fontSize={12} tickFormatter={(val) => `${val.toFixed(2)}%`} />
                                                    <YAxis type="category" dataKey="name" width={120} fontSize={11} interval={0} />
                                                    <Tooltip formatter={(val) => `${val.toFixed(3)}%`} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0,0,0,0.1)' }} />
                                                    <ReferenceLine x={0} stroke="#94a3b8" />
                                                    <Bar dataKey="meanDiff" radius={[0, 4, 4, 0]} name="感応度 (Mean Diff)" barSize={20}>
                                                        {processedData.chartData.map((entry, index) => (
                                                            <Cell key={`cell-${index}`} fill={getBarColor(entry.ticker, entry.meanDiff)} />
                                                        ))}
                                                    </Bar>
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>

                                    <div id="chart-flow" className="relative p-2 rounded hover:bg-slate-50/50 transition-colors">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="text-sm font-bold text-slate-700 flex items-center gap-2">
                                                <Icon name="TrendingUp" size={16} /> 期間内 資金流出入推移
                                            </h3>
                                            <ScreenshotButton targetId="chart-flow" />
                                        </div>
                                        <div className="h-[500px]">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart data={processedData.timeSeries} margin={{ top: 5, right: 30, left: 5, bottom: 60 }}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                    <XAxis 
                                                        dataKey="weekLabel" 
                                                        fontSize={11} 
                                                        interval={0}
                                                        angle={-45}
                                                        textAnchor="end"
                                                        height={80}
                                                    />
                                                    <YAxis fontSize={11} tickFormatter={(val) => `${val.toLocaleString()}億`} width={45} />
                                                    <Tooltip 
                                                        cursor={{fill: 'transparent'}}
                                                        labelFormatter={(label, payload) => {
                                                            if(payload && payload[0]) {
                                                                const dateStr = payload[0].payload.date;
                                                                const parts = dateStr.split('-');
                                                                const year = parts[0];
                                                                const month = parseInt(parts[1]);
                                                                const week = parseInt(parts[2]);
                                                                return `${year}年${month}月第${week}週 (${label})`; 
                                                            }
                                                            return label;
                                                        }} 
                                                        formatter={(val) => `${Math.round(val).toLocaleString()}億円`} 
                                                        contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0,0,0,0.1)' }} 
                                                    />
                                                    <ReferenceLine y={0} stroke="#94a3b8" />
                                                    <Bar dataKey="flow" name="純流出入額" radius={[2, 2, 0, 0]} barSize={20}>
                                                        {processedData.timeSeries.map((entry, index) => (
                                                            <Cell key={`cell-${index}`} fill={entry.flow > 0 ? '#A78BFA' : '#F472B6'} />
                                                        ))}
                                                    </Bar>
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden animate-fade-in">
                                <div className="p-6 border-b border-slate-200 flex items-center gap-2">
                                    <h2 className="text-lg font-bold text-slate-800">詳細統計データ一覧</h2>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left text-slate-600">
                                        <thead className="bg-slate-50 text-xs uppercase font-bold text-slate-500">
                                            <tr>
                                                <th className="px-4 py-3 text-center w-16">操作</th>
                                                <th className="px-6 py-3">セクター / ETF</th>
                                                <th className="px-6 py-3 text-right text-[#7C4DFF]">感応度 (Diff)</th>
                                                <th className="px-6 py-3 text-right">平均リターン (買越時)</th>
                                                <th className="px-6 py-3 text-right">平均リターン (売越時)</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {processedData.allStats.map((row) => {
                                                const isActive = activeTickers.has(row.ticker);
                                                return (
                                                    <tr key={row.ticker} className={`transition-colors ${isActive ? 'bg-purple-50/50' : 'hover:bg-slate-50'}`}>
                                                        <td className="px-4 py-4 text-center">
                                                            <button 
                                                                onClick={() => toggleTicker(row.ticker)}
                                                                className={`p-1.5 rounded-full transition-colors border ${
                                                                    isActive 
                                                                        ? 'bg-slate-200 border-slate-200 text-slate-500 hover:bg-red-100 hover:text-red-500 hover:border-red-200' 
                                                                        : 'bg-white border-[#7C4DFF] text-[#7C4DFF] hover:bg-[#7C4DFF] hover:text-white'
                                                                }`}
                                                                title={isActive ? "グラフから削除" : "グラフに追加"}
                                                            >
                                                                {isActive ? <Icon name="Trash2" size={14} /> : <Icon name="Plus" size={14} />}
                                                            </button>
                                                        </td>
                                                        <td className="px-6 py-4 font-medium text-slate-800">
                                                            {row.name} 
                                                            <span className="text-xs text-slate-400 ml-1">({row.ticker})</span>
                                                        </td>
                                                        <td className="px-6 py-4 text-right font-bold text-[#7C4DFF]">{row.meanDiff > 0 ? '+' : ''}{row.meanDiff.toFixed(3)}%</td>
                                                        <td className="px-6 py-4 text-right">{row.meanPos.toFixed(3)}%</td>
                                                        <td className="px-6 py-4 text-right">{row.meanNeg.toFixed(3)}%</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            </>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
